<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapeGeeks - AI Image Prompt Generator v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1F2937 0%, #374151 50%, #1F2937 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: rgba(197, 213, 46, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(197, 213, 46, 0.3);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #C5D52E, #9FAA1E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #C5D52E;
            font-size: 1.2em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .version-badge {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 16px;
            background: linear-gradient(135deg, #C5D52E, #1F2937);
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: #fff;
        }

        .quick-presets {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .preset-btn {
            padding: 8px 16px;
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(197, 213, 46, 0.4);
            border-radius: 20px;
            color: #C5D52E;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .preset-btn:hover {
            background: rgba(197, 213, 46, 0.2);
            transform: translateY(-2px);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .controls {
            background: rgba(30, 20, 15, 0.95);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(197, 213, 46, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .output-area {
            background: rgba(30, 20, 15, 0.95);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(197, 213, 46, 0.2);
            min-height: 600px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            color: #C5D52E;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(197, 213, 46, 0.3);
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .helper-text {
            font-size: 0.75em;
            color: #9ca3af;
            margin-top: 5px;
            font-style: italic;
        }

        select, input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(197, 213, 46, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.95em;
            transition: all 0.3s;
            margin-top: 8px;
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #C5D52E;
            background: rgba(0, 0, 0, 0.5);
        }

        select option {
            background: #1F2937;
            color: #e0e0e0;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            background: rgba(197, 213, 46, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 0.85em;
            flex: 1;
        }

        .quick-fill-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-fill-btn {
            padding: 6px 12px;
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(197, 213, 46, 0.4);
            border-radius: 6px;
            color: #C5D52E;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75em;
        }

        .quick-fill-btn:hover {
            background: rgba(197, 213, 46, 0.2);
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #C5D52E, #9FAA1E);
            border: none;
            border-radius: 10px;
            color: #1F2937;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(197, 213, 46, 0.4);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 10px;
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(197, 213, 46, 0.3);
            border-radius: 8px;
            color: #C5D52E;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .action-btn:hover {
            background: rgba(197, 213, 46, 0.2);
            border-color: #C5D52E;
        }

        .output-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(31, 41, 55, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(197, 213, 46, 0.2);
        }

        .output-title {
            color: #C5D52E;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            padding: 8px 16px;
            background: #C5D52E;
            border: none;
            border-radius: 6px;
            color: #1F2937;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #9FAA1E;
            transform: scale(1.05);
        }

        .output-content {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(197, 213, 46, 0.1);
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Captions Grid Layout */
        .captions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
        }

        .captions-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .captions-header-title {
            font-size: 18px;
            font-weight: 700;
            color: #C5D52E;
        }

        .captions-header-buttons {
            display: flex;
            gap: 10px;
        }

        .captions-action-btn {
            padding: 8px 16px;
            background: rgba(197, 213, 46, 0.2);
            border: 1px solid #C5D52E;
            border-radius: 6px;
            color: #C5D52E;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .captions-action-btn:hover {
            background: rgba(197, 213, 46, 0.3);
            transform: translateY(-1px);
        }

        .captions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .caption-card {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #C5D52E;
            display: flex;
            flex-direction: column;
        }

        .caption-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #C5D52E;
            color: #1F2937;
            font-weight: 700;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 4px;
        }

        .caption-text {
            margin-top: 5px;
            margin-bottom: 12px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            flex-grow: 1;
        }

        .caption-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(197, 213, 46, 0.2);
        }

        .caption-char-count {
            font-size: 11px;
            color: rgba(197, 213, 46, 0.7);
            font-weight: 600;
        }

        .caption-copy-btn {
            padding: 6px 12px;
            background: rgba(197, 213, 46, 0.15);
            border: 1px solid rgba(197, 213, 46, 0.4);
            border-radius: 4px;
            color: #C5D52E;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .caption-copy-btn:hover {
            background: rgba(197, 213, 46, 0.25);
            border-color: #C5D52E;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #C5D52E;
            color: #1F2937;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .controls {
                position: relative;
                top: 0;
                max-height: none;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(197, 213, 46, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(197, 213, 46, 0.8);
        }
        /* ============================================================================ */
        /* V1.2 NEW STYLES: Two-Stage Image Workflow */
        /* ============================================================================ */

        .image-dropzone {
            border: 2px dashed rgba(197, 213, 46, 0.4);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .image-dropzone:hover,
        .image-dropzone.dragover {
            border-color: #C5D52E;
            background: rgba(197, 213, 46, 0.1);
            transform: scale(1.02);
        }

        .image-dropzone-icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #C5D52E;
        }

        .image-dropzone-text {
            color: #C5D52E;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .image-dropzone-subtext {
            color: #9ca3af;
            font-size: 0.8em;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .image-preview-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(197, 213, 46, 0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .image-preview-box h4 {
            color: #C5D52E;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .uploaded-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(197, 213, 46, 0.3);
        }

        .analysis-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #C5D52E;
        }

        .analysis-label {
            color: #C5D52E;
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .analysis-value {
            color: #e0e0e0;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .color-palette {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            border: 2px solid rgba(197, 213, 46, 0.3);
            cursor: pointer;
            position: relative;
        }

        .color-swatch:hover::after {
            content: attr(data-hex);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #C5D52E;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            white-space: nowrap;
            z-index: 100;
        }

        .prompt-variations {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .variation-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(197, 213, 46, 0.2);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .variation-card:hover {
            border-color: #C5D52E;
            box-shadow: 0 4px 15px rgba(197, 213, 46, 0.2);
        }

        .variation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(197, 213, 46, 0.2);
        }

        .variation-title {
            color: #C5D52E;
            font-weight: 600;
            font-size: 1em;
        }

        .variation-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 6px 12px;
            font-size: 0.85em;
            background: rgba(31, 41, 55, 0.4);
            border: 1px solid rgba(197, 213, 46, 0.3);
            border-radius: 6px;
            color: #C5D52E;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: rgba(31, 41, 55, 0.6);
            border-color: #C5D52E;
        }

        .btn-clear {
            width: 100%;
            background: rgba(100, 100, 100, 0.3);
            color: #aaa;
            border: 1px solid rgba(150, 150, 150, 0.3);
            font-size: 0.9em;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-clear:hover {
            background: rgba(150, 150, 150, 0.4);
            color: #fff;
            border-color: rgba(200, 200, 200, 0.5);
        }

        .prompt-text {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.8;
            color: #e0e0e0;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(197, 213, 46, 0.2);
        }

        .workflow-guide {
            background: rgba(30, 120, 180, 0.15);
            border: 1px solid rgba(100, 180, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85em;
            line-height: 1.6;
        }

        .workflow-guide strong {
            color: #C5D52E;
            display: block;
            margin-bottom: 8px;
        }

        .workflow-guide ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .workflow-guide li {
            padding: 4px 0;
            color: #9ca3af;
        }

        .workflow-guide li::before {
            content: "‚Üí ";
            color: #C5D52E;
            font-weight: bold;
        }

        .analyzing-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(197, 213, 46, 0.3);
            border-radius: 50%;
            border-top-color: #C5D52E;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Stage 1 indicator badge */
        .using-image-badge {
            display: inline-block;
            background: linear-gradient(135deg, #C5D52E, #9FAA1E);
            color: #1a1a1a;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(197, 213, 46, 0.4);
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 3px 10px rgba(197, 213, 46, 0.4); }
            50% { box-shadow: 0 5px 20px rgba(197, 213, 46, 0.6); }
        }

        /* Banner animations */
        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(120%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Stage Dividers */
        .stage-divider {
            background: linear-gradient(135deg, rgba(197, 213, 46, 0.2), rgba(159, 170, 30, 0.2));
            border: 2px solid rgba(197, 213, 46, 0.4);
            border-radius: 12px;
            padding: 15px 20px;
            margin: 25px 0 20px 0;
            text-align: center;
        }

        .stage-divider-title {
            color: #C5D52E;
            font-size: 1.3em;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stage-divider-subtitle {
            color: #9ca3af;
            font-size: 0.85em;
            font-style: italic;
        }

        /* ============================================================================ */
        /* V2.0 NEW STYLES: API Settings, Image Generation, Gallery */
        /* ============================================================================ */

        /* API Settings Button */
        .api-settings-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(197, 213, 46, 0.5);
            border-radius: 25px;
            color: #C5D52E;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .api-settings-btn:hover {
            background: rgba(197, 213, 46, 0.2);
            border-color: #C5D52E;
            transform: translateY(-2px);
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            border: 2px solid rgba(197, 213, 46, 0.4);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(197, 213, 46, 0.3);
        }

        .modal-title {
            color: #C5D52E;
            font-size: 1.5em;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 2em;
            cursor: pointer;
            transition: color 0.3s;
            line-height: 1;
        }

        .modal-close:hover {
            color: #C5D52E;
        }

        .api-provider-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(197, 213, 46, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .api-provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .api-provider-name {
            color: #C5D52E;
            font-weight: 600;
            font-size: 1.1em;
        }

        .api-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .api-status.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .api-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .api-key-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(197, 213, 46, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #C5D52E;
        }

        .api-save-btn {
            width: 100%;
            margin-top: 20px;
            padding: 14px;
            background: linear-gradient(135deg, #C5D52E, #9FAA1E);
            border: none;
            border-radius: 10px;
            color: #1F2937;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .api-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(197, 213, 46, 0.4);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner-large {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(197, 213, 46, 0.2);
            border-radius: 50%;
            border-top-color: #C5D52E;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }

        .loading-text {
            color: #C5D52E;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #9ca3af;
            font-size: 0.95em;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(197, 213, 46, 0.2);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #C5D52E, #9FAA1E);
            border-radius: 3px;
            width: 0%;
            animation: progressPulse 2s ease-in-out infinite;
        }

        @keyframes progressPulse {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* Generate Image Button */
        .generate-image-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .generate-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .generate-image-btn:disabled {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Image Gallery Section */
        .gallery-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(197, 213, 46, 0.3);
            border-radius: 15px;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(197, 213, 46, 0.2);
        }

        .gallery-title {
            color: #C5D52E;
            font-size: 1.3em;
            font-weight: 700;
        }

        .gallery-actions {
            display: flex;
            gap: 10px;
        }

        .gallery-action-btn {
            padding: 8px 16px;
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(197, 213, 46, 0.4);
            border-radius: 8px;
            color: #C5D52E;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gallery-action-btn:hover {
            background: rgba(197, 213, 46, 0.2);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .gallery-item {
            position: relative;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(197, 213, 46, 0.2);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gallery-item:hover {
            border-color: #C5D52E;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(197, 213, 46, 0.3);
        }

        .gallery-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .gallery-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            padding: 15px 10px 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }

        .gallery-item-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .gallery-item-btn {
            padding: 6px 12px;
            background: rgba(197, 213, 46, 0.2);
            border: 1px solid #C5D52E;
            border-radius: 6px;
            color: #C5D52E;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gallery-item-btn:hover {
            background: rgba(197, 213, 46, 0.4);
        }

        .gallery-item-timestamp {
            text-align: center;
            color: #9ca3af;
            font-size: 0.7em;
            margin-top: 8px;
        }

        /* Generated Image Display */
        .generated-image-display {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(197, 213, 46, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .generated-image-display img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 10px;
            border: 2px solid rgba(197, 213, 46, 0.4);
        }

        .generated-image-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .image-action-btn {
            padding: 10px 20px;
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(197, 213, 46, 0.4);
            border-radius: 8px;
            color: #C5D52E;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-action-btn:hover {
            background: rgba(197, 213, 46, 0.2);
            border-color: #C5D52E;
        }

        .image-action-btn.primary {
            background: linear-gradient(135deg, #C5D52E, #9FAA1E);
            color: #1F2937;
            border: none;
        }

        .image-action-btn.primary:hover {
            box-shadow: 0 4px 15px rgba(197, 213, 46, 0.4);
        }

        /* V2.0: Generated Image Area - Static Display */
        .generated-image-area {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(31, 41, 55, 0.6));
            border: 2px solid rgba(197, 213, 46, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .generated-image-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(197, 213, 46, 0.2);
        }

        .image-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .image-status.ready { background: rgba(107, 114, 128, 0.3); color: #9ca3af; }
        .image-status.generating { background: rgba(251, 191, 36, 0.3); color: #fbbf24; animation: pulse 1.5s infinite; }
        .image-status.success { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
        .image-status.error { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .image-status.demo { background: rgba(139, 92, 246, 0.3); color: #8b5cf6; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .generated-image-container {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .image-placeholder {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .image-placeholder p {
            margin: 10px 0 0;
        }

        #generatedImageDisplay {
            max-width: 100%;
            max-height: 600px;
            border-radius: 8px;
            object-fit: contain;
        }

        .image-metadata {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(197, 213, 46, 0.2);
        }

        .metadata-item {
            text-align: center;
        }

        .metadata-label {
            display: block;
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .metadata-value {
            color: #C5D52E;
            font-weight: 600;
        }

        /* Image Gallery Grid */
        .image-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .gallery-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(197, 213, 46, 0.3);
            border-color: rgba(197, 213, 46, 0.5);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }

        .gallery-item-time {
            font-size: 0.7em;
            color: #9ca3af;
        }

        /* Empty Gallery State */
        .gallery-empty {
            text-align: center;
            padding: 50px 20px;
            color: #6b7280;
        }

        .gallery-empty-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .gallery-empty-text {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .gallery-empty-subtext {
            font-size: 0.9em;
            color: #9ca3af;
        }

        /* Image Metadata */
        .image-metadata {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(197, 213, 46, 0.1);
        }

        .metadata-item:last-child {
            border-bottom: none;
        }

        .metadata-label {
            color: #9ca3af;
            font-size: 0.85em;
        }

        .metadata-value {
            color: #C5D52E;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Lightbox for viewing images */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10002;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .lightbox-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 10px;
            border: 2px solid rgba(197, 213, 46, 0.4);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: #C5D52E;
            font-size: 2.5em;
            cursor: pointer;
        }

        .lightbox-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* ============================================================================ */
        /* E-COMMERCE PLATFORM STYLES - Amazon & Shopify Optimization */
        /* ============================================================================ */

        .ecommerce-platform-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(197, 213, 46, 0.3);
        }

        .platform-tab {
            flex: 1;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: #9ca3af;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .platform-tab:not(:last-child) {
            border-right: 1px solid rgba(197, 213, 46, 0.2);
        }

        .platform-tab:hover {
            background: rgba(197, 213, 46, 0.1);
            color: #C5D52E;
        }

        .platform-tab.active {
            background: rgba(197, 213, 46, 0.2);
            color: #C5D52E;
        }

        .platform-tab.amazon.active {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.2), rgba(35, 47, 62, 0.3));
            border-bottom: 2px solid #FF9900;
        }

        .platform-tab.shopify.active {
            background: linear-gradient(135deg, rgba(150, 191, 72, 0.2), rgba(35, 47, 62, 0.3));
            border-bottom: 2px solid #96BF48;
        }

        .platform-tab.social.active {
            background: linear-gradient(135deg, rgba(197, 213, 46, 0.2), rgba(35, 47, 62, 0.3));
            border-bottom: 2px solid #C5D52E;
        }

        .ecommerce-image-type {
            margin-top: 10px;
        }

        .image-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .image-type-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(197, 213, 46, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-type-option:hover {
            background: rgba(197, 213, 46, 0.1);
            border-color: rgba(197, 213, 46, 0.4);
        }

        .image-type-option.selected {
            background: rgba(197, 213, 46, 0.15);
            border-color: #C5D52E;
        }

        .image-type-option input[type="radio"] {
            display: none;
        }

        .image-type-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .image-type-label {
            font-size: 0.75em;
            color: #e0e0e0;
            text-align: center;
            font-weight: 500;
        }

        .image-type-dims {
            font-size: 0.65em;
            color: #9ca3af;
            margin-top: 2px;
        }

        /* White Background Mode Toggle */
        .white-bg-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 153, 0, 0.1);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 8px;
            margin-top: 10px;
        }

        .white-bg-toggle.active {
            background: rgba(255, 153, 0, 0.2);
            border-color: #FF9900;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #FF9900;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .toggle-label {
            flex: 1;
        }

        .toggle-label-main {
            font-size: 0.85em;
            color: #e0e0e0;
            font-weight: 600;
        }

        .toggle-label-sub {
            font-size: 0.7em;
            color: #FF9900;
            margin-top: 2px;
        }

        /* Amazon Compliance Badge */
        .amazon-compliance-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #FF9900, #232F3E);
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            color: #fff;
            margin-left: 8px;
        }

        /* Shopify Badge */
        .shopify-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #96BF48, #5E8E3E);
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
            color: #fff;
            margin-left: 8px;
        }

        /* Format info tooltip */
        .format-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(197, 213, 46, 0.1);
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.8em;
        }

        .format-info-icon {
            font-size: 1.2em;
        }

        .format-info-text {
            color: #C5D52E;
        }

        /* Platform-specific format groups in dropdown */
        .format-optgroup {
            background: rgba(31, 41, 55, 0.9);
            color: #C5D52E;
            font-weight: 600;
            padding: 8px 12px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üéØ TapeGeeks - AI Image Prompt Generator</h1>
        <p class="subtitle">Platform-Optimized Prompts for All Your Product Imagery</p>
        <span class="version-badge">v2.0 - Direct Image Generation + Multi-Provider API Support</span>
        <p style="margin-top: 8px; color: #C5D52E; font-size: 0.85em; opacity: 0.8;">Designed by Greg Kowalczyk</p>
        
        <button class="api-settings-btn" onclick="openApiSettings()">‚öôÔ∏è API Settings</button>

        <div class="quick-presets">
            <button class="preset-btn" onclick="loadPreset('instagramProduct')">üì∏ Instagram Product Shot</button>
            <button class="preset-btn" onclick="loadPreset('crossfitAction')">üí™ CrossFit Action</button>
            <button class="preset-btn" onclick="loadPreset('clinicalApp')">üè• Clinical Application</button>
            <button class="preset-btn" onclick="loadPreset('salePromo')">üí∞ Sale Promo</button>
            <button class="preset-btn" onclick="loadPreset('kidsSleep')">üò¥ Kids Sleep</button>
        </div>
    </header>

    <div class="main-layout">
        <!-- CONTROLS SECTION -->
        <div class="controls">

            <!-- ============================================================ -->
            <!-- STAGE 1: QUICK IMAGE VARIATIONS -->
            <!-- ============================================================ -->
            <div class="stage-divider">
                <div class="stage-divider-title">‚ö° STAGE 1: Quick Image Variations</div>
                <div class="stage-divider-subtitle">Upload image ‚Üí Get 4 instant prompt variations ‚Üí Copy or Use (30 seconds)</div>
            </div>

            <!-- IMAGE ANALYSIS SECTION (v1.2 - TWO-STAGE WORKFLOW) -->
            <div class="section" id="image-analysis-section">
                <div class="section-title">
                    üì∏ AI Prompt from Image
                    <span class="tooltip" data-tooltip="Upload or paste a product image to generate AI prompts that match its style">‚ÑπÔ∏è</span>
                </div>

                <div class="image-dropzone" id="imageDropzone">
                    <div class="image-dropzone-icon">üì∏</div>
                    <div class="image-dropzone-text">Drop image here or click to upload</div>
                    <div class="image-dropzone-subtext">Ctrl+V (Cmd+V) to paste ‚Ä¢ JPG, PNG, WebP</div>
                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                </div>

                <div id="imageAnalysisResults" class="hidden">
                    <div class="image-preview-container">
                        <div class="image-preview-box">
                            <h4>üì∑ Uploaded Image</h4>
                            <img id="uploadedImagePreview" class="uploaded-image" alt="Uploaded image">
                            <button class="btn-clear" onclick="clearImageAnalysis()" style="margin-top: 10px;">Clear Image</button>
                        </div>

                        <div class="image-preview-box">
                            <h4>üé® Extracted Analysis</h4>
                            <div id="imageAnalysisContent"></div>
                        </div>
                    </div>

                    <div class="prompt-variations">
                        <h4 style="color: #C5D52E; margin-bottom: 15px;">ü§ñ Generated Prompt Variations</h4>

                        <div class="variation-card">
                            <div class="variation-header">
                                <span class="variation-title">üéØ Exact Match</span>
                                <div class="variation-actions">
                                    <button class="btn-icon" onclick="copyPromptVariation(0)">üìã Copy</button>
                                    <button class="btn-icon" onclick="sendToGenerator(0)">‚û°Ô∏è Use</button>
                                </div>
                            </div>
                            <div class="prompt-text" id="variation-0"></div>
                        </div>

                        <div class="variation-card">
                            <div class="variation-header">
                                <span class="variation-title">‚ú® Inspired</span>
                                <div class="variation-actions">
                                    <button class="btn-icon" onclick="copyPromptVariation(1)">üìã Copy</button>
                                    <button class="btn-icon" onclick="sendToGenerator(1)">‚û°Ô∏è Use</button>
                                </div>
                            </div>
                            <div class="prompt-text" id="variation-1"></div>
                        </div>

                        <div class="variation-card">
                            <div class="variation-header">
                                <span class="variation-title">üíé Premium</span>
                                <div class="variation-actions">
                                    <button class="btn-icon" onclick="copyPromptVariation(2)">üìã Copy</button>
                                    <button class="btn-icon" onclick="sendToGenerator(2)">‚û°Ô∏è Use</button>
                                </div>
                            </div>
                            <div class="prompt-text" id="variation-2"></div>
                        </div>

                        <div class="variation-card">
                            <div class="variation-header">
                                <span class="variation-title">üèÉ TapeGeeks Branded</span>
                                <div class="variation-actions">
                                    <button class="btn-icon" onclick="copyPromptVariation(3)">üìã Copy</button>
                                    <button class="btn-icon" onclick="sendToGenerator(3)">‚û°Ô∏è Use</button>
                                </div>
                            </div>
                            <div class="prompt-text" id="variation-3"></div>
                        </div>
                    </div>

                    <div class="workflow-guide">
                        <strong>üí° Workflow Tips:</strong>
                        <ul>
                            <li>Upload your kinesiology tape product image to get instant prompt variations</li>
                            <li>Click "Use" to send any variation directly to the AI image generator</li>
                            <li>Tweak the generated prompts by editing platform/discipline settings below</li>
                            <li>Try different images to explore various styles for your tape photography</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- STAGE 2: FULL CUSTOMIZATION -->
            <!-- ============================================================ -->
            <div class="stage-divider">
                <div class="stage-divider-title">‚öôÔ∏è STAGE 2: Full Customization</div>
                <div class="stage-divider-subtitle">Customize all settings below ‚Üí Generate complete content (prompt + 10 captions + hashtags)</div>
            </div>

            <!-- Section 1: AI Platform -->
            <div class="section">
                <div class="section-title">1. AI Platform</div>
                <select id="aiPlatform">
                    <option value="pollinations">üöÄ Pollinations AI - FREE & Works in Browser! ‚≠ê</option>
                    <option value="huggingface">ü§ó Hugging Face FLUX - FREE (via proxy)</option>
                    <option value="chatgpt">ChatGPT / DALL-E 3 üí∞ (Best Quality)</option>
                    <option value="gemini">Gemini (Nano Banana) - Requires Server</option>
                    <option value="perplexity">Perplexity AI üí∞</option>
                    <option value="midjourney">Midjourney üí∞üí∞</option>
                    <option value="sora2">Sora 2 (Video) üí∞üí∞üí∞</option>
                    <option value="grok">Grok (xAI) üí∞üí∞</option>
                    <option value="krea">Krea (Realtime) üí∞</option>
                    <option value="sora">Sora Original üí∞üí∞üí∞</option>
                </select>
                <div class="helper-text">üöÄ Pollinations AI works instantly - no API key needed! Other platforms require keys.</div>
            </div>

            <!-- Section 2: Content Category -->
            <div class="section">
                <div class="section-title">2. Content Category</div>
                <select id="contentCategory">
                    <option value="product">Product Photography</option>
                    <option value="lifestyle">Lifestyle & Action</option>
                    <option value="educational">Educational & Instructional</option>
                    <option value="clinical">Clinical Application</option>
                    <option value="seasonal">Seasonal & Promotional</option>
                    <option value="social">Social Media Content</option>
                    <option value="beforeafter">Before/After Comparison</option>
                    <option value="testimonial">Testimonial & Social Proof</option>
                    <option value="custom">Custom Content Type</option>
                </select>
                <input type="text" id="customContentType" placeholder="Describe custom content type..." style="display:none; margin-top:8px;">
            </div>

            <!-- Section 3: E-Commerce Platform & Format -->
            <div class="section">
                <div class="section-title">3. E-Commerce Platform & Format</div>
                
                <!-- Platform Tabs -->
                <div class="ecommerce-platform-tabs">
                    <button type="button" class="platform-tab amazon" onclick="selectPlatform('amazon')" data-platform="amazon">
                        üì¶ Amazon
                    </button>
                    <button type="button" class="platform-tab shopify active" onclick="selectPlatform('shopify')" data-platform="shopify">
                        üõí Shopify
                    </button>
                    <button type="button" class="platform-tab social" onclick="selectPlatform('social')" data-platform="social">
                        üì± Social
                    </button>
                </div>

                <!-- Platform Format Dropdown -->
                <select id="platformFormat">
                    <!-- Amazon Formats -->
                    <optgroup label="üì¶ AMAZON LISTING IMAGES" id="amazonFormats">
                        <option value="amazon-main">üèÜ Amazon Main Image (1:1 - 2000x2000) - WHITE BG REQUIRED</option>
                        <option value="amazon-lifestyle">üèÉ Amazon Lifestyle (1:1 - 2000x2000)</option>
                        <option value="amazon-infographic">üìä Amazon Infographic (1:1 - 2000x2000)</option>
                        <option value="amazon-feature">‚ú® Amazon Feature Callout (1:1 - 2000x2000)</option>
                        <option value="amazon-comparison">‚öñÔ∏è Amazon Size/Comparison (1:1 - 2000x2000)</option>
                        <option value="amazon-packaging">üì¶ Amazon Package Contents (1:1 - 2000x2000)</option>
                        <option value="amazon-aplus-banner">üñºÔ∏è A+ Content Banner (970x600)</option>
                        <option value="amazon-aplus-square">‚¨ú A+ Content Square (300x300)</option>
                        <option value="amazon-storefront">üè™ Amazon Storefront Hero (3000x600)</option>
                    </optgroup>
                    
                    <!-- Shopify Formats -->
                    <optgroup label="üõí SHOPIFY STORE IMAGES" id="shopifyFormats">
                        <option value="shopify-product" selected>üõçÔ∏è Shopify Product (1:1 - 2048x2048)</option>
                        <option value="shopify-collection">üìÅ Collection Banner (16:9 - 1800x1000)</option>
                        <option value="shopify-homepage">üè† Homepage Hero (21:9 - 2880x1200)</option>
                        <option value="shopify-featured">‚≠ê Featured Image (4:3 - 1200x900)</option>
                        <option value="shopify-announcement">üì¢ Announcement Bar (10:1 - 1200x120)</option>
                        <option value="shopify-slideshow">üé† Slideshow (16:9 - 1920x1080)</option>
                        <option value="shopify-blog">üìù Blog Featured (16:9 - 1200x675)</option>
                    </optgroup>
                    
                    <!-- Social Media Formats -->
                    <optgroup label="üì± SOCIAL MEDIA" id="socialFormats">
                        <option value="instagram-square">Instagram Square (1:1 - 1080x1080)</option>
                        <option value="instagram-portrait">Instagram Portrait (4:5 - 1080x1350)</option>
                        <option value="instagram-story">Instagram Story (9:16 - 1080x1920)</option>
                        <option value="facebook">Facebook Post (16:9 - 1200x630)</option>
                        <option value="pinterest">Pinterest (2:3 - 1000x1500)</option>
                        <option value="tiktok">TikTok/Reels (9:16 - 1080x1920)</option>
                        <option value="linkedin">LinkedIn Post (1.91:1 - 1200x627)</option>
                        <option value="twitter">Twitter/X Post (16:9 - 1200x675)</option>
                        <option value="youtube">YouTube Thumbnail (16:9 - 1280x720)</option>
                    </optgroup>
                    
                    <!-- General/Custom -->
                    <optgroup label="‚öôÔ∏è GENERAL">
                        <option value="website-hero">Website Hero (21:9 - 2560x1080)</option>
                        <option value="product-page">Generic Product (1:1 - 2000x2000)</option>
                        <option value="email">Email Header (3:1 - 600x200)</option>
                        <option value="custom-format">Custom Dimensions</option>
                    </optgroup>
                </select>
                <input type="text" id="customDimensions" placeholder="e.g., 1200 x 800 pixels (3:2)" style="display:none; margin-top:8px;">

                <!-- Amazon White Background Toggle (shown when Amazon format selected) -->
                <div class="white-bg-toggle" id="whiteBgToggle" style="display: none;">
                    <div class="toggle-switch" id="whiteBgSwitch" onclick="toggleWhiteBackground()"></div>
                    <div class="toggle-label">
                        <div class="toggle-label-main">üéØ Pure White Background Mode</div>
                        <div class="toggle-label-sub">Required for Amazon Main Images (#FFFFFF, 85% product fill)</div>
                    </div>
                </div>

                <!-- E-commerce Image Type Selector (for Amazon/Shopify) -->
                <div class="ecommerce-image-type" id="ecommerceImageType" style="display: none;">
                    <div class="helper-text" style="margin-bottom: 8px;">Select image purpose:</div>
                    <div class="image-type-grid" id="imageTypeGrid">
                        <!-- Populated by JavaScript based on platform -->
                    </div>
                </div>

                <!-- Format Info Display -->
                <div class="format-info" id="formatInfo">
                    <span class="format-info-icon">üìê</span>
                    <span class="format-info-text" id="formatInfoText">Shopify Product: 2048x2048px, 1:1 ratio - High-res product imagery</span>
                </div>
            </div>

            <!-- Section 4: Discipline/Category -->
            <div class="section">
                <div class="section-title">4. Discipline / Category</div>
                <select id="disciplineCategory">
                    <option value="">-- Select Category --</option>
                    <option value="healthcare">üè• Healthcare Professionals</option>
                    <option value="running">üèÉ Athletes - Running</option>
                    <option value="strength">üí™ Athletes - Strength & Power</option>
                    <option value="team-sports">‚öΩ Athletes - Team Sports</option>
                    <option value="endurance">üö¥ Athletes - Endurance Sports</option>
                    <option value="other-sports">üéæ Athletes - Other Sports</option>
                    <option value="sleep">üò¥ Sleep & Breathing (Breathe Plus)</option>
                    <option value="fitness">üèãÔ∏è Fitness & Recreation</option>
                    <option value="recovery">ü©π Injury Recovery & Rehabilitation</option>
                    <option value="custom-discipline">üéØ Custom Discipline</option>
                </select>
                <select id="disciplineSubCategory" style="margin-top:8px; display:none;">
                    <!-- Sub-options populated dynamically -->
                </select>
                <input type="text" id="customDiscipline" placeholder="Describe custom discipline..." style="display:none; margin-top:8px;">
            </div>

            <!-- Section 5: Medical Injury (Optional) -->
            <div class="section">
                <div class="section-title">5. Medical Injury (Optional)</div>
                <select id="injuryCategory">
                    <option value="">-- No Specific Injury --</option>
                    <option value="knee">Knee</option>
                    <option value="ankle">Ankle</option>
                    <option value="shoulder">Shoulder</option>
                    <option value="back">Back</option>
                    <option value="elbow-wrist">Elbow/Wrist</option>
                    <option value="leg-thigh">Leg/Thigh</option>
                    <option value="foot-toe">Foot/Toe</option>
                    <option value="neck-head">Neck/Head</option>
                    <option value="general">General/Other</option>
                </select>
                <select id="specificInjury" style="margin-top:8px; display:none;">
                    <!-- Injury sub-options populated dynamically -->
                </select>
                <input type="text" id="customInjury" placeholder="Describe custom injury..." style="display:none; margin-top:8px;">
            </div>

            <!-- Section 6: Styles -->
            <div class="section">
                <div class="section-title">6. Visual Styles</div>
                <div class="helper-text">Select all that apply:</div>
                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-studio" value="professional-studio">
                        <label for="style-studio">Professional Studio</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-natural" value="natural-lighting">
                        <label for="style-natural">Natural Lighting</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-action" value="action-motion">
                        <label for="style-action">Action/Motion</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-macro" value="close-up-macro">
                        <label for="style-macro">Close-up/Macro</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-lifestyle" value="lifestyle-candid">
                        <label for="style-lifestyle">Lifestyle/Candid</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-clinical" value="clinical-medical">
                        <label for="style-clinical">Clinical/Medical</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-minimal" value="minimalist-clean">
                        <label for="style-minimal">Minimalist/Clean</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="style-dynamic" value="dynamic-energetic">
                        <label for="style-dynamic">Dynamic/Energetic</label>
                    </div>
                </div>
            </div>

            <!-- Section 7: Image Elements -->
            <div class="section">
                <div class="section-title">7. Image Elements</div>
                <div class="helper-text">What to include:</div>
                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-male" value="male-athlete">
                        <label for="elem-male">Male Athlete</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-female" value="female-athlete">
                        <label for="elem-female">Female Athlete</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-professional" value="healthcare-professional">
                        <label for="elem-professional">Healthcare Pro</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-tape" value="kinesiology-tape">
                        <label for="elem-tape">Kinesiology Tape</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-strips" value="nasal-strips">
                        <label for="elem-strips">Nasal Strips</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-package" value="packaging-visible">
                        <label for="elem-package">Packaging Visible</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-applying" value="applying-tape">
                        <label for="elem-applying">Applying Tape</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="elem-exercise" value="mid-exercise">
                        <label for="elem-exercise">Mid-Exercise</label>
                    </div>
                </div>
            </div>

            <!-- Section 8: Custom Text in Image -->
            <div class="section">
                <div class="section-title">8. Custom Text in Image</div>
                <div class="quick-fill-buttons">
                    <button class="quick-fill-btn" onclick="fillText('NEW')">NEW</button>
                    <button class="quick-fill-btn" onclick="fillText('50% OFF')">50% OFF</button>
                    <button class="quick-fill-btn" onclick="fillText('PROFESSIONAL GRADE')">PRO GRADE</button>
                    <button class="quick-fill-btn" onclick="fillText('LIMITED TIME')">LIMITED TIME</button>
                    <button class="quick-fill-btn" onclick="fillText('SALE')">SALE</button>
                    <button class="quick-fill-btn" onclick="fillText('TRUSTED BY PROS')">TRUSTED</button>
                </div>
                <input type="text" id="customText" placeholder="Enter custom text (3-5 words, ALL CAPS)" maxlength="50">
                <div class="helper-text">Text accuracy best with ChatGPT & Midjourney</div>
            </div>

            <!-- Section 9: Caption Style -->
            <div class="section">
                <div class="section-title">9. Caption Style</div>
                <select id="captionStyle">
                    <option value="educational">Educational/How-To</option>
                    <option value="motivational">Motivational/Inspirational</option>
                    <option value="problem-solution">Problem/Solution</option>
                    <option value="social-proof">Social Proof/Testimonial</option>
                    <option value="promotional">Promotional/Sale</option>
                    <option value="features">Product Features</option>
                    <option value="behind-scenes">Behind-the-Scenes</option>
                    <option value="ugc">User-Generated Content Style</option>
                    <option value="clinical">Professional/Clinical</option>
                    <option value="lifestyle">Lifestyle/Aspirational</option>
                </select>
            </div>

            <!-- Section 10: Product Details -->
            <div class="section">
                <div class="section-title">10. Product Details</div>
                <select id="specificProduct">
                    <option value="kt-standard">Kinesiology Tape - Standard Roll</option>
                    <option value="kt-bulk">Kinesiology Tape - Bulk Roll</option>
                    <option value="kt-precut">Kinesiology Tape - Pre-Cut Strips</option>
                    <option value="kt-sensitive">Kinesiology Tape - Sensitive Skin</option>
                    <option value="kt-pro">Kinesiology Tape - Pro Series</option>
                    <option value="ns-adult-std">Nasal Strips - Adult Standard</option>
                    <option value="ns-adult-lg">Nasal Strips - Adult Large</option>
                    <option value="ns-kids-sm">Nasal Strips - Kids Small (2-5)</option>
                    <option value="ns-kids-md">Nasal Strips - Kids Medium (6-12)</option>
                    <option value="scissors-pro">Kinesiology Scissors - Professional</option>
                    <option value="scissors-medical">Medical Scissors - Trauma Shears</option>
                    <option value="wl-tape">Weightlifting Tape - Thumb Protection</option>
                    <option value="adhesive">Adhesive Tape - 1.5" Athletic</option>
                    <option value="cohesive">Cohesive Tape - 2" Self-Adhesive</option>
                    <option value="kit">Product Bundle/Kit</option>
                </select>
                <select id="productColor" style="margin-top:8px;">
                    <option value="black">Black</option>
                    <option value="royal-blue">Royal Blue</option>
                    <option value="pink">Hot Pink</option>
                    <option value="beige">Beige/Tan</option>
                    <option value="purple">Purple</option>
                    <option value="green">Green</option>
                    <option value="red">Red</option>
                    <option value="orange">Orange</option>
                    <option value="multi">Multi-Color Pack</option>
                    <option value="na">N/A (Not Applicable)</option>
                    <option value="custom-color">Custom Color</option>
                </select>
                <input type="text" id="customColor" placeholder="Describe custom color..." style="display:none; margin-top:8px;">
            </div>

            <!-- Section 11: Special Notes -->
            <div class="section">
                <div class="section-title">11. Special Notes</div>
                <textarea id="specialNotes" rows="4" placeholder="Add any special requirements, brand guidelines, or specific details...&#10;&#10;Examples:&#10;- Must show TapeGeeks logo clearly&#10;- Include specific body position&#10;- Match existing campaign aesthetic"></textarea>
            </div>

            <!-- Generate Button -->
            <button class="generate-btn" onclick="generateContent()">‚ú® Generate Complete Content</button>

            <!-- Quick Generate Prompt Only Button -->
            <button class="generate-btn" onclick="generatePromptOnly()" style="background: linear-gradient(135deg, #1F2937, #374151); color: #C5D52E; margin-top: 10px; font-size: 0.95em;">‚ö° Generate AI Prompt Only (Fast)</button>

            <!-- V2.0: Generate Image Button -->
            <button class="generate-image-btn" id="generateImageBtn" onclick="generateImage()">
                <span>üñºÔ∏è</span>
                <span>Generate Image with AI</span>
            </button>
            <div class="helper-text" style="text-align: center; margin-top: 5px;">Uses the selected AI platform - configure API keys in Settings</div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn" onclick="copyPromptToClipboard()">üìã Copy Prompt</button>
                <button class="action-btn" onclick="downloadAsFile()">üíæ Download</button>
                <button class="action-btn" onclick="saveFavorite()">‚≠ê Save Favorite</button>
                <button class="action-btn" onclick="clearAll()">üîÑ Clear All</button>
            </div>
        </div>

        <!-- OUTPUT SECTION -->
        <div class="output-area" id="outputArea">
            <!-- V2.0: Generated Image Display Area (Always Visible) -->
            <div id="generatedImageArea" class="generated-image-area" style="display: none;">
                <div class="generated-image-header">
                    <h3 style="color: #C5D52E; margin: 0;">üñºÔ∏è Generated Image</h3>
                    <div class="image-status" id="imageStatus">Ready</div>
                </div>
                <div class="generated-image-container" id="imageContainer">
                    <div class="image-placeholder" id="imagePlaceholder">
                        <div style="font-size: 48px;">üé®</div>
                        <p>Your AI-generated image will appear here</p>
                        <p style="font-size: 0.8em; color: #6b7280;">Click "Generate Image with AI" to create an image</p>
                        <button onclick="runDemoMode()" style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #4a5568, #2d3748); border: 1px solid #C5D52E; border-radius: 8px; color: #C5D52E; cursor: pointer; font-size: 13px; transition: all 0.3s ease;">üß™ Test Display (Demo Mode)</button>
                    </div>
                    <img id="generatedImageDisplay" src="" alt="Generated Image" style="display: none;">
                </div>
                <div class="generated-image-actions" id="imageActions" style="display: none;">
                    <button class="image-action-btn primary" onclick="downloadCurrentImage()">üíæ Download Image</button>
                    <button class="image-action-btn" onclick="regenerateImage()">üîÑ Regenerate</button>
                    <button class="image-action-btn" onclick="copyImageUrl()">üîó Copy URL</button>
                    <button class="image-action-btn" onclick="openImageInNewTab()">üîç View Full Size</button>
                </div>
                <div class="image-metadata" id="imageMetadata" style="display: none;">
                    <div class="metadata-item">
                        <span class="metadata-label">Provider</span>
                        <span class="metadata-value" id="metaProvider">-</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Model</span>
                        <span class="metadata-value" id="metaModel">-</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Generated</span>
                        <span class="metadata-value" id="metaTime">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Image History Gallery -->
            <div id="imageGalleryArea" class="gallery-section" style="display: none;">
                <div class="gallery-header">
                    <span class="gallery-title">üìö Recent Images</span>
                    <button class="gallery-action-btn" onclick="clearGallery()">üóëÔ∏è Clear History</button>
                </div>
                <div id="imageGallery" class="image-gallery-grid"></div>
            </div>
            
            <!-- Prompt Output Area -->
            <div id="promptOutputArea" style="text-align:center; padding:100px 20px; color:#6b7280;">
                <h2 style="color:#C5D52E; margin-bottom:15px;">üëà Select your options and click Generate</h2>
                <p>Your AI-optimized prompt, captions, and specifications will appear here</p>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- V2.0: API Settings Modal -->
<!-- ============================================================================ -->
<div class="modal-overlay" id="apiSettingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">API Settings</h2>
            <button class="modal-close" onclick="closeApiSettings()">&times;</button>
        </div>

        <div class="api-provider-section">
            <div class="api-provider-header">
                <span class="api-provider-name">Nano Banana Pro (Gemini)</span>
                <span class="api-status disconnected" id="nanoBananaStatus">Not Connected</span>
            </div>
            <input type="password" class="api-key-input" id="nanoBananaApiKey" placeholder="Enter your Nano Banana Pro API key...">
            <p style="color: #9ca3af; font-size: 0.8em; margin-top: 8px;">Endpoint: api.defapi.org | Model: google/gempix2</p>
        </div>

        <div class="api-provider-section">
            <div class="api-provider-header">
                <span class="api-provider-name">OpenAI (ChatGPT / DALL-E)</span>
                <span class="api-status disconnected" id="openaiStatus">Not Connected</span>
            </div>
            <input type="password" class="api-key-input" id="openaiApiKey" placeholder="Enter your OpenAI API key (sk-...)...">
            <p style="color: #9ca3af; font-size: 0.8em; margin-top: 8px;">Supports DALL-E 3 image generation</p>
        </div>

        <div class="api-provider-section">
            <div class="api-provider-header">
                <span class="api-provider-name">Grok (xAI)</span>
                <span class="api-status disconnected" id="grokStatus">Not Connected</span>
            </div>
            <input type="password" class="api-key-input" id="grokApiKey" placeholder="Enter your Grok API key...">
            <p style="color: #9ca3af; font-size: 0.8em; margin-top: 8px;">xAI image generation (when available)</p>
        </div>

        <div class="api-provider-section">
            <div class="api-provider-header">
                <span class="api-provider-name">Perplexity AI</span>
                <span class="api-status disconnected" id="perplexityStatus">Not Connected</span>
            </div>
            <input type="password" class="api-key-input" id="perplexityApiKey" placeholder="Enter your Perplexity API key...">
            <p style="color: #9ca3af; font-size: 0.8em; margin-top: 8px;">Perplexity image generation</p>
        </div>

        <div class="api-provider-section" style="border-color: rgba(34, 197, 94, 0.5);">
            <div class="api-provider-header">
                <span class="api-provider-name">ü§ó Hugging Face (FREE - Recommended)</span>
                <span class="api-status connected" id="huggingfaceStatus" style="background: rgba(34, 197, 94, 0.3); color: #22c55e;">Works Without Key!</span>
            </div>
            <input type="password" class="api-key-input" id="huggingfaceApiKey" placeholder="Optional: Enter HF token for higher rate limits (hf_...)">
            <p style="color: #22c55e; font-size: 0.8em; margin-top: 8px;">‚ú® FREE to use! Uses FLUX.1-schnell model. Add token for faster generation & higher limits.</p>
            <p style="color: #9ca3af; font-size: 0.75em; margin-top: 5px;">Get free token at: <a href="https://huggingface.co/settings/tokens" target="_blank" style="color: #C5D52E;">huggingface.co/settings/tokens</a></p>
        </div>

        <button class="api-save-btn" onclick="saveApiSettings()">Save API Settings</button>
        
        <p style="text-align: center; color: #6b7280; font-size: 0.8em; margin-top: 15px;">
            API keys are stored locally in your browser and never sent to external servers except the respective API providers.
        </p>
    </div>
</div>

<!-- ============================================================================ -->
<!-- V2.0: Loading Overlay -->
<!-- ============================================================================ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner-large"></div>
    <div class="loading-text" id="loadingText">Generating Image...</div>
    <div class="loading-subtext" id="loadingSubtext">This may take 10-30 seconds</div>
    <div class="loading-progress">
        <div class="loading-progress-bar"></div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- V2.0: Lightbox for viewing images -->
<!-- ============================================================================ -->
<div class="lightbox-overlay" id="lightboxOverlay" onclick="closeLightbox(event)">
    <div class="lightbox-content">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <img id="lightboxImage" src="" alt="Generated Image">
        <div class="lightbox-actions">
            <button class="image-action-btn primary" onclick="downloadCurrentImage()">Download Image</button>
            <button class="image-action-btn" onclick="copyImageToClipboard()">Copy to Clipboard</button>
        </div>
    </div>
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<script>
// ============================================================================
// V1.2 GLOBAL STATE: Two-Stage Image Workflow
// ============================================================================
let currentImageData = null;
let currentAnalysis = null;
let generatedVariations = [];

// ============================================================================
// V2.0 E-COMMERCE PLATFORM STATE & FUNCTIONS
// ============================================================================
let currentEcommercePlatform = 'shopify'; // amazon, shopify, social
let whiteBackgroundMode = false;
let currentImageType = 'product'; // main, lifestyle, infographic, etc.

// E-commerce Format Specifications - Complete Database
const ecommerceFormats = {
    // Amazon Formats
    'amazon-main': { 
        name: 'Amazon Main Image', 
        dims: '2000x2000px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: true,
        description: 'Primary listing image - MUST have pure white (#FFFFFF) background, product fills 85% of frame, no text/logos',
        promptInjection: 'CRITICAL AMAZON REQUIREMENT: Pure white background (#FFFFFF RGB 255,255,255). Product must fill approximately 85% of frame. NO text, NO logos, NO watermarks. Studio lighting, clean product isolation. Professional e-commerce photography standard.'
    },
    'amazon-lifestyle': { 
        name: 'Amazon Lifestyle', 
        dims: '2000x2000px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Product in real-world use context',
        promptInjection: 'Amazon lifestyle image showing product being actively used in authentic real-world scenario. Natural lighting, realistic environment. Show product benefits through action.'
    },
    'amazon-infographic': { 
        name: 'Amazon Infographic', 
        dims: '2000x2000px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Feature callouts and text overlays',
        promptInjection: 'Amazon infographic style with clean layout. Leave clear zones for text overlay and feature callout arrows. Professional product photography with space for annotations. Clean background (white or light gradient recommended).'
    },
    'amazon-feature': { 
        name: 'Amazon Feature Callout', 
        dims: '2000x2000px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Highlight key product features',
        promptInjection: 'Close-up detail shot highlighting product features. Macro photography style showing material quality, construction details, unique selling points. Clean background for adding feature callout text.'
    },
    'amazon-comparison': { 
        name: 'Amazon Size/Comparison', 
        dims: '2000x2000px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Scale reference and size comparison',
        promptInjection: 'Product shown with common scale reference objects (coin, hand, ruler, everyday item). Clear size demonstration. Clean white or light background. Product and reference clearly visible.'
    },
    'amazon-packaging': { 
        name: 'Amazon Package Contents', 
        dims: '2000x2000px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Flat lay showing all included items',
        promptInjection: 'Professional flat lay showing all package contents neatly arranged. Bird\'s eye view, white or light background. All items clearly visible and labeled. Clean, organized layout.'
    },
    'amazon-aplus-banner': { 
        name: 'A+ Content Banner', 
        dims: '970x600px', 
        ratio: '97:60',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Amazon A+ Content hero banner',
        promptInjection: 'Wide banner format for Amazon A+ Content. Cinematic composition, lifestyle or product hero image. Space for text overlay on left or right third. High impact visual.'
    },
    'amazon-aplus-square': { 
        name: 'A+ Content Square', 
        dims: '300x300px', 
        ratio: '1:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'A+ Content comparison module square',
        promptInjection: 'Small square format for A+ comparison modules. Clean, simple product shot or icon. High contrast for visibility at small size.'
    },
    'amazon-storefront': { 
        name: 'Amazon Storefront Hero', 
        dims: '3000x600px', 
        ratio: '5:1',
        platform: 'amazon',
        requiresWhiteBg: false,
        description: 'Brand storefront header banner',
        promptInjection: 'Ultra-wide storefront banner. Brand showcase with product lineup. Space for logo on left. Lifestyle or product collage style. Brand colors prominent.'
    },
    
    // Shopify Formats
    'shopify-product': { 
        name: 'Shopify Product', 
        dims: '2048x2048px', 
        ratio: '1:1',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'High-resolution product page image',
        promptInjection: 'High-resolution product photography for e-commerce. Clean background (white recommended for consistency). Professional studio lighting. Sharp focus, accurate colors. Zoom-ready detail.'
    },
    'shopify-collection': { 
        name: 'Shopify Collection', 
        dims: '1800x1000px', 
        ratio: '16:9',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'Collection page banner image',
        promptInjection: 'Collection banner showcasing product category. Multiple products or lifestyle scene representing the collection. Space for overlay text. Cohesive visual theme.'
    },
    'shopify-homepage': { 
        name: 'Shopify Homepage Hero', 
        dims: '2880x1200px', 
        ratio: '21:9',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'Homepage hero/slideshow image',
        promptInjection: 'Ultra-wide hero banner for homepage. High-impact lifestyle or product hero shot. Cinematic composition with space for headline text on left third. Brand colors, premium feel.'
    },
    'shopify-featured': { 
        name: 'Shopify Featured', 
        dims: '1200x900px', 
        ratio: '4:3',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'Featured product/section image',
        promptInjection: 'Featured product image for homepage sections. Lifestyle context or styled product shot. Engaging composition that draws attention.'
    },
    'shopify-announcement': { 
        name: 'Shopify Announcement', 
        dims: '1200x120px', 
        ratio: '10:1',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'Announcement bar background',
        promptInjection: 'Ultra-wide thin banner for announcement bar. Subtle pattern, gradient, or product silhouette. Text must remain readable - keep simple.'
    },
    'shopify-slideshow': { 
        name: 'Shopify Slideshow', 
        dims: '1920x1080px', 
        ratio: '16:9',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'Homepage slideshow image',
        promptInjection: 'Slideshow image for homepage carousel. Strong visual impact, lifestyle or product hero. Consistent style with other slides. Text space consideration.'
    },
    'shopify-blog': { 
        name: 'Shopify Blog', 
        dims: '1200x675px', 
        ratio: '16:9',
        platform: 'shopify',
        requiresWhiteBg: false,
        description: 'Blog post featured image',
        promptInjection: 'Blog featured image supporting article topic. Engaging, relevant to content. Good composition for text overlay title.'
    },
    
    // Social Media Formats (existing)
    'instagram-square': { name: 'Instagram Square', dims: '1080x1080px', ratio: '1:1', platform: 'social', requiresWhiteBg: false, description: 'Instagram feed square post', promptInjection: '' },
    'instagram-portrait': { name: 'Instagram Portrait', dims: '1080x1350px', ratio: '4:5', platform: 'social', requiresWhiteBg: false, description: 'Instagram feed portrait post', promptInjection: '' },
    'instagram-story': { name: 'Instagram Story', dims: '1080x1920px', ratio: '9:16', platform: 'social', requiresWhiteBg: false, description: 'Instagram/Facebook story', promptInjection: '' },
    'facebook': { name: 'Facebook Post', dims: '1200x630px', ratio: '16:9', platform: 'social', requiresWhiteBg: false, description: 'Facebook feed post', promptInjection: '' },
    'pinterest': { name: 'Pinterest', dims: '1000x1500px', ratio: '2:3', platform: 'social', requiresWhiteBg: false, description: 'Pinterest pin', promptInjection: '' },
    'tiktok': { name: 'TikTok/Reels', dims: '1080x1920px', ratio: '9:16', platform: 'social', requiresWhiteBg: false, description: 'TikTok/Reels vertical video', promptInjection: '' },
    'linkedin': { name: 'LinkedIn Post', dims: '1200x627px', ratio: '1.91:1', platform: 'social', requiresWhiteBg: false, description: 'LinkedIn feed post', promptInjection: '' },
    'twitter': { name: 'Twitter/X Post', dims: '1200x675px', ratio: '16:9', platform: 'social', requiresWhiteBg: false, description: 'Twitter/X post image', promptInjection: '' },
    'youtube': { name: 'YouTube Thumbnail', dims: '1280x720px', ratio: '16:9', platform: 'social', requiresWhiteBg: false, description: 'YouTube video thumbnail', promptInjection: '' },
    
    // General Formats
    'website-hero': { name: 'Website Hero', dims: '2560x1080px', ratio: '21:9', platform: 'general', requiresWhiteBg: false, description: 'Website hero banner', promptInjection: '' },
    'product-page': { name: 'Generic Product', dims: '2000x2000px', ratio: '1:1', platform: 'general', requiresWhiteBg: false, description: 'General product image', promptInjection: '' },
    'email': { name: 'Email Header', dims: '600x200px', ratio: '3:1', platform: 'general', requiresWhiteBg: false, description: 'Email header banner', promptInjection: '' },
    'custom-format': { name: 'Custom', dims: 'Custom', ratio: 'Custom', platform: 'general', requiresWhiteBg: false, description: 'Custom dimensions', promptInjection: '' }
};

// E-commerce Image Types by Platform
const imageTypesByPlatform = {
    amazon: [
        { id: 'main', icon: 'üèÜ', label: 'Main Product', desc: 'White BG Required' },
        { id: 'lifestyle', icon: 'üèÉ', label: 'Lifestyle/In-Use', desc: 'Action context' },
        { id: 'infographic', icon: 'üìä', label: 'Infographic', desc: 'Feature callouts' },
        { id: 'comparison', icon: '‚öñÔ∏è', label: 'Size Reference', desc: 'Scale comparison' },
        { id: 'packaging', icon: 'üì¶', label: 'Package Contents', desc: 'Flat lay' },
        { id: 'detail', icon: 'üîç', label: 'Detail Close-up', desc: 'Quality focus' }
    ],
    shopify: [
        { id: 'hero', icon: '‚≠ê', label: 'Hero Shot', desc: 'Primary product' },
        { id: 'lifestyle', icon: 'üè†', label: 'Lifestyle', desc: 'In-context' },
        { id: 'detail', icon: 'üîç', label: 'Detail Shot', desc: 'Features close-up' },
        { id: 'flat-lay', icon: 'üìê', label: 'Flat Lay', desc: 'Overhead view' },
        { id: 'group', icon: 'üë•', label: 'Group Shot', desc: 'Product variants' },
        { id: 'scale', icon: 'üìè', label: 'Scale Reference', desc: 'Size context' }
    ],
    social: [
        { id: 'hero', icon: '‚ú®', label: 'Hero Visual', desc: 'Eye-catching' },
        { id: 'lifestyle', icon: 'üì∏', label: 'Lifestyle', desc: 'Real-world use' },
        { id: 'ugc-style', icon: 'ü§≥', label: 'UGC Style', desc: 'Authentic feel' },
        { id: 'flat-lay', icon: 'üìê', label: 'Styled Flat Lay', desc: 'Aesthetic' },
        { id: 'before-after', icon: '‚ÜîÔ∏è', label: 'Before/After', desc: 'Transformation' },
        { id: 'testimonial', icon: 'üí¨', label: 'Testimonial', desc: 'With quote space' }
    ]
};

// Select E-commerce Platform
function selectPlatform(platform) {
    currentEcommercePlatform = platform;
    
    // Update tab styling
    document.querySelectorAll('.platform-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.platform-tab.${platform}`).classList.add('active');
    
    // Show/hide relevant format groups
    const formatSelect = document.getElementById('platformFormat');
    const amazonGroup = document.getElementById('amazonFormats');
    const shopifyGroup = document.getElementById('shopifyFormats');
    const socialGroup = document.getElementById('socialFormats');
    
    // Update white background toggle visibility
    const whiteBgToggle = document.getElementById('whiteBgToggle');
    if (platform === 'amazon') {
        whiteBgToggle.style.display = 'flex';
    } else {
        whiteBgToggle.style.display = 'none';
        whiteBackgroundMode = false;
        document.getElementById('whiteBgSwitch').classList.remove('active');
    }
    
    // Update image type selector
    updateImageTypeGrid(platform);
    
    // Set default format for platform
    if (platform === 'amazon') {
        formatSelect.value = 'amazon-main';
    } else if (platform === 'shopify') {
        formatSelect.value = 'shopify-product';
    } else {
        formatSelect.value = 'instagram-square';
    }
    
    // Trigger format change handler
    updateFormatInfo();
}

// Toggle White Background Mode
function toggleWhiteBackground() {
    whiteBackgroundMode = !whiteBackgroundMode;
    const toggle = document.getElementById('whiteBgSwitch');
    const container = document.getElementById('whiteBgToggle');
    
    if (whiteBackgroundMode) {
        toggle.classList.add('active');
        container.classList.add('active');
        showNotification('‚úÖ White Background Mode ENABLED - Amazon compliant prompts');
    } else {
        toggle.classList.remove('active');
        container.classList.remove('active');
        showNotification('White Background Mode disabled');
    }
}

// Update Image Type Grid
function updateImageTypeGrid(platform) {
    const container = document.getElementById('ecommerceImageType');
    const grid = document.getElementById('imageTypeGrid');
    
    if (platform === 'social') {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    const types = imageTypesByPlatform[platform] || imageTypesByPlatform.shopify;
    
    grid.innerHTML = types.map((type, index) => `
        <div class="image-type-option ${index === 0 ? 'selected' : ''}" onclick="selectImageType('${type.id}', this)">
            <input type="radio" name="imageType" value="${type.id}" ${index === 0 ? 'checked' : ''}>
            <span class="image-type-icon">${type.icon}</span>
            <span class="image-type-label">${type.label}</span>
            <span class="image-type-dims">${type.desc}</span>
        </div>
    `).join('');
    
    currentImageType = types[0].id;
}

// Select Image Type
function selectImageType(typeId, element) {
    currentImageType = typeId;
    
    document.querySelectorAll('.image-type-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    element.classList.add('selected');
    
    // Auto-update format if Amazon
    if (currentEcommercePlatform === 'amazon') {
        const formatMap = {
            'main': 'amazon-main',
            'lifestyle': 'amazon-lifestyle',
            'infographic': 'amazon-infographic',
            'comparison': 'amazon-comparison',
            'packaging': 'amazon-packaging',
            'detail': 'amazon-feature'
        };
        if (formatMap[typeId]) {
            document.getElementById('platformFormat').value = formatMap[typeId];
            updateFormatInfo();
        }
    }
}

// Update Format Info Display
function updateFormatInfo() {
    const format = document.getElementById('platformFormat').value;
    const formatData = ecommerceFormats[format];
    const infoText = document.getElementById('formatInfoText');
    
    if (formatData) {
        let badge = '';
        if (formatData.platform === 'amazon') {
            badge = formatData.requiresWhiteBg ? 
                '<span class="amazon-compliance-badge">üì¶ AMAZON ‚Ä¢ WHITE BG</span>' :
                '<span class="amazon-compliance-badge">üì¶ AMAZON</span>';
        } else if (formatData.platform === 'shopify') {
            badge = '<span class="shopify-badge">üõí SHOPIFY</span>';
        }
        
        infoText.innerHTML = `${formatData.name}: ${formatData.dims}, ${formatData.ratio} ratio${badge}<br><small style="color:#9ca3af;">${formatData.description}</small>`;
        
        // Auto-enable white background for Amazon main
        if (format === 'amazon-main' && !whiteBackgroundMode) {
            toggleWhiteBackground();
        }
    }
}

// Get E-commerce Prompt Injection
function getEcommercePromptInjection() {
    const format = document.getElementById('platformFormat').value;
    const formatData = ecommerceFormats[format];
    let injection = '';
    
    // Add format-specific injection
    if (formatData && formatData.promptInjection) {
        injection += '\n\nE-COMMERCE OPTIMIZATION:\n' + formatData.promptInjection;
    }
    
    // Add white background requirements if enabled
    if (whiteBackgroundMode || (formatData && formatData.requiresWhiteBg)) {
        injection += '\n\nAMAZON WHITE BACKGROUND REQUIREMENTS:\n';
        injection += '- Background: Pure white (#FFFFFF, RGB 255,255,255)\n';
        injection += '- Product fill: 85% of frame minimum\n';
        injection += '- No text, logos, watermarks, or badges on image\n';
        injection += '- Professional studio lighting with soft shadows\n';
        injection += '- Product must be the sole focus\n';
        injection += '- High contrast product edges for clean cutout\n';
    }
    
    return injection;
}

// Initialize E-commerce Platform on Page Load
function initEcommercePlatform() {
    // Set default platform
    selectPlatform('shopify');
    
    // Add format change listener
    document.getElementById('platformFormat').addEventListener('change', function() {
        updateFormatInfo();
        
        // Check if Amazon format selected from different platform
        const format = this.value;
        if (format.startsWith('amazon-')) {
            selectPlatform('amazon');
        } else if (format.startsWith('shopify-')) {
            selectPlatform('shopify');
        } else if (['instagram-square', 'instagram-portrait', 'instagram-story', 'facebook', 'pinterest', 'tiktok', 'linkedin', 'twitter', 'youtube'].includes(format)) {
            selectPlatform('social');
        }
    });
}

// ============================================================================
// TAPEGEEKS BRAND DNA & ENHANCED PROMPT SYSTEM v2.0
// ============================================================================

// TapeGeeks Brand Identity - Core DNA
const TAPEGEEKS_BRAND_DNA = {
    name: 'TapeGeeks',
    tagline: 'Professional-Grade Support for Athletes & Healthcare Professionals',
    origin: 'Made in Canada üá®üá¶',
    colors: {
        primary: '#C5D52E', // Lime Green
        secondary: '#1F2937', // Dark Charcoal
        accent: '#9FAA1E' // Darker Lime
    },
    values: [
        'Professional-grade quality',
        'Trusted by healthcare professionals',
        'Made in Canada excellence',
        'Performance-focused innovation',
        'Medical credibility with athletic spirit'
    ],
    voiceTone: 'Confident, trustworthy, expert, supportive, never gimmicky',
    targetAudience: [
        'Physiotherapists & Physical Therapists',
        'Chiropractors',
        'Athletic Trainers',
        'Sports Medicine Professionals',
        'Elite Athletes',
        'Recreational Athletes',
        'CrossFit Athletes',
        'Runners (Marathon, Trail, Track)',
        'Parents seeking solutions for children\'s breathing/sleep',
        'Health-conscious consumers'
    ],
    productLines: {
        kinesiologyTape: {
            name: 'TapeGeeks Kinesiology Tape',
            features: ['Medical-grade adhesive', 'Latex-free', 'Water-resistant', 'Breathable cotton', 'Hypoallergenic options', '140% stretch factor'],
            applications: ['Pain relief', 'Muscle support', 'Injury prevention', 'Post-surgical recovery', 'Athletic performance']
        },
        breathePlus: {
            name: 'Breathe Plus Nasal Strips',
            features: ['Drug-free', 'Instant airflow improvement', 'Comfortable adhesive', 'Kids & Adult sizes'],
            applications: ['Better sleep', 'Reduced snoring', 'Athletic breathing', 'Congestion relief', 'Pediatric sleep solutions']
        },
        accessories: {
            name: 'Professional Accessories',
            features: ['Medical-grade scissors', 'Trauma shears', 'Thumb protection tape'],
            applications: ['Professional clinical use', 'Athletic facility equipment']
        }
    }
};

// Latest Kinesiology Taping Protocols (2024-2025 Standards)
const TAPING_PROTOCOLS_2025 = {
    generalPrinciples: {
        skinPrep: 'Clean, dry, oil-free skin. Shave excessive hair. Round tape corners to prevent peeling.',
        applicationTension: {
            anchor: '0% - No stretch on first and last 2 inches',
            therapeutic: '25-35% - Standard support and decompression',
            structural: '50-75% - Maximum support for joint stabilization',
            lymphatic: '15-25% - Light tension for fluid drainage'
        },
        bodyPosition: 'Apply tape with target muscle/joint in stretched or functional position for optimal lift effect',
        activationMethod: 'Rub tape firmly after application to activate heat-sensitive adhesive',
        wearTime: '3-5 days typical, waterproof formula allows showering',
        removalTechnique: 'Remove slowly in direction of hair growth, use oil if needed'
    },
    visualStandards: {
        tapeAppearance: [
            'Smooth adhesion - no wrinkles, bubbles, or lifting edges',
            'Clean cut edges (rounded corners preferred)',
            'Proper tension visible through slight skin lift',
            'Color matches product specifications exactly',
            'Professional grid pattern visible on tape surface'
        ],
        applicationQuality: [
            'Anatomically correct placement following muscle/ligament paths',
            'Even tension distribution throughout therapeutic zone',
            'Secure anchors at endpoints',
            'Tape conforms to body contours naturally',
            'No skin irritation or excessive redness'
        ]
    },
    commonApplications: {
        knee: {
            patellofemoral: 'VMO support with I-strip or Y-strip around kneecap, 25-50% stretch',
            ITBand: 'Parallel strips from hip to knee along lateral thigh, 25-35% stretch',
            MCL: 'Medial support strip from inner thigh across joint to inner calf, 50% stretch',
            ACL: 'X-pattern crossing at center of knee joint, 50% stretch at intersection'
        },
        ankle: {
            lateral: 'Stirrup pattern from medial foot, under heel, up lateral leg, 25-35% stretch',
            achilles: 'Vertical I-strip or Y-strip from heel to mid-calf over tendon, 25-35% stretch',
            plantar: 'Longitudinal strip along arch plus X-pattern across plantar surface'
        },
        shoulder: {
            rotatorcuff: 'Y-strip from upper arm over deltoid to shoulder blade, 25-50% stretch',
            impingement: 'Decompression technique with downward pull from upper arm to back'
        },
        back: {
            lumbar: 'Bilateral parallel strips alongside spine (NOT on spine), 25-35% stretch',
            sacroiliac: 'X-pattern over SI joint for stability, 50% stretch at intersection'
        }
    }
};

// Enhanced Prompt Builder - Comprehensive TapeGeeks Optimization
function buildEnhancedTapeGeeksPrompt(selections) {
    let prompt = '';
    
    // Get format data for e-commerce optimization
    const formatData = ecommerceFormats[selections.platformFormat] || {};
    const isAmazon = formatData.platform === 'amazon';
    const isShopify = formatData.platform === 'shopify';
    
    // ========================================
    // SECTION 1: CORE IMAGE DESCRIPTION
    // ========================================
    prompt += `PROFESSIONAL PRODUCT PHOTOGRAPHY BRIEF FOR TAPEGEEKS\n`;
    prompt += `================================================\n\n`;
    
    // Product Details
    const productDetails = getProductDetails(selections.product);
    prompt += `PRODUCT: ${productDetails.fullName}\n`;
    prompt += `Description: ${productDetails.description}\n`;
    if (selections.color && selections.color !== 'na') {
        const colorName = selections.color.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        prompt += `Color: ${colorName} TapeGeeks kinesiology tape\n`;
    }
    prompt += `\n`;
    
    // ========================================
    // SECTION 2: SUBJECT & COMPOSITION
    // ========================================
    prompt += `SUBJECT & COMPOSITION:\n`;
    
    // Determine subject based on elements selected
    const elements = selections.elements || [];
    if (elements.includes('male-athlete')) {
        prompt += `Subject: Athletic male (25-40 years, fit physique, professional athlete appearance)\n`;
    } else if (elements.includes('female-athlete')) {
        prompt += `Subject: Athletic female (25-40 years, fit physique, professional athlete appearance)\n`;
    } else if (elements.includes('healthcare-professional')) {
        prompt += `Subject: Healthcare professional in clinical attire (scrubs or professional medical wear)\n`;
    } else {
        prompt += `Subject: Athletic individual demonstrating professional tape application\n`;
    }
    
    // Discipline-specific context
    if (selections.discipline) {
        const disciplineContext = getDisciplineContext(selections.discipline);
        prompt += `Athletic Context: ${disciplineContext}\n`;
    }
    
    // ========================================
    // SECTION 3: KINESIOLOGY TAPING PROTOCOL
    // ========================================
    if (selections.injury) {
        const tapingProtocol = getInjuryPositioning(selections.injury);
        if (tapingProtocol) {
            prompt += `\nKINESIOLOGY TAPE APPLICATION (CRITICAL - MEDICAL ACCURACY REQUIRED):\n`;
            prompt += `Target Area: ${selections.injury.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}\n`;
            prompt += `Body Position: ${tapingProtocol.position}\n`;
            prompt += `Taping Technique: ${tapingProtocol.taping}\n`;
            prompt += `\nTAPE VISUAL REQUIREMENTS:\n`;
            prompt += `- Tape must appear smooth, professionally applied, no wrinkles or bubbles\n`;
            prompt += `- Proper tension visible through subtle skin lift effect\n`;
            prompt += `- Clean-cut edges with rounded corners\n`;
            prompt += `- TapeGeeks characteristic grid pattern visible on tape surface\n`;
            prompt += `- Anatomically correct placement following muscle/ligament pathways\n`;
        }
    } else if (elements.includes('kinesiology-tape') || elements.includes('applying-tape')) {
        prompt += `\nKINESIOLOGY TAPE APPEARANCE (PRODUCT PHOTOGRAPHY):\n`;
        prompt += `- Professional-grade kinesiology tape clearly visible and prominent\n`;
        prompt += `- Smooth adhesion demonstrating quality adhesive\n`;
        prompt += `- Characteristic grid/weave pattern visible on tape surface\n`;
        prompt += `- Clean edges, professional application technique evident\n`;
    }
    
    // ========================================
    // SECTION 4: VISUAL STYLES
    // ========================================
    prompt += `\nVISUAL STYLE & LIGHTING:\n`;
    const styles = selections.styles || [];
    
    if (styles.includes('professional-studio')) {
        prompt += `- Professional studio lighting setup (3-point lighting)\n`;
        prompt += `- Clean, controlled environment\n`;
    }
    if (styles.includes('natural-lighting')) {
        prompt += `- Natural daylight, golden hour or soft diffused light\n`;
        prompt += `- Authentic outdoor or window-lit setting\n`;
    }
    if (styles.includes('action-motion')) {
        prompt += `- High-speed capture (1/1000s equivalent) to freeze motion\n`;
        prompt += `- Dynamic athletic movement, peak action moment\n`;
        prompt += `- Motion blur on non-subject elements for energy\n`;
    }
    if (styles.includes('close-up-macro')) {
        prompt += `- Macro/close-up lens (100mm equivalent)\n`;
        prompt += `- Shallow depth of field (f/2.8)\n`;
        prompt += `- Fine detail visibility on tape texture and skin\n`;
    }
    if (styles.includes('lifestyle-candid')) {
        prompt += `- Authentic, documentary-style photography\n`;
        prompt += `- Real-world environment, natural poses\n`;
        prompt += `- Candid moment capturing genuine athletic lifestyle\n`;
    }
    if (styles.includes('clinical-medical')) {
        prompt += `- Clinical environment (treatment room, medical office)\n`;
        prompt += `- Clean, professional, trustworthy atmosphere\n`;
        prompt += `- Medical credibility through setting and presentation\n`;
    }
    if (styles.includes('minimalist-clean')) {
        prompt += `- Minimalist composition with negative space\n`;
        prompt += `- Clean background (white or neutral)\n`;
        prompt += `- Focus entirely on product/subject\n`;
    }
    if (styles.includes('dynamic-energetic')) {
        prompt += `- Bold, energetic composition\n`;
        prompt += `- Dynamic angles (low angle for power, Dutch tilt for energy)\n`;
        prompt += `- High contrast, vivid colors\n`;
    }
    
    // Default if no styles selected
    if (styles.length === 0) {
        prompt += `- Professional commercial photography quality\n`;
        prompt += `- Balanced lighting for product visibility\n`;
        prompt += `- Clean, focused composition\n`;
    }
    
    // ========================================
    // SECTION 5: E-COMMERCE OPTIMIZATION
    // ========================================
    const ecommerceInjection = getEcommercePromptInjection();
    if (ecommerceInjection) {
        prompt += ecommerceInjection;
    }
    
    // ========================================
    // SECTION 6: FORMAT SPECIFICATIONS
    // ========================================
    const formatSpecs = getFormatSpecs(selections.platformFormat);
    prompt += `\nFORMAT & TECHNICAL SPECIFICATIONS:\n`;
    prompt += `Aspect Ratio: ${formatSpecs.ratio}\n`;
    prompt += `Dimensions: ${formatSpecs.dimensions}\n`;
    prompt += `Resolution: High-resolution, minimum 300 DPI equivalent\n`;
    prompt += `Color Space: sRGB for web, professional color accuracy\n`;
    
    // ========================================
    // SECTION 7: TEXT OVERLAY (if applicable)
    // ========================================
    if (selections.customText) {
        prompt += `\nTEXT OVERLAY REQUIREMENTS:\n`;
        prompt += `Text: "${selections.customText}"\n`;
        prompt += `Typography: Bold sans-serif font, highly legible\n`;
        prompt += `Position: Upper third of frame, rule-of-thirds placement\n`;
        prompt += `Color: High contrast (white with dark shadow/outline recommended)\n`;
        prompt += `Note: Leave clear space in composition for text placement\n`;
    }
    
    // ========================================
    // SECTION 8: TAPEGEEKS BRAND REQUIREMENTS
    // ========================================
    prompt += `\nTAPEGEEKS BRAND REQUIREMENTS (MANDATORY):\n`;
    prompt += `- Brand: TapeGeeks - Professional Canadian Sports Medicine Company\n`;
    prompt += `- Brand Colors: Lime Green (#C5D52E), Dark Charcoal (#1F2937)\n`;
    prompt += `- Brand Values: Professional-grade quality, trusted by healthcare professionals, Made in Canada excellence\n`;
    prompt += `- Tone: Confident, trustworthy, expert, supportive - NEVER gimmicky or amateur\n`;
    prompt += `- Quality Standard: Commercial-grade professional photography suitable for:\n`;
    prompt += `  ‚Ä¢ E-commerce listings (Amazon, Shopify)\n`;
    prompt += `  ‚Ä¢ Social media marketing\n`;
    prompt += `  ‚Ä¢ Healthcare professional marketing materials\n`;
    prompt += `  ‚Ä¢ Athletic facility displays\n`;
    prompt += `  ‚Ä¢ Print advertising\n`;
    
    // ========================================
    // SECTION 9: SPECIAL NOTES
    // ========================================
    if (selections.specialNotes) {
        prompt += `\nADDITIONAL REQUIREMENTS:\n${selections.specialNotes}\n`;
    }
    
    // ========================================
    // SECTION 10: FINAL QUALITY DIRECTIVE
    // ========================================
    prompt += `\nFINAL OUTPUT REQUIREMENTS:\n`;
    prompt += `- Photorealistic quality (not illustrated or cartoon)\n`;
    prompt += `- Publication-ready, no artifacts or distortions\n`;
    prompt += `- Anatomically correct human subjects\n`;
    prompt += `- Medically accurate tape application (if shown)\n`;
    prompt += `- Professional commercial photography standard\n`;
    prompt += `- Suitable for TapeGeeks official marketing use\n`;
    
    return prompt;
}

// Get discipline-specific appearance description
function getDisciplineAppearance(discipline) {
    const appearances = {
        'running': 'lean runner physique, determined expression, performance athletic wear',
        'crossfit': 'muscular/athletic build, intense focus, functional fitness attire, chalk-dusted hands',
        'strength': 'powerful muscular physique, lifting belt possible, gym attire, confident stance',
        'team-sports': 'athletic team sport physique, competitive expression, team sport attire',
        'combat': 'lean/muscular fighter physique, focused intensity, combat sports attire',
        'gymnastics': 'lean/flexible physique, graceful posture, gymnastics attire',
        'racquet': 'athletic lean physique, focused expression, appropriate sport attire',
        'healthcare': 'professional clinical appearance, medical scrubs or clinical attire, caring expression',
        'fitness': 'fit healthy physique, energetic expression, modern fitness attire',
        'sleep': 'relaxed comfortable appearance, peaceful expression, comfortable sleepwear',
        'outdoor': 'athletic outdoor enthusiast, adventurous expression, outdoor athletic gear',
        'aquatic': 'swimmer physique, focused expression, swim/water sport attire',
        'winter': 'athletic winter sport physique, determined expression, winter sport attire',
        'dance': 'graceful dancer physique, expressive pose, dance attire',
        'esports': 'focused concentration, comfortable gaming attire, ergonomic posture'
    };
    return appearances[discipline] || 'professional athletic appearance';
}

// Get color description with visual details
function getColorDescription(colorKey) {
    const colors = {
        'black': 'Classic Black - bold, professional, high contrast visibility',
        'royal-blue': 'Royal Blue - vibrant, athletic, professional appearance',
        'pink': 'Pink - sport pink, athletic feminine, high visibility',
        'beige': 'Neutral Beige/Tan - skin-tone match, discreet clinical use',
        'red': 'Athletic Red - bold, energetic, high visibility',
        'white': 'Pure White - clean, clinical, maximum contrast on darker skin',
        'green': 'Athletic Green - natural, fresh, sports medicine aesthetic',
        'orange': 'Vibrant Orange - high energy, maximum visibility, safety color',
        'purple': 'Athletic Purple - unique, bold, professional',
        'multi': 'Multiple colors - variety pack display showing color range',
        'custom-color': 'Custom color selection',
        'na': 'Standard tape color'
    };
    return colors[colorKey] || colorKey.replace(/-/g, ' ');
}

// Get content category context for scene setting
function getContentCategoryContext(contentCategory) {
    const contexts = {
        'product': {
            environment: 'Professional studio with clean white or gradient background',
            focus: 'Product as hero element, isolated display',
            lighting: 'Controlled studio lighting, even illumination'
        },
        'lifestyle': {
            environment: 'Real-world athletic setting (gym, field, trail, studio)',
            focus: 'Product in authentic use during athletic activity',
            lighting: 'Natural or natural-appearing lighting'
        },
        'educational': {
            environment: 'Clean instructional setting (treatment room, demonstration area)',
            focus: 'Clear technique demonstration, step-by-step visibility',
            lighting: 'Bright, even lighting for clarity'
        },
        'clinical': {
            environment: 'Medical treatment room or physiotherapy clinic',
            focus: 'Healthcare professional credibility',
            lighting: 'Clinical overhead lighting, clean and professional'
        },
        'seasonal': {
            environment: 'Season-appropriate setting with festive/thematic elements',
            focus: 'Seasonal promotion with product prominence',
            lighting: 'Thematic lighting (warm holidays, bright summer)'
        },
        'social': {
            environment: 'Dynamic, scroll-stopping social media backdrop',
            focus: 'Eye-catching visual for social feeds',
            lighting: 'High-contrast, attention-grabbing lighting'
        },
        'beforeafter': {
            environment: 'Consistent setting for comparison (split screen capable)',
            focus: 'Clear transformation demonstration',
            lighting: 'Identical lighting in both states'
        },
        'testimonial': {
            environment: 'Authentic real-world user environment',
            focus: 'Genuine endorsement feel, relatable setting',
            lighting: 'Natural, authentic lighting'
        },
        'custom': {
            environment: 'Custom setting as specified',
            focus: 'As specified in notes',
            lighting: 'Professional quality lighting'
        }
    };
    return contexts[contentCategory] || contexts['product'];
}

// Get comprehensive product photography context
function getProductPhotographyContext(contentCategory) {
    const contexts = {
        'product': {
            style: 'Clean product photography',
            focus: 'Product as hero, isolated or minimal context',
            lighting: 'Professional studio lighting, even illumination',
            background: 'White, light gray, or brand-colored gradient'
        },
        'lifestyle': {
            style: 'Lifestyle action photography',
            focus: 'Product in authentic real-world use',
            lighting: 'Natural or natural-appearing light',
            background: 'Athletic environment, gym, outdoors, treatment room'
        },
        'educational': {
            style: 'Instructional documentation',
            focus: 'Clear demonstration of technique',
            lighting: 'Even, clinical lighting for clarity',
            background: 'Clean, uncluttered, professional'
        },
        'clinical': {
            style: 'Medical professional imagery',
            focus: 'Healthcare credibility and trust',
            lighting: 'Clinical overhead lighting, clean and bright',
            background: 'Treatment room, medical office setting'
        },
        'seasonal': {
            style: 'Promotional campaign imagery',
            focus: 'Seasonal theme with product prominence',
            lighting: 'Themed lighting (warm for holidays, bright for summer)',
            background: 'Seasonal elements, festive but professional'
        },
        'social': {
            style: 'Social media optimized',
            focus: 'Eye-catching, scroll-stopping visuals',
            lighting: 'Dynamic, high-contrast for social feeds',
            background: 'Bold, simple, brand-aligned'
        },
        'beforeafter': {
            style: 'Transformation comparison',
            focus: 'Clear before/after demonstration',
            lighting: 'Consistent lighting in both images',
            background: 'Identical background for comparison'
        },
        'testimonial': {
            style: 'Social proof imagery',
            focus: 'Authentic user/professional endorsement feel',
            lighting: 'Natural, authentic lighting',
            background: 'Real-world environment'
        }
    };
    
    return contexts[contentCategory] || contexts['product'];
}

// Discipline sub-categories data
const disciplineSubCategories = {
    'healthcare': [
        'Physiotherapist / Physical Therapist',
        'Chiropractor',
        'Sports Medicine Doctor',
        'Orthopedic Specialist',
        'Podiatrist / Foot Doctor',
        'Athletic Trainer',
        'Massage Therapist / RMT',
        'Occupational Therapist',
        'Osteopath',
        'Custom Professional'
    ],
    'running': [
        'Marathon Runner',
        'Half Marathon Runner',
        '5K/10K Runner',
        'Trail Runner',
        'Ultra Runner',
        'Track & Field Athlete',
        'Cross Country Runner',
        'Sprinter',
        'Custom Runner Type'
    ],
    'strength': [
        'CrossFit Athlete',
        'Olympic Weightlifter',
        'Powerlifter',
        'Bodybuilder',
        'Strongman/Strongwoman',
        'Functional Fitness Athlete',
        'Gym Athlete (General)',
        'Custom Strength Athlete'
    ],
    'team-sports': [
        'Soccer/Football Player',
        'Basketball Player',
        'Volleyball Player',
        'Hockey Player',
        'Baseball/Softball Player',
        'Rugby Player',
        'Lacrosse Player',
        'Custom Team Sport'
    ],
    'endurance': [
        'Cyclist (Road)',
        'Mountain Biker',
        'Triathlete',
        'Swimmer',
        'Rower',
        'Long-Distance Paddler',
        'Custom Endurance Athlete'
    ],
    'other-sports': [
        'Tennis Player',
        'Golfer',
        'Gymnast',
        'Martial Artist',
        'Rock Climber',
        'Skier/Snowboarder',
        'Dancer',
        'Custom Sport'
    ],
    'sleep': [
        'Adult Sleep (Nasal Strips)',
        'Kids Sleep (Ages 2-5)',
        'Kids Sleep (Ages 6-12)',
        'Snoring Reduction (Adult)',
        'Athletic Performance Breathing',
        'Allergy Relief',
        'Congestion Relief',
        'Mouth Tape Sleep',
        'Custom Sleep/Breathing'
    ],
    'fitness': [
        'General Fitness Enthusiast',
        'Weekend Warrior',
        'Yoga Practitioner',
        'Pilates Enthusiast',
        'Home Workout',
        'Casual Gym-Goer',
        'Recreational Athlete',
        'Custom Fitness'
    ],
    'recovery': [
        'Post-Surgery Recovery',
        'Acute Injury Management',
        'Chronic Pain Management',
        'Return to Sport Protocol',
        'Elderly Mobility Support',
        'Postural Correction',
        'Custom Recovery'
    ]
};

// Injury sub-categories data
const injurySubCategories = {
    'knee': [
        "Runner's Knee (Patellofemoral Pain)",
        'ACL/MCL Support',
        'Meniscus Support',
        'Patellar Tendonitis',
        'IT Band Syndrome',
        'Knee Sprain/Strain',
        'Custom Knee Injury'
    ],
    'ankle': [
        'Ankle Sprain (Lateral)',
        'Ankle Sprain (Medial)',
        'Achilles Tendonitis',
        'Ankle Instability',
        'Plantar Fasciitis',
        'Shin Splints (Medial Tibial Stress)',
        'Peroneal Tendonitis',
        'Custom Ankle Injury'
    ],
    'shoulder': [
        'Rotator Cuff Strain/Tear',
        'Shoulder Impingement',
        'AC Joint Separation',
        'Shoulder Instability',
        'Frozen Shoulder',
        'Bicep Tendonitis',
        'Custom Shoulder Injury'
    ],
    'back': [
        'Lower Back Pain (Lumbar)',
        'Upper Back/Posture Correction',
        'Sciatica',
        'Muscle Strain (Paraspinal)',
        'Thoracic Pain',
        'SI Joint Pain',
        'Custom Back Issue'
    ],
    'elbow-wrist': [
        'Tennis Elbow (Lateral Epicondylitis)',
        "Golfer's Elbow (Medial Epicondylitis)",
        'Wrist Strain',
        'Carpal Tunnel Support',
        "De Quervain's Tenosynovitis",
        'Custom Elbow/Wrist Issue'
    ],
    'leg-thigh': [
        'Hamstring Strain',
        'Quad Strain',
        'Calf Strain',
        'Hip Flexor Strain',
        'Groin Pull',
        'IT Band Friction Syndrome',
        'Custom Leg Injury'
    ],
    'foot-toe': [
        'Turf Toe',
        'Metatarsalgia',
        "Morton's Neuroma",
        'Toe Sprain',
        'Foot Arch Support',
        'Custom Foot Issue'
    ],
    'neck-head': [
        'Neck Strain/Whiplash',
        'Posture Correction (Forward Head)',
        'Cervical Support',
        'Tension Headache Relief',
        'Custom Neck Issue'
    ],
    'general': [
        'Muscle Fatigue (General)',
        'Lymphatic Drainage',
        'Edema/Swelling Control',
        'Bruising Management',
        'Postural Support (General)',
        'No Specific Injury (Preventative)',
        'Custom Condition'
    ]
};

// Event listeners for dynamic dropdowns
document.getElementById('contentCategory').addEventListener('change', function() {
    document.getElementById('customContentType').style.display =
        this.value === 'custom' ? 'block' : 'none';
});

document.getElementById('platformFormat').addEventListener('change', function() {
    document.getElementById('customDimensions').style.display =
        this.value === 'custom-format' ? 'block' : 'none';
});

document.getElementById('disciplineCategory').addEventListener('change', function() {
    const subCat = document.getElementById('disciplineSubCategory');
    const customInput = document.getElementById('customDiscipline');

    if (this.value === 'custom-discipline') {
        subCat.style.display = 'none';
        customInput.style.display = 'block';
    } else if (this.value && this.value !== 'custom-discipline') {
        subCat.style.display = 'block';
        customInput.style.display = 'none';

        // Populate sub-categories
        subCat.innerHTML = '';
        disciplineSubCategories[this.value].forEach(item => {
            const option = document.createElement('option');
            option.value = item.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            option.textContent = item;
            subCat.appendChild(option);
        });
    } else {
        subCat.style.display = 'none';
        customInput.style.display = 'none';
    }
});

document.getElementById('injuryCategory').addEventListener('change', function() {
    const specificInjury = document.getElementById('specificInjury');
    const customInput = document.getElementById('customInjury');

    if (this.value && this.value !== '') {
        specificInjury.style.display = 'block';

        // Populate injury sub-categories
        specificInjury.innerHTML = '';
        injurySubCategories[this.value].forEach(item => {
            const option = document.createElement('option');
            option.value = item.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            option.textContent = item;
            specificInjury.appendChild(option);
        });
    } else {
        specificInjury.style.display = 'none';
        customInput.style.display = 'none';
    }
});

document.getElementById('specificInjury').addEventListener('change', function() {
    const customInput = document.getElementById('customInjury');
    customInput.style.display = this.value && this.value.includes('custom') ? 'block' : 'none';
});

document.getElementById('productColor').addEventListener('change', function() {
    document.getElementById('customColor').style.display =
        this.value === 'custom-color' ? 'block' : 'none';
});

// Quick text fill function
function fillText(text) {
    document.getElementById('customText').value = text;
}

// Load preset configurations
function loadPreset(presetType) {
    clearAll();

    const presets = {
        'instagramProduct': {
            aiPlatform: 'midjourney',
            contentCategory: 'product',
            platformFormat: 'instagram-square',
            disciplineCategory: 'healthcare',
            specificProduct: 'kt-pro',
            productColor: 'royal-blue',
            styles: ['professional-studio', 'minimalist-clean'],
            elements: ['kinesiology-tape', 'packaging-visible'],
            captionStyle: 'professional/clinical'
        },
        'crossfitAction': {
            aiPlatform: 'midjourney',
            contentCategory: 'lifestyle',
            platformFormat: 'instagram-portrait',
            disciplineCategory: 'strength',
            injuryCategory: 'knee',
            specificProduct: 'kt-standard',
            productColor: 'black',
            customText: 'CRUSH YOUR WOD',
            styles: ['action-motion', 'dynamic-energetic'],
            elements: ['female-athlete', 'kinesiology-tape', 'mid-exercise'],
            captionStyle: 'motivational'
        },
        'clinicalApp': {
            aiPlatform: 'chatgpt',
            contentCategory: 'educational',
            platformFormat: 'pinterest',
            disciplineCategory: 'healthcare',
            injuryCategory: 'knee',
            specificProduct: 'kt-pro',
            productColor: 'beige',
            customText: 'STEP-BY-STEP GUIDE',
            styles: ['clinical-medical', 'natural-lighting'],
            elements: ['healthcare-professional', 'applying-tape'],
            captionStyle: 'educational'
        },
        'salePromo': {
            aiPlatform: 'gemini',
            contentCategory: 'seasonal',
            platformFormat: 'facebook',
            disciplineCategory: 'fitness',
            specificProduct: 'kt-standard',
            productColor: 'multi',
            customText: 'FATHERS DAY SALE',
            styles: ['minimalist-clean', 'professional-studio'],
            elements: ['kinesiology-tape', 'packaging-visible'],
            captionStyle: 'promotional'
        },
        'kidsSleep': {
            aiPlatform: 'chatgpt',
            contentCategory: 'lifestyle',
            platformFormat: 'instagram-square',
            disciplineCategory: 'sleep',
            specificProduct: 'ns-kids-sm',
            productColor: 'na',
            styles: ['natural-lighting', 'lifestyle-candid'],
            elements: ['nasal-strips'],
            captionStyle: 'problem-solution'
        }
    };

    if (presets[presetType]) {
        const preset = presets[presetType];

        // Set dropdowns
        if (preset.aiPlatform) document.getElementById('aiPlatform').value = preset.aiPlatform;
        if (preset.contentCategory) document.getElementById('contentCategory').value = preset.contentCategory;
        if (preset.platformFormat) document.getElementById('platformFormat').value = preset.platformFormat;
        if (preset.disciplineCategory) {
            document.getElementById('disciplineCategory').value = preset.disciplineCategory;
            document.getElementById('disciplineCategory').dispatchEvent(new Event('change'));
        }
        if (preset.injuryCategory) {
            document.getElementById('injuryCategory').value = preset.injuryCategory;
            document.getElementById('injuryCategory').dispatchEvent(new Event('change'));
        }
        if (preset.specificProduct) document.getElementById('specificProduct').value = preset.specificProduct;
        if (preset.productColor) document.getElementById('productColor').value = preset.productColor;
        if (preset.customText) document.getElementById('customText').value = preset.customText;
        if (preset.captionStyle) document.getElementById('captionStyle').value = preset.captionStyle;

        // Set checkboxes
        if (preset.styles) {
            preset.styles.forEach(style => {
                const checkbox = document.querySelector(`input[value="${style}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        if (preset.elements) {
            preset.elements.forEach(elem => {
                const checkbox = document.querySelector(`input[value="${elem}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }

        showNotification('Preset loaded! Click Generate to create content.');
    }
}

// Clear all selections
function clearAll() {
    // Reset all form elements
    document.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
    });
    document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
        input.value = '';
    });
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });

    // Hide conditional inputs
    document.querySelectorAll('input[type="text"][style*="display"]').forEach(input => {
        input.style.display = 'none';
    });
    document.querySelectorAll('select[style*="display"]').forEach(select => {
        select.style.display = 'none';
    });

    // Clear output
    document.getElementById('outputArea').innerHTML = `
        <div style="text-align:center; padding:100px 20px; color:#6b7280;">
            <h2 style="color:#C5D52E; margin-bottom:15px;">üëà Select your options and click Generate</h2>
            <p>Your AI-optimized prompt, captions, and specifications will appear here</p>
        </div>
    `;

    showNotification('All selections cleared');
}

// Generate content (simplified for v1.0 - will expand in next phases)
function generateContent() {
    // Collect all selections
    const selections = {
        aiPlatform: document.getElementById('aiPlatform').value,
        contentCategory: document.getElementById('contentCategory').value,
        platformFormat: document.getElementById('platformFormat').value,
        discipline: document.getElementById('disciplineCategory').value,
        injury: document.getElementById('specificInjury').value,
        product: document.getElementById('specificProduct').value,
        color: document.getElementById('productColor').value,
        customText: document.getElementById('customText').value,
        captionStyle: document.getElementById('captionStyle').value,
        specialNotes: document.getElementById('specialNotes').value
    };

    // Get selected styles and elements
    selections.styles = Array.from(document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked'))
        .filter(cb => cb.value.includes('professional') || cb.value.includes('natural') ||
                     cb.value.includes('action') || cb.value.includes('macro') ||
                     cb.value.includes('lifestyle') || cb.value.includes('clinical') ||
                     cb.value.includes('minimalist') || cb.value.includes('dynamic'))
        .map(cb => cb.value);

    selections.elements = Array.from(document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked'))
        .filter(cb => cb.value.includes('athlete') || cb.value.includes('professional') ||
                     cb.value.includes('tape') || cb.value.includes('strips') ||
                     cb.value.includes('package') || cb.value.includes('applying') ||
                     cb.value.includes('exercise'))
        .map(cb => cb.value);

    // Generate prompt based on platform
    const prompt = generateAIPrompt(selections);
    const captions = generateCaptions(selections);
    const specs = generateSpecs(selections);
    const hashtags = generateHashtags(selections);

    // Display output
    displayOutput(prompt, captions, specs, hashtags);

    showNotification('Content generated successfully!');
}

// Generate Prompt Only (Fast) - skip captions/hashtags
function generatePromptOnly() {
    // Collect all selections
    const selections = {
        aiPlatform: document.getElementById('aiPlatform').value,
        contentCategory: document.getElementById('contentCategory').value,
        platformFormat: document.getElementById('platformFormat').value,
        discipline: document.getElementById('disciplineCategory').value,
        injury: document.getElementById('specificInjury').value,
        product: document.getElementById('specificProduct').value,
        color: document.getElementById('productColor').value,
        customText: document.getElementById('customText').value,
        captionStyle: document.getElementById('captionStyle').value,
        specialNotes: document.getElementById('specialNotes').value
    };

    // Get selected styles and elements
    selections.styles = Array.from(document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked'))
        .filter(cb => cb.value.includes('professional') || cb.value.includes('natural') ||
                     cb.value.includes('action') || cb.value.includes('macro') ||
                     cb.value.includes('lifestyle') || cb.value.includes('clinical') ||
                     cb.value.includes('minimalist') || cb.value.includes('dynamic'))
        .map(cb => cb.value);

    selections.elements = Array.from(document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked'))
        .filter(cb => cb.value.includes('athlete') || cb.value.includes('professional') ||
                     cb.value.includes('tape') || cb.value.includes('strips') ||
                     cb.value.includes('package') || cb.value.includes('applying') ||
                     cb.value.includes('exercise'))
        .map(cb => cb.value);

    // Generate only the prompt
    const prompt = generateAIPrompt(selections);
    const specs = generateSpecs(selections);

    // Display prompt-only output
    const outputArea = document.getElementById('outputArea');

    let html = `
        <div class="output-section">
            <div class="output-title">
                ü§ñ AI-Optimized Prompt (Ready to Use)
                <button class="copy-btn" onclick="copyToClipboard('prompt')">Copy Prompt</button>
            </div>
            <div class="output-content" id="promptOutput">${prompt}</div>
        </div>

        <div class="output-section">
            <div class="output-title">üìä Image Specifications</div>
            <div class="output-content">${specs}</div>
        </div>
    `;

    // V2.0: Target the prompt output area, not the entire output area (preserve image display)
    const promptOutputArea = document.getElementById('promptOutputArea');
    if (promptOutputArea) {
        promptOutputArea.innerHTML = html;
        promptOutputArea.style.textAlign = 'left';
        promptOutputArea.style.padding = '0';
    } else {
        outputArea.innerHTML = html;
    }
    outputArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    showNotification('AI Prompt generated! Copy and paste into your AI platform.');
}

// Generate AI prompt (platform-specific)
function generateAIPrompt(selections) {
    // ============================================================================
    // STAGE 1: Check if user clicked "Use" on a quick variation
    // ============================================================================
    console.log('=== generateAIPrompt START ===');
    console.log('Checking window.selectedImagePrompt:', window.selectedImagePrompt ? 'EXISTS' : 'NULL');

    if (window.selectedImagePrompt) {
        console.log('‚úì USE BUTTON CLICKED: Generating comprehensive Stage 2 prompt');
        console.log('Selected variation index:', window.selectedVariationIndex);
        console.log('Controls have been auto-populated based on variation type');

        // Set flag for display to show badge
        window.usedStage1Variation = true;

        // Clear the flags after reading
        window.selectedImagePrompt = null;
        window.selectedVariationIndex = null;

        console.log('Proceeding to generate comprehensive prompt using auto-populated controls + image analysis...');
    }

    console.log('Generating comprehensive prompt for platform:', selections.aiPlatform);
    let prompt = '';

    switch(selections.aiPlatform) {
        case 'gemini':
            prompt = generateGeminiPrompt(selections);
            break;
        case 'chatgpt':
            prompt = generateChatGPTPrompt(selections);
            break;
        case 'perplexity':
            prompt = generatePerplexityPrompt(selections);
            break;
        case 'pollinations':
            prompt = generatePollinationsPrompt(selections);
            break;
        case 'huggingface':
            prompt = generateHuggingFacePrompt(selections);
            break;
        case 'midjourney':
            prompt = generateMidjourneyPrompt(selections);
            break;
        case 'sora2':
            prompt = generateSora2Prompt(selections);
            break;
        case 'grok':
            prompt = generateGrokPrompt(selections);
            break;
        case 'krea':
            prompt = generateKreaPrompt(selections);
            break;
        case 'sora':
            prompt = generateSoraPrompt(selections);
            break;
        default:
            prompt = generateGeminiPrompt(selections); // Default to Gemini
    }

    return prompt;
}

// Build comprehensive prompt using uploaded image analysis
function buildComprehensiveImagePrompt(selections, analysis) {
    const colors = analysis.colorPalette.slice(0, 3);
    const lightingDesc = buildLightingDescription(analysis);
    const moodDesc = buildMoodDescription(analysis);

    let prompt = `Professional kinesiology tape product photography using uploaded image as reference:

REFERENCE IMAGE ANALYSIS:
Style: ${analysis.style}
Lighting: ${lightingDesc}
Mood: ${moodDesc}
Colors: ${colors.join(', ')}
Temperature: ${analysis.temperature.description}
Brightness: ${analysis.brightness.level}

COMPREHENSIVE PRODUCT PHOTOGRAPHY BRIEF:

SUBJECT & COMPOSITION:
Athletic individual with TapeGeeks kinesiology tape professionally applied to ${selections.injury || 'major muscle group (shoulder, knee, back, or leg)'}.
Discipline: ${selections.discipline || 'general athletics'}
`;

    // Add product details
    if (selections.product) {
        prompt += `Product: ${selections.product}\n`;
    }
    if (selections.color && selections.color !== 'na') {
        prompt += `Tape Color: ${selections.color.replace(/-/g, ' ')}\n`;
    }

    prompt += `
SETTING & ENVIRONMENT:
${analysis.brightness.level === 'Bright' ?
    'Bright, clean professional environment - modern athletic training facility or medical clinic. Natural and studio lighting combined for medical-grade professional aesthetic.' :
    'Controlled professional studio environment with dramatic lighting. Clean background emphasizing subject and product.'}

LIGHTING SETUP:
Match reference image lighting: ${lightingDesc}
Color temperature: ${analysis.temperature.description}
Quality: Professional commercial photography lighting
Goal: ${analysis.brightness.level === 'Bright' ? 'Bright, trustworthy, medical credibility' : 'Dramatic, athletic, professional performance'}

COLOR PALETTE & VISUAL IDENTITY:
Primary reference colors: ${colors.join(', ')} - ${moodDesc}
Brand integration: TapeGeeks lime green (#C5D52E) as accent color
Overall color grading: ${analysis.temperature.warmth} tones matching reference image

STYLE & MOOD:
Photography style: ${analysis.style} aesthetic from reference image
Mood: ${moodDesc}
Approach: Professional sports medicine photography - trustworthy, high-quality, athletic
`;

    // Add selected visual styles
    if (selections.styles && selections.styles.length > 0) {
        prompt += `Visual styles: ${selections.styles.join(', ')}\n`;
    }

    // Add platform format
    const formatMap = {
        'instagram-square': 'Square 1:1 for Instagram posts',
        'instagram-portrait': 'Vertical 4:5 for Instagram portrait',
        'instagram-story': 'Vertical 9:16 for Instagram Stories',
        'facebook': 'Landscape 16:9 for Facebook',
        'pinterest': 'Vertical 2:3 for Pinterest'
    };
    prompt += `\nFORMAT: ${formatMap[selections.platformFormat] || 'Standard format'}\n`;

    // Add technical requirements
    prompt += `
TECHNICAL SPECIFICATIONS:
Camera: Professional full-frame camera
Lens: 50mm or 85mm prime lens
Aperture: f/2.8-4.0 for professional depth of field
Focus: Tack-sharp on tape application area
Background: Professional bokeh blur
Resolution: 4K-8K commercial quality, print-ready 300 DPI

KINESIOLOGY TAPE APPLICATION:
Show professional taping technique clearly
Tape properly adhered (no wrinkles or bubbles)
Application demonstrates medical/athletic expertise
Tape as hero product - clearly visible and prominent
`;

    // Add elements if selected
    if (selections.elements && selections.elements.length > 0) {
        prompt += `Additional elements: ${selections.elements.join(', ')}\n`;
    }

    // Add custom notes
    if (selections.specialNotes) {
        prompt += `\nSPECIAL INSTRUCTIONS:\n${selections.specialNotes}\n`;
    }

    // Add custom text overlay
    if (selections.customText) {
        prompt += `\nTEXT OVERLAY: "${selections.customText}" in bold white letters with dark outline, positioned in upper area\n`;
    }

    prompt += `
BRAND POSITIONING:
TapeGeeks - Professional Canadian sports medicine brand
Personality: Trustworthy, professional-grade, athletic performance focused, medical credibility
Made in Canada pride`;

    // Add E-commerce optimization injection
    const ecommerceInjection = getEcommercePromptInjection();
    if (ecommerceInjection) {
        prompt += ecommerceInjection;
    }

    prompt += `

FINAL RESULT:
Professional kinesiology tape product photography that captures the ${analysis.style} aesthetic and ${moodDesc} from the reference image while clearly showcasing TapeGeeks professional tape application. Image suitable for: e-commerce listings (Amazon, Shopify), social media marketing, website content, professional healthcare materials, athletic training facility displays.`;

    return prompt;
}

// Gemini prompt format (conversational, natural language)
function generateGeminiPrompt(selections) {
    // ============================================================================
    // Check if we have uploaded image analysis - if so, generate comprehensive prompt
    // ============================================================================
    if (currentAnalysis && currentImageData) {
        console.log('‚úì Image analysis available - generating COMPREHENSIVE prompt');
        return buildComprehensiveImagePrompt(selections, currentAnalysis);
    }

    console.log('No image analysis - generating ENHANCED comprehensive prompt');
    
    // ========================================================================
    // ENHANCED GEMINI PROMPT - Using ALL Selections with Latest Standards
    // ========================================================================
    let prompt = "Professional Product Photography Brief for TapeGeeks:\n\n";

    // -------------------------------------------------------------------------
    // SECTION 1: PRIMARY SUBJECT & TAPE APPLICATION (Critical Visual Priority)
    // -------------------------------------------------------------------------
    if (selections.injury) {
        const injuryPositioning = getInjuryPositioning(selections.injury);
        if (injuryPositioning && typeof injuryPositioning === 'string' && injuryPositioning.length > 0) {
            const injuryName = selections.injury.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            prompt += `KINESIOLOGY TAPE APPLICATION - ${injuryName}:\n`;
            prompt += `${simplifyTapingDescription(injuryPositioning)}\n\n`;
            
            prompt += `TAPE QUALITY REQUIREMENTS:\n`;
            prompt += `- Smooth adhesion with NO wrinkles, bubbles, or lifting edges\n`;
            prompt += `- Professional application following anatomical muscle/ligament pathways\n`;
            prompt += `- Visible characteristic grid pattern on tape surface\n`;
            prompt += `- Clean-cut rounded corners on all tape ends\n`;
            prompt += `- Appropriate skin lift effect showing proper tension\n\n`;
        }
    }

    // -------------------------------------------------------------------------
    // SECTION 2: SUBJECT DESCRIPTION
    // -------------------------------------------------------------------------
    prompt += "SUBJECT: ";
    
    // Subject type with detailed description
    const hasElements = selections.elements && selections.elements.length > 0;
    if (hasElements) {
        if (selections.elements.includes('female-athlete')) {
            prompt += "Athletic female (25-35 years, fit physique, confident expression, ";
        } else if (selections.elements.includes('male-athlete')) {
            prompt += "Athletic male (25-40 years, muscular/fit physique, focused expression, ";
        } else if (selections.elements.includes('healthcare-professional')) {
            prompt += "Healthcare professional (physiotherapist/athletic trainer in clinical attire, ";
        } else {
            prompt += "Athletic individual (fit physique, ";
        }
    } else {
        prompt += "Athletic individual (fit physique, ";
    }
    
    // Add discipline-specific characteristics
    if (selections.discipline) {
        const disciplineAppearance = getDisciplineAppearance(selections.discipline);
        prompt += `${disciplineAppearance})\n\n`;
    } else {
        prompt += "professional athletic appearance)\n\n";
    }

    // -------------------------------------------------------------------------
    // SECTION 3: PRODUCT DETAILS
    // -------------------------------------------------------------------------
    prompt += "PRODUCT DETAILS:\n";
    const productDetails = getProductDetails(selections.product);
    prompt += `Product: ${productDetails.fullName}\n`;
    prompt += `Description: ${productDetails.description}\n`;
    
    if (selections.color && selections.color !== 'na') {
        const colorName = getColorDescription(selections.color);
        prompt += `Tape Color: ${colorName}\n`;
    } else {
        prompt += `Tape Color: Classic Black (default TapeGeeks color)\n`;
    }
    prompt += "\n";

    // -------------------------------------------------------------------------
    // SECTION 4: SCENE & ENVIRONMENT
    // -------------------------------------------------------------------------
    prompt += "SCENE & ENVIRONMENT:\n";
    
    const disciplineContext = getDisciplineContext(selections.discipline);
    const contentContext = getContentCategoryContext(selections.contentCategory);
    
    // Environment based on content category + discipline
    if (contentContext.environment) {
        prompt += `Setting: ${contentContext.environment}\n`;
    } else if (disciplineContext) {
        prompt += `Setting: ${disciplineContext}\n`;
    } else {
        prompt += `Setting: Professional athletic/clinical environment\n`;
    }
    
    // Activity/action
    if (hasElements && selections.elements.includes('mid-exercise')) {
        prompt += `Activity: Subject actively engaged in athletic movement\n`;
    } else if (hasElements && selections.elements.includes('applying-tape')) {
        prompt += `Activity: Demonstrating professional tape application technique\n`;
    } else {
        prompt += `Activity: Professional pose showcasing tape application\n`;
    }
    prompt += "\n";

    // -------------------------------------------------------------------------
    // SECTION 5: VISUAL STYLE & LIGHTING
    // -------------------------------------------------------------------------
    prompt += "VISUAL STYLE & LIGHTING:\n";
    
    const hasStyles = selections.styles && selections.styles.length > 0;
    if (hasStyles) {
        // Map all selected styles to visual descriptions
        if (selections.styles.includes('professional-studio')) {
            prompt += "- Professional 3-point studio lighting setup\n";
            prompt += "- Clean, controlled environment with white/gray backdrop\n";
        }
        if (selections.styles.includes('natural-lighting')) {
            prompt += "- Natural daylight, golden hour warmth\n";
            prompt += "- Soft, diffused lighting through windows or outdoors\n";
        }
        if (selections.styles.includes('clinical-medical')) {
            prompt += "- Bright, even clinical lighting\n";
            prompt += "- Clean medical/treatment room environment\n";
        }
        if (selections.styles.includes('action-motion')) {
            prompt += "- High-speed photography (1/1000s) to freeze peak action\n";
            prompt += "- Dynamic energy, movement visible in composition\n";
        }
        if (selections.styles.includes('close-up-macro')) {
            prompt += "- Macro/close-up shot with shallow depth of field (f/2.8)\n";
            prompt += "- Fine detail visible on tape texture and skin\n";
        }
        if (selections.styles.includes('lifestyle-candid')) {
            prompt += "- Documentary-style candid photography\n";
            prompt += "- Authentic, real-world environment\n";
        }
        if (selections.styles.includes('minimalist-clean')) {
            prompt += "- Minimalist composition with clean negative space\n";
            prompt += "- Focus entirely on subject and product\n";
        }
        if (selections.styles.includes('dynamic-energetic')) {
            prompt += "- Bold angles (low angle for power, dynamic composition)\n";
            prompt += "- High contrast, vibrant colors\n";
        }
    } else {
        prompt += "- Professional commercial photography lighting\n";
        prompt += "- Clean, well-lit composition\n";
    }
    prompt += "\n";

    // -------------------------------------------------------------------------
    // SECTION 6: FORMAT & COMPOSITION
    // -------------------------------------------------------------------------
    prompt += "FORMAT & COMPOSITION:\n";
    const formatSpecs = getFormatSpecs(selections.platformFormat);
    prompt += `Aspect Ratio: ${formatSpecs.ratio}\n`;
    prompt += `Dimensions: ${formatSpecs.dimensions}\n`;
    prompt += `Composition: Rule of thirds, professional framing, product/tape clearly visible\n\n`;

    // -------------------------------------------------------------------------
    // SECTION 7: TEXT OVERLAY (if applicable)
    // -------------------------------------------------------------------------
    if (selections.customText) {
        prompt += "TEXT OVERLAY:\n";
        prompt += `Text Content: "${selections.customText}"\n`;
        prompt += `Typography: Bold sans-serif font, high contrast (white with dark shadow)\n`;
        prompt += `Position: Upper third of frame, following rule of thirds\n`;
        prompt += `Ensure: Clear space in composition for text placement\n\n`;
    }

    // -------------------------------------------------------------------------
    // SECTION 8: E-COMMERCE OPTIMIZATION
    // -------------------------------------------------------------------------
    const ecommerceInjection = getEcommercePromptInjection();
    if (ecommerceInjection) {
        prompt += ecommerceInjection + "\n";
    }

    // -------------------------------------------------------------------------
    // SECTION 9: TAPEGEEKS BRAND REQUIREMENTS
    // -------------------------------------------------------------------------
    prompt += "BRAND REQUIREMENTS (TAPEGEEKS):\n";
    prompt += "- Brand: TapeGeeks - Professional Canadian Sports Medicine\n";
    prompt += "- Brand Colors: Lime Green (#C5D52E), Dark Charcoal (#1F2937)\n";
    prompt += "- Tone: Professional, trustworthy, expert - NEVER gimmicky\n";
    prompt += "- Quality: Commercial-grade photography for e-commerce, social media, medical marketing\n";
    prompt += "- Made in Canada - premium quality positioning\n\n";

    // -------------------------------------------------------------------------
    // SECTION 10: SPECIAL NOTES & FINAL DIRECTIVES
    // -------------------------------------------------------------------------
    if (selections.specialNotes) {
        prompt += `ADDITIONAL REQUIREMENTS:\n${selections.specialNotes}\n\n`;
    }

    prompt += "FINAL OUTPUT:\n";
    prompt += "- Photorealistic, publication-ready quality\n";
    prompt += "- No artifacts, distortions, or anatomical errors\n";
    prompt += "- Medically accurate tape application\n";
    prompt += "- Professional e-commerce/marketing ready\n";

    return prompt;
}

// Helper function to simplify technical taping descriptions into visual descriptions
function simplifyTapingDescription(technicalDescription) {
    let simplified = technicalDescription;

    // Convert technical patterns to visual descriptions
    simplified = simplified.replace(/VMO support.*?kneecap with.*?shin\./i,
        'black kinesiology tape in a V-pattern around the knee - one strip from inner thigh curving around the inside of kneecap down to inner shin, another strip mirroring on outer side');
    simplified = simplified.replace(/I-strip from.*?above knee.*?below knee.*?\./gi,
        'single strip of tape from above the knee, around the kneecap, ending below the knee');
    simplified = simplified.replace(/Y-strip.*?hamstring.*?buttock.*?\./gi,
        'Y-shaped tape pattern on back of thigh, with the split end at the buttock and single end behind the knee');
    simplified = simplified.replace(/two parallel.*?IT band.*?\./gi,
        'two parallel vertical strips of tape along the outer thigh from hip to knee');
    simplified = simplified.replace(/X-pattern.*?arch.*?\./gi,
        'X-shaped tape pattern on bottom of foot across the arch');

    // Remove excessive technical detail
    simplified = simplified.replace(/\b\d+-\d+ degrees? flexion\b/gi, 'slightly bent');
    simplified = simplified.replace(/\b\d+-\d+% stretch\b/gi, 'with moderate tension');
    simplified = simplified.replace(/\b50-75% stretch\b/gi, 'with firm tension');
    simplified = simplified.replace(/zero tension on.*?anchors?\.?/gi, '');
    simplified = simplified.replace(/Sport context:.*?($|\n)/gi, '');

    // Clean up body positioning to be more visual
    simplified = simplified.replace(/Body positioning?:?\s*/gi, '');
    simplified = simplified.replace(/Proper taping technique:?\s*/gi, 'Tape application: ');

    // Remove measurements
    simplified = simplified.replace(/\b\d+-\d+ inches?\b/gi, '');
    simplified = simplified.replace(/\(\d+cm\)/gi, '');

    // Simplify anatomical terms
    simplified = simplified.replace(/dorsiflexion/gi, 'foot flexed upward');
    simplified = simplified.replace(/plantarflexion/gi, 'foot pointed down');
    simplified = simplified.replace(/supination/gi, 'palm up');
    simplified = simplified.replace(/pronation/gi, 'palm down');

    // Remove parenthetical detail
    simplified = simplified.replace(/\([^)]+\)/g, '');

    // Clean up extra spaces and punctuation
    simplified = simplified.replace(/\s+/g, ' ');
    simplified = simplified.replace(/\.\s*\./g, '.');
    simplified = simplified.trim();

    return simplified;
}

// ChatGPT prompt format (structured markdown - best for text accuracy)
function generateChatGPTPrompt(selections) {
    // ============================================================================
    // Check if we have uploaded image analysis - if so, generate comprehensive prompt
    // ============================================================================
    if (currentAnalysis && currentImageData) {
        console.log('‚úì Image analysis available - generating COMPREHENSIVE ChatGPT prompt');
        return buildComprehensiveImagePrompt(selections, currentAnalysis);
    }

    console.log('No image analysis - generating standard ChatGPT prompt');
    let prompt = "# TapeGeeks Professional Image Generation\n\n";

    prompt += "## Brand Context\n";
    prompt += "TapeGeeks is a professional Canadian kinesiology tape and sports medicine brand known for quality, performance, and trust. The brand serves athletes, healthcare professionals, and active individuals across Canada.\n\n";

    // Product section
    const productDetails = getProductDetails(selections.product);
    prompt += "## Product Details\n";
    prompt += `- **Product**: ${productDetails.fullName}\n`;
    prompt += `- **Description**: ${productDetails.description}\n`;
    if (selections.color && selections.color !== 'na') {
        prompt += `- **Color**: ${selections.color.replace(/-/g, ' ')}\n`;
    }
    prompt += "\n";

    // Content category and purpose
    prompt += "## Content Type & Purpose\n";
    const contentPurpose = {
        'product': 'High-end product photography for e-commerce and marketing',
        'lifestyle': 'Lifestyle action photography showing product in real-world use',
        'educational': 'Educational instructional content demonstrating proper application technique',
        'clinical': 'Clinical application demonstration in professional healthcare setting',
        'seasonal': 'Seasonal promotional campaign imagery',
        'social': 'Social media content optimized for engagement and shareability',
        'beforeafter': 'Before/after transformation comparison',
        'testimonial': 'Testimonial and social proof with authentic user experience',
        'custom': 'Custom marketing imagery'
    };
    prompt += `${contentPurpose[selections.contentCategory] || 'Professional marketing imagery'}\n\n`;

    // Scene composition
    prompt += "## Scene Composition\n";
    const disciplineContext = getDisciplineContext(selections.discipline);
    if (disciplineContext) {
        prompt += `**Setting**: ${disciplineContext}\n\n`;
    }

    // Visual elements
    if (selections.elements && selections.elements.length > 0) {
        prompt += "**Elements to include**:\n";
        const elementDescriptions = {
            'male-athlete': '- Athletic male subject with fit physique, actively engaged',
            'female-athlete': '- Athletic female subject, strong and confident',
            'healthcare-professional': '- Healthcare professional in medical attire showing competence',
            'kinesiology-tape': '- TapeGeeks kinesiology tape visibly applied with brand colors clear',
            'nasal-strips': '- TapeGeeks Breathe Plus nasal strips clearly positioned',
            'packaging-visible': '- Product packaging with TapeGeeks logo prominently displayed',
            'applying-tape': '- Demonstration of proper tape application technique',
            'mid-exercise': '- Subject captured mid-exercise with tape supporting movement'
        };
        selections.elements.forEach(elem => {
            const desc = elementDescriptions[elem];
            if (desc) prompt += `${desc}\n`;
        });
        prompt += "\n";
    }

    // Body positioning and taping protocol for injuries (CRITICAL for accuracy)
    if (selections.injury) {
        const injuryPositioning = getInjuryPositioning(selections.injury);
        if (injuryPositioning && typeof injuryPositioning === 'string' && injuryPositioning.length > 0) {
            const injuryName = selections.injury.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            prompt += `## Kinesiology Tape Application - ${injuryName}\n`;
            prompt += `${injuryPositioning}\n\n`;
            
            prompt += "**TAPE VISUAL REQUIREMENTS (Critical)**:\n";
            prompt += "- Tape must appear smooth with NO wrinkles, bubbles, or lifting edges\n";
            prompt += "- Clean-cut edges with rounded corners on all tape ends\n";
            prompt += "- Visible characteristic grid pattern on tape surface texture\n";
            prompt += "- Proper tension visible through subtle skin lift effect\n";
            prompt += "- Anatomically correct placement following muscle/ligament pathways\n";
            prompt += "- Professional application quality throughout\n\n";
        }
    }

    // Visual style
    if (selections.styles && selections.styles.length > 0) {
        prompt += "## Visual Style\n";
        const styleDescriptions = {
            'professional-studio': 'Professional studio lighting, clean backdrop, sharp commercial focus',
            'natural-lighting': 'Natural lighting (golden hour or soft window light)',
            'action-motion': 'Dynamic action with motion blur, frozen mid-movement',
            'close-up-macro': 'Close-up macro with texture detail, selective focus',
            'lifestyle-candid': 'Authentic candid lifestyle, documentary style',
            'clinical-medical': 'Clean clinical environment, bright even medical lighting',
            'minimalist-clean': 'Minimalist aesthetic with negative space, elegant simplicity',
            'dynamic-energetic': 'Energetic composition with diagonal lines and bold angles'
        };
        selections.styles.forEach(style => {
            const desc = styleDescriptions[style];
            if (desc) prompt += `- ${desc}\n`;
        });
        prompt += "\n";
    }

    // TEXT IN IMAGE - Critical for ChatGPT
    if (selections.customText) {
        prompt += "## TEXT IN IMAGE (IMPORTANT)\n";
        prompt += `**Text to Display**: "${selections.customText}"\n\n`;
        prompt += "**Typography Requirements**:\n";
        prompt += "- Font: Clean, bold, sans-serif typeface (similar to Helvetica Bold or Montserrat Bold)\n";
        prompt += "- Size: Large enough to read on mobile devices\n";
        prompt += "- Position: Upper third of image, well-balanced with composition\n";
        prompt += "- Color: High contrast with background\n";
        prompt += "  - Use white text with dark stroke/shadow on light backgrounds\n";
        prompt += "  - Use solid white or light text on dark backgrounds\n";
        prompt += "- Style: Professional and clean, never decorative or script fonts\n";
        prompt += "- Ensure text is perfectly legible and spelled EXACTLY as shown above\n\n";
    }

    // Format and technical specs
    const formatGuidance = getFormatGuidance(selections.platformFormat);
    prompt += "## Format & Technical Specifications\n";
    prompt += `${formatGuidance}\n\n`;

    // Lighting and atmosphere
    prompt += "## Lighting & Atmosphere\n";
    if (selections.discipline === 'sleep') {
        prompt += "Soft, warm, calming atmosphere in bedroom setting. Peaceful evening or morning light with gentle shadows creating cozy feeling.\n\n";
    } else if (selections.discipline === 'healthcare') {
        prompt += "Professional clinical lighting - bright, even, clean. Medical facility atmosphere that conveys credibility and trust.\n\n";
    } else if (selections.styles && selections.styles.includes('action-motion')) {
        prompt += "High-energy dramatic lighting with strong highlights and shadows. Capture the intensity and power of athletic performance.\n\n";
    } else {
        prompt += "Professional balanced lighting that showcases the product as premium quality and makes the overall scene look polished and campaign-ready.\n\n";
    }

    // E-commerce optimization (Amazon/Shopify requirements)
    const ecommerceInjection = getEcommercePromptInjection();
    if (ecommerceInjection) {
        prompt += "## E-Commerce Optimization\n";
        prompt += ecommerceInjection + "\n\n";
    }

    // Brand aesthetic
    prompt += "## Brand Aesthetic Guidelines (TapeGeeks)\n";
    prompt += "- **Brand**: TapeGeeks - Professional Canadian Sports Medicine Company\n";
    prompt += "- **Brand Colors**: Lime Green (#C5D52E), Dark Charcoal (#1F2937)\n";
    prompt += "- **Tone**: Professional, trustworthy, performance-focused, expert\n";
    prompt += "- **Mood**: Confident and capable - NEVER gimmicky or amateur\n";
    prompt += "- **Values**: Real people, real performance, real results, Made in Canada excellence\n";
    prompt += "- **Quality**: High-end commercial photography for e-commerce, social media, medical marketing\n";
    prompt += "- **Audience**: Healthcare professionals, elite athletes, recreational athletes, parents\n\n";

    // Special notes
    if (selections.specialNotes) {
        prompt += "## Additional Requirements\n";
        prompt += `${selections.specialNotes}\n\n`;
    }

    // Final direction with quality standards
    prompt += "## Final Direction & Quality Standards\n";
    prompt += "Create an image that meets professional marketing agency standards:\n";
    prompt += "- Photorealistic quality - NOT illustrated or cartoon\n";
    prompt += "- Publication-ready with no artifacts or distortions\n";
    prompt += "- Anatomically correct human subjects\n";
    prompt += "- Medically accurate tape application (if shown)\n";
    prompt += "- Compelling enough to stop the scroll on social media\n";
    prompt += "- E-commerce conversion ready for Amazon/Shopify listings\n";
    prompt += "- Suitable for TapeGeeks official marketing use\n";

    return prompt;
}

// Perplexity prompt format (concise, focused, research-oriented with clear directives)
function generatePerplexityPrompt(selections) {
    let prompt = "Generate a professional marketing image for TapeGeeks based on these specifications:\n\n";

    // Brand and product information
    const productDetails = getProductDetails(selections.product);
    prompt += `**Brand:** TapeGeeks - Professional Canadian kinesiology tape and sports medicine brand\n\n`;
    prompt += `**Product:** ${productDetails.fullName}\n`;
    prompt += `**Description:** ${productDetails.description}\n`;
    if (selections.color && selections.color !== 'na') {
        prompt += `**Color:** ${selections.color.replace(/-/g, ' ')}\n`;
    }
    prompt += "\n";

    // Content purpose
    const contentPurpose = {
        'product': 'High-quality product photography for e-commerce',
        'lifestyle': 'Lifestyle action photography showing real-world use',
        'educational': 'Educational demonstration of proper application',
        'clinical': 'Clinical application in professional healthcare setting',
        'seasonal': 'Seasonal promotional campaign imagery',
        'social': 'Social media engagement content',
        'beforeafter': 'Before/after transformation comparison',
        'testimonial': 'User testimonial and social proof',
        'custom': 'Custom marketing imagery'
    };
    prompt += `**Purpose:** ${contentPurpose[selections.contentCategory] || 'Professional marketing'}\n\n`;

    // Target audience and scene
    const disciplineContext = getDisciplineContext(selections.discipline);
    if (disciplineContext) {
        prompt += `**Scene Setting:** ${disciplineContext}\n\n`;
    }

    // Visual elements
    if (selections.elements && selections.elements.length > 0) {
        prompt += "**Include in Frame:**\n";
        const elementDescriptions = {
            'male-athlete': '- Athletic male subject in action',
            'female-athlete': '- Athletic female subject demonstrating movement',
            'healthcare-professional': '- Healthcare professional showing application',
            'kinesiology-tape': '- TapeGeeks kinesiology tape clearly visible',
            'nasal-strips': '- TapeGeeks Breathe Plus nasal strips',
            'packaging-visible': '- Product packaging with logo visible',
            'applying-tape': '- Step-by-step application technique',
            'mid-exercise': '- Subject mid-exercise with tape supporting movement'
        };
        selections.elements.forEach(elem => {
            const desc = elementDescriptions[elem];
            if (desc) prompt += `${desc}\n`;
        });
        prompt += "\n";
    }

    // Injury-specific positioning and taping technique
    if (selections.injury) {
        const injuryPositioning = getInjuryPositioning(selections.injury);
        if (injuryPositioning) {
            prompt += `**Body Positioning & Taping Technique:**\n${injuryPositioning}\n\n`;
        }
    }

    // Visual style directives
    if (selections.styles && selections.styles.length > 0) {
        prompt += "**Visual Style:**\n";
        const styleDescriptions = {
            'professional-studio': '- Professional studio lighting with clean backdrop',
            'natural-lighting': '- Natural golden hour or window lighting',
            'action-motion': '- Dynamic motion with energy and movement',
            'close-up-macro': '- Macro detail with selective focus',
            'lifestyle-candid': '- Authentic candid documentary style',
            'clinical-medical': '- Clean clinical medical environment',
            'minimalist-clean': '- Minimalist with negative space',
            'dynamic-energetic': '- Bold angles and high-energy composition'
        };
        selections.styles.forEach(style => {
            const desc = styleDescriptions[style];
            if (desc) prompt += `${desc}\n`;
        });
        prompt += "\n";
    }

    // Custom text overlay
    if (selections.customText) {
        prompt += `**TEXT OVERLAY (Critical):**\n`;
        prompt += `Display: "${selections.customText}"\n`;
        prompt += `Font: Bold sans-serif, highly legible\n`;
        prompt += `Position: Upper third of frame\n`;
        prompt += `Contrast: High contrast against background\n\n`;
    }

    // Format specifications
    const formatGuidance = getFormatGuidance(selections.platformFormat);
    prompt += `**Format Requirements:**\n${formatGuidance}\n\n`;

    // Lighting and mood
    prompt += "**Lighting & Atmosphere:**\n";
    if (selections.discipline === 'sleep') {
        prompt += "Soft, warm, calming bedroom atmosphere with peaceful lighting\n\n";
    } else if (selections.discipline === 'healthcare') {
        prompt += "Professional clinical lighting - bright, even, trustworthy medical setting\n\n";
    } else if (selections.styles && selections.styles.includes('action-motion')) {
        prompt += "High-energy dramatic lighting capturing athletic intensity\n\n";
    } else {
        prompt += "Professional balanced lighting for premium quality appearance\n\n";
    }

    // Brand guidelines
    prompt += "**Brand Guidelines:**\n";
    prompt += "- TapeGeeks is a professional, performance-focused Canadian brand\n";
    prompt += "- Tone: Confident, trustworthy, never gimmicky\n";
    prompt += "- Quality: Commercial-grade professional photography\n";
    prompt += "- Authenticity: Real people, real performance, real results\n\n";

    // E-commerce optimization
    const ecommerceInjection = getEcommercePromptInjection();
    if (ecommerceInjection) {
        prompt += ecommerceInjection + "\n\n";
    }

    // Special requirements
    if (selections.specialNotes) {
        prompt += `**Special Requirements:** ${selections.specialNotes}\n\n`;
    }

    // Final directive
    prompt += "**Output:** Create a polished, professional marketing image optimized for e-commerce (Amazon, Shopify) and social media that demonstrates expertise in sports medicine and builds trust with both athletes and healthcare professionals.";

    return prompt;
}

// Midjourney prompt format (keywords + parameters - best for artistic control)
function generateMidjourneyPrompt(selections) {
    let keywords = [];

    // TapeGeeks brand identifier
    keywords.push('TapeGeeks professional sports medicine brand');
    
    // Start with subject and product
    const productDetails = getProductDetails(selections.product);
    keywords.push(productDetails.fullName);

    if (selections.color && selections.color !== 'na' && selections.color !== 'custom-color') {
        keywords.push(getColorDescription(selections.color).split(' - ')[0] + ' kinesiology tape');
    }
    
    // CRITICAL: Injury-specific taping protocol keywords
    if (selections.injury) {
        const injuryPositioning = getInjuryPositioning(selections.injury);
        if (injuryPositioning && typeof injuryPositioning === 'string' && injuryPositioning.length > 0) {
            const injuryName = selections.injury.replace(/-/g, ' ');
            keywords.push(`kinesiology tape applied for ${injuryName}`);
            // Extract first part of positioning for brief description
            const positionBrief = injuryPositioning.split('\n')[0].split(',')[0] || 'proper athletic position';
            keywords.push(`athlete in ${positionBrief}`);
            keywords.push('professional tape application');
            keywords.push('smooth tape adhesion no wrinkles');
            keywords.push('anatomically correct placement');
        }
    }

    // Content type and mood
    const contentKeywords = {
        'product': 'professional product photography, commercial quality, studio shot, hero product',
        'lifestyle': 'lifestyle action photography, real athletes, dynamic movement, authentic',
        'educational': 'instructional application, step-by-step technique, educational',
        'clinical': 'clinical application, medical setting, healthcare professional, trustworthy',
        'seasonal': 'promotional campaign, seasonal marketing, eye-catching, conversion-focused',
        'social': 'social media content, scroll-stopping, engagement-focused, shareable',
        'beforeafter': 'before after comparison, transformation, split image, dramatic improvement',
        'testimonial': 'testimonial photo, social proof, authentic user, relatable',
        'custom': 'custom marketing content'
    };
    keywords.push(contentKeywords[selections.contentCategory] || 'professional marketing');

    // Discipline-specific environment
    const disciplineKeywords = {
        'healthcare': 'clinical setting, medical office, professional healthcare environment',
        'running': 'outdoor running track, athletic performance, runner in motion',
        'strength': 'CrossFit gym, weightlifting, power athlete, gritty gym atmosphere',
        'team-sports': 'sports field, team athlete, competitive environment',
        'endurance': 'endurance sport setting, long-distance athlete',
        'other-sports': 'athletic environment, sport-specific setting',
        'sleep': 'peaceful bedroom, calm atmosphere, restful sleep environment',
        'fitness': 'fitness center, workout environment, active lifestyle',
        'recovery': 'rehabilitation setting, recovery process'
    };
    if (selections.discipline && disciplineKeywords[selections.discipline]) {
        keywords.push(disciplineKeywords[selections.discipline]);
    }

    // Visual style keywords
    if (selections.styles && selections.styles.length > 0) {
        const styleMappings = {
            'professional-studio': 'professional studio lighting, white backdrop, sharp focus',
            'natural-lighting': 'natural lighting, golden hour, soft window light',
            'action-motion': 'motion blur, frozen action, dynamic movement, high shutter speed',
            'close-up-macro': 'macro photography, extreme detail, shallow depth of field',
            'lifestyle-candid': 'candid moment, documentary style, authentic',
            'clinical-medical': 'clinical photography, medical lighting, clean environment',
            'minimalist-clean': 'minimalist composition, negative space, clean aesthetic',
            'dynamic-energetic': 'dynamic angle, diagonal composition, high energy'
        };
        selections.styles.forEach(style => {
            if (styleMappings[style]) keywords.push(styleMappings[style]);
        });
    }

    // Image elements
    if (selections.elements && selections.elements.length > 0) {
        const elementMappings = {
            'male-athlete': 'athletic male subject, fit physique',
            'female-athlete': 'athletic female subject, strong',
            'healthcare-professional': 'healthcare professional in scrubs',
            'kinesiology-tape': 'kinesiology tape application visible',
            'nasal-strips': 'nasal strips clearly shown',
            'packaging-visible': 'product packaging with logo',
            'applying-tape': 'hands applying tape, application technique',
            'mid-exercise': 'mid-exercise, active movement'
        };
        selections.elements.forEach(elem => {
            if (elementMappings[elem]) keywords.push(elementMappings[elem]);
        });
    }

    // E-commerce optimization keywords
    const ecommerceState = currentEcommercePlatform;
    if (ecommerceState === 'amazon') {
        const whiteBackground = document.getElementById('whiteBackgroundToggle')?.checked;
        if (whiteBackground) {
            keywords.push('pure white background #FFFFFF');
            keywords.push('product fills 85% of frame');
            keywords.push('Amazon main image compliant');
        }
        keywords.push('e-commerce ready');
        keywords.push('2000x2000 pixels ready');
    } else if (ecommerceState === 'shopify') {
        keywords.push('e-commerce product photography');
        keywords.push('Shopify store ready');
        keywords.push('conversion optimized');
    }

    // Photography quality keywords - Latest standards
    keywords.push('hyperrealistic photorealistic');
    keywords.push('professional commercial photography');
    keywords.push('publication quality');
    keywords.push('8K detail');
    keywords.push('Canon EOS R5 85mm f/1.4');
    keywords.push('perfect skin texture');
    keywords.push('studio quality');
    
    // TapeGeeks brand essence
    keywords.push('Canadian sports medicine brand');
    keywords.push('professional trustworthy quality');

    // Combine all keywords
    let prompt = keywords.join(', ');

    // Add Midjourney parameters - Complete format mapping including e-commerce
    const aspectRatios = {
        // Social Media
        'instagram-square': '1:1',
        'instagram-portrait': '4:5',
        'instagram-story': '9:16',
        'facebook': '16:9',
        'pinterest': '2:3',
        'website-hero': '21:9',
        'product-page': '1:1',
        'tiktok': '9:16',
        'email': '3:1',
        'linkedin': '1.91:1',
        'twitter': '16:9',
        'youtube': '16:9',
        // Amazon formats
        'amazon-main': '1:1',
        'amazon-lifestyle': '1:1',
        'amazon-infographic': '1:1',
        'amazon-feature': '1:1',
        'amazon-size': '1:1',
        'amazon-package': '1:1',
        'amazon-aplus-hero': '97:60',
        'amazon-aplus-quad': '1:1',
        'amazon-store-hero': '3:1',
        // Shopify formats
        'shopify-product': '1:1',
        'shopify-collection': '1:1',
        'shopify-banner': '2:1',
        'shopify-lifestyle': '4:3',
        'shopify-square': '1:1',
        'shopify-mobile': '2:3',
        // Default
        'custom-format': '1:1'
    };
    prompt += ` --ar ${aspectRatios[selections.platformFormat] || '1:1'}`;

    // Quality and version
    prompt += ' --style raw';
    prompt += ' --v 6';
    prompt += ' --quality 2';

    // Stylize parameter for more/less artistic interpretation
    if (selections.contentCategory === 'product' || selections.contentCategory === 'clinical') {
        prompt += ' --stylize 50'; // More literal/photographic
    } else {
        prompt += ' --stylize 150'; // More artistic
    }

    // Text overlay note (Midjourney doesn't have --text parameter in v6)
    if (selections.customText) {
        prompt = `text overlay "${selections.customText}" in bold sans-serif, ` + prompt;
    }

    return prompt;
}

// Sora 2 prompt format (video-first, then extract still)
function generateSora2Prompt(selections) {
    let prompt = "Create a professional video sequence for TapeGeeks. ";

    const productDetails = getProductDetails(selections.product);
    prompt += `The focus is ${productDetails.fullName}`;
    if (selections.color && selections.color !== 'na') {
        prompt += ` in ${selections.color.replace(/-/g, ' ')}`;
    }
    prompt += `. `;

    // Video sequence description
    const videoSequences = {
        'product': 'Smooth 360-degree product rotation on clean background, with gentle lighting that highlights the product quality. Camera slowly orbits the product.',
        'lifestyle': 'Dynamic sequence showing athlete in action - warm-up, preparation, then intense movement with the product in use. Smooth camera tracking.',
        'educational': 'Step-by-step application sequence: prep the area, measure the tape, apply with proper tension, smooth and activate. Clear, steady camera work.',
        'clinical': 'Professional healthcare setting: practitioner evaluates, prepares product, applies with expert technique. Documentary-style steady cam.',
        'seasonal': 'Seasonal environment establishing shot, product reveal, lifestyle use showing seasonal context. Cinematic camera movement.',
        'social': 'Quick dynamic cuts: product reveal, action shots, results. Fast-paced editing style with smooth transitions.',
        'beforeafter': 'Before state, application process, after state with visible improvement. Steady camera, clear comparison.',
        'testimonial': 'User talking to camera, demonstrating product use, showing results. Natural documentary style.',
        'custom': 'Custom video sequence showcasing the product in its intended context.'
    };
    prompt += `\n\nVideo sequence: ${videoSequences[selections.contentCategory] || videoSequences['custom']} `;

    // Setting and atmosphere
    const disciplineContext = getDisciplineContext(selections.discipline);
    if (disciplineContext) {
        prompt += `\n\nSetting: ${disciplineContext} `;
    }

    // Camera and motion details
    prompt += `\n\nCamera: Professional cinematic camera work. `;
    if (selections.styles && selections.styles.includes('action-motion')) {
        prompt += `Use fast shutter speed to freeze peak action moments, with dramatic camera angles and dynamic movement. `;
    } else if (selections.contentCategory === 'product') {
        prompt += `Smooth, slow, controlled camera movement. Think Apple product launch quality. `;
    } else {
        prompt += `Natural, professional camera work that follows the action smoothly. `;
    }

    // Lighting for video
    prompt += `\n\nLighting: `;
    if (selections.discipline === 'sleep') {
        prompt += `Soft, warm, calming light - golden hour or warm bedroom lighting. Gentle shadows. `;
    } else if (selections.discipline === 'healthcare') {
        prompt += `Clean, bright, professional medical lighting. Even illumination, no harsh shadows. `;
    } else {
        prompt += `Professional balanced lighting that looks polished and high-end. Natural or studio quality. `;
    }

    // Still extraction instruction
    prompt += `\n\nExtract still frame at peak moment: `;
    if (selections.elements && selections.elements.includes('mid-exercise')) {
        prompt += `Freeze frame at moment of peak athletic action with tape clearly visible. `;
    } else if (selections.elements && selections.elements.includes('applying-tape')) {
        prompt += `Freeze frame showing hands mid-application with proper technique visible. `;
    } else {
        prompt += `Extract the most compelling frame that showcases the product at its best. `;
    }

    // Format
    const formatGuidance = getFormatGuidance(selections.platformFormat);
    prompt += `\n\n${formatGuidance}`;

    if (selections.customText) {
        prompt += `\n\nText overlay: "${selections.customText}" should appear as professional graphic overlay.`;
    }

    if (selections.specialNotes) {
        prompt += `\n\nSpecial notes: ${selections.specialNotes}`;
    }

    return prompt;
}

// Grok prompt format (xAI - technical specifications)
function generateGrokPrompt(selections) {
    let prompt = "TECHNICAL SPECIFICATIONS FOR IMAGE GENERATION\n\n";

    prompt += "SUBJECT:\n";
    const productDetails = getProductDetails(selections.product);
    prompt += `Primary Subject: ${productDetails.fullName}\n`;
    prompt += `Product Category: Sports medicine / Kinesiology tape\n`;
    prompt += `Brand: TapeGeeks (Canadian brand)\n`;
    if (selections.color && selections.color !== 'na') {
        prompt += `Color: ${selections.color.replace(/-/g, ' ')}\n`;
    }
    prompt += "\n";

    prompt += "SCENE PARAMETERS:\n";
    prompt += `Content Type: ${selections.contentCategory}\n`;
    const disciplineContext = getDisciplineContext(selections.discipline);
    if (disciplineContext) {
        prompt += `Environment: ${disciplineContext}\n`;
    }
    prompt += "\n";

    prompt += "VISUAL SPECIFICATIONS:\n";
    if (selections.styles && selections.styles.length > 0) {
        prompt += "Style Modifiers:\n";
        selections.styles.forEach((style, index) => {
            prompt += `  ${index + 1}. ${style.replace(/-/g, ' ')}\n`;
        });
    }
    if (selections.elements && selections.elements.length > 0) {
        prompt += "Required Elements:\n";
        selections.elements.forEach((elem, index) => {
            prompt += `  ${index + 1}. ${elem.replace(/-/g, ' ')}\n`;
        });
    }
    prompt += "\n";

    prompt += "TECHNICAL IMAGE PARAMETERS:\n";
    const formatSpecs = getFormatSpecs(selections.platformFormat);
    prompt += `Aspect Ratio: ${formatSpecs.ratio}\n`;
    prompt += `Dimensions: ${formatSpecs.dimensions}\n`;
    prompt += `Resolution: High (minimum 300 DPI equivalent)\n`;
    prompt += `Color Space: sRGB\n`;
    prompt += `Bit Depth: 8-bit per channel minimum\n`;
    prompt += "\n";

    prompt += "PHYSICS AND REALISM:\n";
    prompt += "Body Mechanics: Anatomically correct positioning\n";
    prompt += "Tape Physics: Realistic adhesive conform to skin contours\n";
    prompt += "Lighting Physics: Accurate light behavior, proper shadows and reflections\n";
    if (selections.injury) {
        const injuryPositioning = getInjuryPositioning(selections.injury);
        if (injuryPositioning) {
            prompt += `Body Position: ${injuryPositioning}\n`;
        }
    }
    prompt += "\n";

    prompt += "OPTICAL PARAMETERS:\n";
    if (selections.styles && selections.styles.includes('close-up-macro')) {
        prompt += "Focal Length: 100mm macro equivalent\n";
        prompt += "Aperture: f/2.8 for shallow DOF\n";
        prompt += "Focus: Selective focus on product detail\n";
    } else if (selections.styles && selections.styles.includes('action-motion')) {
        prompt += "Shutter Speed: 1/1000s to freeze motion\n";
        prompt += "Focal Length: 70-200mm for compression\n";
        prompt += "Aperture: f/4 for subject isolation\n";
    } else {
        prompt += "Focal Length: 50mm standard\n";
        prompt += "Aperture: f/5.6 for balanced depth\n";
        prompt += "Focus: Sharp across subject\n";
    }
    prompt += "\n";

    if (selections.customText) {
        prompt += "TEXT OVERLAY SPECIFICATIONS:\n";
        prompt += `Text Content: "${selections.customText}"\n`;
        prompt += "Typography: Sans-serif, bold weight, high contrast\n";
        prompt += "Position: Rule of thirds, upper third placement\n";
        prompt += "Legibility: Minimum 14pt equivalent at final size\n";
        prompt += "\n";
    }

    prompt += "QUALITY REQUIREMENTS:\n";
    prompt += "Realism Level: Photorealistic\n";
    prompt += "Detail Level: High commercial quality\n";
    prompt += "Brand Alignment: Professional Canadian sports medicine brand\n";
    prompt += "Output Quality: Publication-ready\n";

    if (selections.specialNotes) {
        prompt += `\nADDITIONAL REQUIREMENTS:\n${selections.specialNotes}\n`;
    }

    return prompt;
}

// Pollinations.ai prompt format - optimized for Flux model
// IMPORTANT: Pollinations needs simple prompts without special characters
function generatePollinationsPrompt(selections) {
    // CRITICAL: Pollinations FREE service is EXTREMELY restrictive
    // ONLY "bandage roll" works - adding colors or modifiers FAILS!
    // For better results, use ChatGPT/DALL-E or Midjourney with API keys
    
    // Map products to simplest working prompts
    const safeProductNames = {
        'kt-standard': 'bandage roll',
        'kt-bulk': 'bandage roll',
        'kt-precut': 'bandage strips',
        'kt-sensitive': 'bandage',
        'kt-pro': 'bandage roll',
        'nasal-adult': 'nose strips',
        'nasal-large': 'nose strips',
        'nasal-kids-sm': 'nose strips',
        'nasal-kids-md': 'nose strips',
        'scissors-kt': 'scissors',
        'scissors-trauma': 'scissors',
        'tape-weightlifting': 'wrap',
        'tape-adhesive': 'wrap',
        'tape-cohesive': 'wrap',
        'bundle': 'fitness gear'
    };
    
    // Use ONLY the base product name - NO colors, NO modifiers
    const prompt = safeProductNames[selections.product] || 'bandage roll';
    
    console.log('Pollinations Prompt (simplified):', prompt);
    console.log('NOTE: Pollinations FREE service has strict content filters.');
    console.log('For customized product images, use ChatGPT/DALL-E or Midjourney.');
    
    return prompt;
}

// Hugging Face FLUX prompt format - optimized for FLUX.1-schnell model
// This is a FREE service with good quality and CORS support
function generateHuggingFacePrompt(selections) {
    const productDetails = getProductDetails(selections.product);
    const injuryPositioning = getInjuryPositioning(selections.injury);
    
    let promptParts = [];
    
    // Start with product description
    if (productDetails) {
        promptParts.push(`professional product photography of ${productDetails.fullName}`);
    }
    
    // Add color
    if (selections.color && selections.color !== 'na') {
        const colorName = selections.color.replace(/-/g, ' ');
        promptParts.push(`${colorName} colored`);
    }
    
    // Add injury/application context
    if (injuryPositioning && injuryPositioning.position) {
        promptParts.push(`applied for ${injuryPositioning.position}`);
    }
    
    // Add content type context
    const contentTypes = {
        'product': 'clean studio product shot',
        'lifestyle': 'lifestyle action scene',
        'educational': 'instructional demonstration',
        'clinical': 'clinical professional setting',
        'social': 'social media style',
        'beforeafter': 'comparison style'
    };
    if (selections.contentType && contentTypes[selections.contentType]) {
        promptParts.push(contentTypes[selections.contentType]);
    }
    
    // Add background based on platform
    if (selections.whiteBackground || (selections.ecommercePlatform === 'amazon' && selections.imageType === 'main')) {
        promptParts.push('pure white background, studio lighting');
    } else {
        promptParts.push('professional studio setting');
    }
    
    // Add quality keywords
    promptParts.push('8k resolution, sharp focus, commercial photography, professional lighting');
    
    const prompt = promptParts.join(', ');
    
    console.log('Hugging Face Prompt:', prompt);
    return prompt;
}

// Krea prompt format (realtime generation - simplified)
function generateKreaPrompt(selections) {
    let prompt = "";

    // Krea works best with concise, clear descriptions
    const productDetails = getProductDetails(selections.product);
    prompt += `${productDetails.fullName}`;

    if (selections.color && selections.color !== 'na') {
        prompt += `, ${selections.color.replace(/-/g, ' ')} color`;
    }

    // Content type
    const contentShort = {
        'product': 'product shot',
        'lifestyle': 'lifestyle action',
        'educational': 'instructional',
        'clinical': 'clinical demo',
        'seasonal': 'promo',
        'social': 'social media',
        'beforeafter': 'before/after',
        'testimonial': 'testimonial',
        'custom': 'marketing'
    };
    prompt += `, ${contentShort[selections.contentCategory] || 'marketing'}`;

    // Discipline environment (concise)
    const disciplineShort = {
        'healthcare': 'medical clinic',
        'running': 'running outdoors',
        'strength': 'CrossFit gym',
        'team-sports': 'sports field',
        'endurance': 'endurance sport',
        'other-sports': 'athletic setting',
        'sleep': 'bedroom peaceful',
        'fitness': 'fitness center',
        'recovery': 'rehab setting'
    };
    if (selections.discipline && disciplineShort[selections.discipline]) {
        prompt += `, ${disciplineShort[selections.discipline]}`;
    }

    // Top 2-3 most important styles only
    if (selections.styles && selections.styles.length > 0) {
        const topStyles = selections.styles.slice(0, 3).map(s => s.replace(/-/g, ' ')).join(', ');
        prompt += `, ${topStyles}`;
    }

    // Key elements (concise)
    if (selections.elements && selections.elements.length > 0) {
        const keyElements = selections.elements.slice(0, 3).map(e => e.replace(/-/g, ' ')).join(', ');
        prompt += `, ${keyElements}`;
    }

    // General quality
    prompt += ', professional photography, high quality';

    // Custom text
    if (selections.customText) {
        prompt += `, text "${selections.customText}"`;
    }

    // Aspect ratio note
    const formatSpecs = getFormatSpecs(selections.platformFormat);
    prompt += `, ${formatSpecs.ratio} aspect ratio`;

    return prompt;
}

// Sora Original prompt format (video-to-still)
function generateSoraPrompt(selections) {
    let prompt = "Generate a cinematic video sequence for TapeGeeks brand. ";

    const productDetails = getProductDetails(selections.product);
    prompt += `The scene features ${productDetails.fullName}`;
    if (selections.color && selections.color !== 'na') {
        prompt += ` in ${selections.color.replace(/-/g, ' ')}`;
    }
    prompt += `. `;

    // Scene and narrative
    const disciplineContext = getDisciplineContext(selections.discipline);
    if (disciplineContext) {
        prompt += `The setting is ${disciplineContext.toLowerCase()}. `;
    }

    // Motion and action
    if (selections.elements && selections.elements.includes('mid-exercise')) {
        prompt += `The camera captures an athlete in natural, fluid motion - showing the product supporting them through dynamic movement. `;
    } else if (selections.elements && selections.elements.includes('applying-tape')) {
        prompt += `Hands carefully and skillfully apply the product, showing professional technique in deliberate, smooth movements. `;
    } else if (selections.contentCategory === 'product') {
        prompt += `The camera slowly reveals the product with elegant, controlled movement that showcases its quality and design. `;
    } else {
        prompt += `Natural, authentic movement that tells a story about the product in use. `;
    }

    // Cinematic style
    prompt += `\n\nCinematic style: `;
    if (selections.styles && selections.styles.includes('action-motion')) {
        prompt += `High-energy sports cinematography with dramatic angles and dynamic camera movement. Think Nike commercial quality. `;
    } else if (selections.styles && selections.styles.includes('minimalist-clean')) {
        prompt += `Minimal, elegant cinematography with clean composition and purposeful camera movement. Think Apple aesthetic. `;
    } else if (selections.discipline === 'healthcare') {
        prompt += `Professional medical documentary style - steady, clear, trustworthy cinematography. `;
    } else {
        prompt += `Professional commercial cinematography with polished, high-end production value. `;
    }

    // Lighting atmosphere
    prompt += `\n\nLighting: `;
    if (selections.discipline === 'sleep') {
        prompt += `Soft, warm, intimate lighting creating a peaceful, calming atmosphere. `;
    } else if (selections.styles && selections.styles.includes('natural-lighting')) {
        prompt += `Beautiful natural light - golden hour sunshine or soft diffused daylight. `;
    } else {
        prompt += `Professional balanced lighting that makes everything look premium and polished. `;
    }

    // Extract moment
    prompt += `\n\nExtract the perfect still frame that captures the essence of this moment - composition balanced, action frozen at peak, lighting optimal. `;

    const formatSpecs = getFormatSpecs(selections.platformFormat);
    prompt += `Output as ${formatSpecs.ratio} aspect ratio, ${formatSpecs.dimensions} resolution. `;

    if (selections.customText) {
        prompt += `\n\nInclude text overlay "${selections.customText}" integrated naturally into the composition.`;
    }

    if (selections.specialNotes) {
        prompt += `\n\nAdditional requirements: ${selections.specialNotes}`;
    }

    prompt += `\n\nThe final frame should look like it came from a high-end TapeGeeks commercial - professional, compelling, on-brand.`;

    return prompt;
}

// Generate captions
function generateCaptions(selections) {
    console.log('=== generateCaptions START ===');
    console.log('Using image analysis:', currentAnalysis ? 'YES' : 'NO');
    console.log('Selected variation:', window.selectedVariationIndex !== null ? window.selectedVariationIndex : 'NONE');

    const captions = [];

    // Context-aware caption generation
    const context = buildCaptionContext(selections);

    // Generate 10 unique caption variations
    captions.push(generateEducationalCaption(selections, context, 0));
    captions.push(generateMotivationalCaption(selections, context, 0));
    captions.push(generateEducationalCaption(selections, context, 1));
    captions.push(generateSocialProofCaption(selections, context));
    captions.push(generateMotivationalCaption(selections, context, 1));
    captions.push(generateProblemSolutionCaption(selections, context));
    captions.push(generateStorytellingCaption(selections, context));
    captions.push(generateQuestionCaption(selections, context));
    captions.push(generateBenefitsCaption(selections, context));
    captions.push(generateCallToActionCaption(selections, context));

    console.log('Generated', captions.length, 'captions');
    console.log('=== generateCaptions END ===');

    return captions;
}

// Build context object for caption generation
function buildCaptionContext(selections) {
    const context = {
        hasImageAnalysis: currentAnalysis !== null,
        discipline: selections.discipline || 'general athletics',
        injury: selections.injury || '',
        product: selections.product || 'kinesiology tape',
        color: selections.color || '',
        style: selections.captionStyle || 'educational',
        mood: currentAnalysis ? currentAnalysis.mood : 'professional',
        visualStyle: currentAnalysis ? currentAnalysis.style : 'standard',
        temperature: currentAnalysis ? currentAnalysis.temperature.description : 'balanced'
    };

    // Add discipline-specific context
    if (selections.discipline === 'running') {
        context.audience = 'runners';
        context.activity = 'running';
        context.goal = 'improve performance and prevent injury';
    } else if (selections.discipline === 'strength') {
        context.audience = 'athletes';
        context.activity = 'training';
        context.goal = 'lift heavier and recover faster';
    } else if (selections.discipline === 'healthcare') {
        context.audience = 'healthcare professionals';
        context.activity = 'patient treatment';
        context.goal = 'provide effective therapeutic support';
    } else if (selections.discipline === 'sleep') {
        context.audience = 'better sleep seekers';
        context.activity = 'improving sleep quality';
        context.goal = 'breathe easier and sleep better';
    } else {
        context.audience = 'athletes and active individuals';
        context.activity = 'staying active';
        context.goal = 'perform at your best';
    }

    return context;
}

// Caption Type 1: Educational
function generateEducationalCaption(selections, context, variant) {
    if (variant === 0) {
        if (context.injury) {
            return `How to tape ${context.injury} properly üéØ

Step 1: Clean and dry the area
Step 2: Apply ${context.product} with proper tension
Step 3: Smooth edges to activate adhesive

Lasts 5-7 days through workouts, showers, and sweat! üí™

Used by ${context.audience} across Canada.

#TapeGeeks #KinesiologyTape #${context.discipline.charAt(0).toUpperCase() + context.discipline.slice(1)}`;
        } else {
            return `Professional taping technique guide üìã

‚úÖ Why it works: Supports muscles without restricting movement
‚úÖ When to use: Before/during/after ${context.activity}
‚úÖ How long: 5-7 days of continuous support

TapeGeeks ${context.product} - trusted by ${context.audience}.

#TapeGeeks #ProTips #InjuryPrevention`;
        }
    } else {
        return `3 things you didn't know about kinesiology tape:

1Ô∏è‚É£ It lifts skin to improve blood flow and reduce inflammation
2Ô∏è‚É£ Works 24/7 - even while you sleep
3Ô∏è‚É£ Medical-grade adhesive that's gentle on skin

TapeGeeks ${context.product}: Professional-grade support for ${context.audience}.

#TapeGeeks #EducateYourself #SportsScience`;
    }
}

// Caption Type 2: Motivational
function generateMotivationalCaption(selections, context, variant) {
    if (variant === 0) {
        return `Don't let ${context.injury || 'pain'} stop your progress üî•

Every champion needs support. Every goal needs a plan.

TapeGeeks is your partner in ${context.activity}.

${context.goal.charAt(0).toUpperCase() + context.goal.slice(1)} with confidence.

Made in Canada. Trusted by professionals. Built for ${context.audience}.

#TapeGeeks #NoExcuses #KeepGoing`;
    } else {
        return `Strong. Supported. Unstoppable. üí™

That's what happens when you combine your determination with professional-grade support.

TapeGeeks ${context.product} - because your goals don't take days off.

#TapeGeeks #AthleteLife #NeverSettle`;
    }
}

// Caption Type 3: Social Proof
function generateSocialProofCaption(selections, context) {
    return `"Why didn't I discover this sooner?"

That's what most ${context.audience} say after trying TapeGeeks.

‚úÖ Trusted by Canadian healthcare professionals
‚úÖ Used by serious athletes nationwide
‚úÖ Proven results for ${context.injury || 'injury prevention and recovery'}

Join thousands who've made the switch.

#TapeGeeks #TrustedByPros #MadeInCanada`;
}

// Caption Type 4: Problem-Solution
function generateProblemSolutionCaption(selections, context) {
    let problem = `Tired of ${context.injury || 'recurring injuries'} slowing you down?`;

    if (context.discipline === 'sleep') {
        problem = 'Struggling with poor sleep and breathing issues?';
    } else if (context.discipline === 'healthcare') {
        problem = 'Looking for effective therapeutic support solutions for your patients?';
    }

    return `${problem}

TapeGeeks ${context.product} provides:
‚Ä¢ 24/7 support without restricting movement
‚Ä¢ Medical-grade adhesive that lasts 5-7 days
‚Ä¢ Professional quality trusted by experts

${context.goal.charAt(0).toUpperCase() + context.goal.slice(1)}.

Shop now ‚Üí TapeGeeks.com

#TapeGeeks #Solution #PerformanceCare`;
}

// Caption Type 5: Storytelling
function generateStorytellingCaption(selections, context) {
    return `From struggling with ${context.injury || 'persistent pain'} to crushing personal bests üìà

This is what's possible when you give your body the support it deserves.

TapeGeeks ${context.product}: Not just tape. It's your comeback story.

What's your goal? Let's make it happen.

#TapeGeeks #ComebackStory #${context.discipline.charAt(0).toUpperCase() + context.discipline.slice(1)}Success`;
}

// Caption Type 6: Question Hook
function generateQuestionCaption(selections, context) {
    let question = `Is ${context.injury || 'pain'} holding you back from ${context.activity}? ü§î`;

    if (context.discipline === 'healthcare') {
        question = 'Looking for a therapeutic tool your patients will actually love? ü§î';
    }

    return `${question}

Here's what you need to know:

TapeGeeks ${context.product} is designed specifically for ${context.audience} who want to ${context.goal}.

üíö Medical-grade quality
üíö Lasts through anything
üíö Made in Canada

Try it risk-free today.

#TapeGeeks #AskTheExperts #PerformanceMedicine`;
}

// Caption Type 7: Benefits-Focused
function generateBenefitsCaption(selections, context) {
    return `Why ${context.audience} choose TapeGeeks:

üéØ Targeted support for ${context.injury || 'any injury'}
üèÉ Doesn't restrict your movement
üíß Waterproof & sweat-proof
‚è±Ô∏è Lasts 5-7 days
üá®üá¶ Made in Canada
‚úÖ Trusted by healthcare professionals

Professional-grade ${context.product} that works as hard as you do.

#TapeGeeks #Benefits #QualityMatters`;
}

// Caption Type 8: Call-to-Action
function generateCallToActionCaption(selections, context) {
    return `Ready to ${context.goal}? üí™

Get TapeGeeks ${context.product} delivered to your door:

üëâ Free shipping on orders over $50
üëâ Professional-grade quality
üëâ Trusted by ${context.audience} nationwide

Don't wait for pain to stop you. Take control today.

Shop TapeGeeks.com

#TapeGeeks #ShopNow #TakeControl`;
}

// Generate specifications
function generateSpecs(selections) {
    // Use comprehensive e-commerce formats
    const formatData = ecommerceFormats[selections.platformFormat] || {
        name: 'Custom Format',
        dims: 'Custom',
        ratio: '1:1',
        platform: 'general'
    };
    
    // Platform badge
    let platformBadge = '';
    if (formatData.platform === 'amazon') {
        platformBadge = 'üì¶ AMAZON';
        if (formatData.requiresWhiteBg) platformBadge += ' (WHITE BG REQUIRED)';
    } else if (formatData.platform === 'shopify') {
        platformBadge = 'üõí SHOPIFY';
    } else if (formatData.platform === 'social') {
        platformBadge = 'üì± SOCIAL MEDIA';
    }

    let specs = `E-Commerce Platform: ${platformBadge}
Format: ${formatData.name}
Dimensions: ${formatData.dims}
Aspect Ratio: ${formatData.ratio}
AI Platform: ${selections.aiPlatform.toUpperCase()}
Content Category: ${selections.contentCategory}
Product: ${selections.product}
Color: ${selections.color}`;
    
    // Add white background status for Amazon
    if (whiteBackgroundMode) {
        specs += '\n‚ö†Ô∏è WHITE BACKGROUND MODE: ENABLED (Amazon Compliant)';
    }
    
    // Add image type if set
    if (currentImageType && currentEcommercePlatform !== 'social') {
        specs += `\nImage Type: ${currentImageType.charAt(0).toUpperCase() + currentImageType.slice(1)}`;
    }
    
    return specs;
}

// Generate hashtags
function generateHashtags(selections) {
    let hashtags = ['#TapeGeeks', '#KinesiologyTape'];

    if (selections.discipline === 'healthcare') {
        hashtags.push('#Physiotherapy', '#Chiropractic', '#SportsTherapy', '#HealthcareProfessional');
    } else if (selections.discipline === 'strength') {
        hashtags.push('#CrossFit', '#Weightlifting', '#Powerlifting', '#FunctionalFitness');
    } else if (selections.discipline === 'running') {
        hashtags.push('#Running', '#Marathon', '#RunningCommunity', '#RunnerLife');
    } else if (selections.discipline === 'sleep') {
        hashtags.push('#BetterSleep', '#NasalStrips', '#SleepBetter', '#BreathePlus');
    }

    hashtags.push('#MadeInCanada', '#SportsRecovery', '#AthleteLife');

    return hashtags.join(' ');
}

// Display output
function displayOutput(prompt, captions, specs, hashtags) {
    const outputArea = document.getElementById('outputArea');

    // Check if Stage 1 variation was used
    const stage1Badge = window.usedStage1Variation ?
        `<div class="using-image-badge">üì∏ Using Your Image - Stage 1 Quick Variation</div>` : '';

    // Clear flag after reading
    window.usedStage1Variation = false;

    let html = `
        ${stage1Badge}
        <div class="output-section">
            <div class="output-title">
                ü§ñ AI-Optimized Prompt
                <button class="copy-btn" onclick="copyToClipboard('prompt')">Copy Prompt</button>
            </div>
            <div class="output-content" id="promptOutput">${prompt}</div>
        </div>

        <div class="output-section">
            <div class="captions-header">
                <div class="captions-header-left">
                    <span class="captions-header-title">üì± 10 Social Media Captions</span>
                </div>
                <div class="captions-header-buttons">
                    <button class="captions-action-btn" onclick="copyAllCaptions()">üì¶ Copy All 10</button>
                    <button class="captions-action-btn" onclick="exportCaptionsToFile()">üíæ Export to File</button>
                </div>
            </div>
            <div class="captions-grid" id="captionsOutput">
    `;

    captions.forEach((caption, index) => {
        const charCount = caption.length;
        html += `
            <div class="caption-card">
                <div class="caption-badge">#${index + 1}</div>
                <div class="caption-text">${caption.replace(/\n/g, '<br>')}</div>
                <div class="caption-footer">
                    <span class="caption-char-count">${charCount} characters</span>
                    <button class="caption-copy-btn" onclick="copySingleCaption(${index})">üìã Copy</button>
                </div>
            </div>
        `;
    });

    html += `
            </div>
        </div>

        <div class="output-section">
            <div class="output-title">üìä Image Specifications</div>
            <div class="output-content">${specs}</div>
        </div>

        <div class="output-section">
            <div class="output-title">
                #Ô∏è‚É£ Suggested Hashtags
                <button class="copy-btn" onclick="copyToClipboard('hashtags')">Copy Hashtags</button>
            </div>
            <div class="output-content" id="hashtagsOutput">${hashtags}</div>
        </div>
    `;

    // V2.0: Target the prompt output area, not the entire output area (preserve image display)
    const promptOutputArea = document.getElementById('promptOutputArea');
    if (promptOutputArea) {
        promptOutputArea.innerHTML = html;
        promptOutputArea.style.textAlign = 'left';
        promptOutputArea.style.padding = '0';
    } else {
        outputArea.innerHTML = html;
    }

    // Scroll to output
    outputArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Copy to clipboard functions
function copyPromptToClipboard() {
    const promptText = document.getElementById('promptOutput')?.innerText;
    if (promptText) {
        copyToClipboard('prompt');
    } else {
        showNotification('Please generate content first!');
    }
}

function copyToClipboard(type) {
    let text = '';
    if (type === 'prompt') {
        text = document.getElementById('promptOutput')?.innerText || '';
    } else if (type === 'hashtags') {
        text = document.getElementById('hashtagsOutput')?.innerText || '';
    }

    if (text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} copied to clipboard!`);
        });
    }
}

// Caption Grid Helper Functions
function copySingleCaption(index) {
    const captionCards = document.querySelectorAll('.caption-card');
    if (captionCards && captionCards[index]) {
        const captionText = captionCards[index].querySelector('.caption-text')?.innerText || '';
        if (captionText) {
            navigator.clipboard.writeText(captionText).then(() => {
                showNotification(`‚úì Caption #${index + 1} copied to clipboard!`);
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('Copy failed. Please try again.');
            });
        }
    }
}

function copyAllCaptions() {
    const captionCards = document.querySelectorAll('.caption-card');
    if (captionCards && captionCards.length > 0) {
        const allCaptions = Array.from(captionCards)
            .map((card, index) => {
                const text = card.querySelector('.caption-text')?.innerText || '';
                return `Caption ${index + 1}:\n${text}`;
            })
            .join('\n\n---\n\n');

        if (allCaptions) {
            navigator.clipboard.writeText(allCaptions).then(() => {
                showNotification('‚úì All 10 captions copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('Copy failed. Please try again.');
            });
        }
    } else {
        showNotification('No captions available to copy!');
    }
}

function exportCaptionsToFile() {
    const captionCards = document.querySelectorAll('.caption-card');
    if (captionCards && captionCards.length > 0) {
        const allCaptions = Array.from(captionCards)
            .map((card, index) => {
                const text = card.querySelector('.caption-text')?.innerText || '';
                const charCount = card.querySelector('.caption-char-count')?.innerText || '';
                return `Caption ${index + 1} (${charCount}):\n${text}`;
            })
            .join('\n\n' + '='.repeat(60) + '\n\n');

        const fullContent = `TAPEGEEKS - SOCIAL MEDIA CAPTIONS EXPORT
Generated: ${new Date().toLocaleString()}

${'='.repeat(60)}

${allCaptions}

${'='.repeat(60)}

Total Captions: ${captionCards.length}
Generated by: TapeGeeks AI Image Prompt Generator v1.2
`;

        const blob = new Blob([fullContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tapegeeks-captions-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('‚úì Captions exported to file!');
    } else {
        showNotification('No captions available to export!');
    }
}

// Download as file
function downloadAsFile() {
    const promptText = document.getElementById('promptOutput')?.innerText;
    if (!promptText) {
        showNotification('Please generate content first!');
        return;
    }

    const captionsText = Array.from(document.querySelectorAll('.caption-item'))
        .map(item => item.innerText)
        .join('\n\n');

    const fullContent = `TAPEGEEKS AI PROMPT GENERATOR - EXPORT

===================
AI-OPTIMIZED PROMPT
===================

${promptText}

===================
SOCIAL MEDIA CAPTIONS
===================

${captionsText}

===================
HASHTAGS
===================

${document.getElementById('hashtagsOutput')?.innerText || ''}

Generated: ${new Date().toLocaleString()}
`;

    const blob = new Blob([fullContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tapegeeks-prompt-${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    showNotification('Content downloaded!');
}

// Save favorite (placeholder)
function saveFavorite() {
    showNotification('Favorite saved! (Feature coming in v1.1)');
}

// Helper function: Get product details
function getProductDetails(productKey) {
    const products = {
        'kt-standard': {
            fullName: 'TapeGeeks Kinesiology Tape - Standard Roll (5cm x 5m)',
            description: 'Professional-grade cotton kinesiology tape with medical-grade adhesive. Water-resistant, breathable, latex-free. Trusted by athletes and healthcare professionals across Canada.'
        },
        'kt-bulk': {
            fullName: 'TapeGeeks Kinesiology Tape - Bulk Roll (5cm x 32m)',
            description: 'Economy bulk roll for high-volume clinics and athletic facilities. Same professional quality, better value for practitioners.'
        },
        'kt-precut': {
            fullName: 'TapeGeeks Kinesiology Tape - Pre-Cut Strips',
            description: 'Convenient pre-cut I-strips and Y-strips for quick application. Perfect for active individuals and on-the-go athletes.'
        },
        'kt-sensitive': {
            fullName: 'TapeGeeks Kinesiology Tape - Sensitive Skin Formula',
            description: 'Gentle adhesive formula for sensitive skin. Hypoallergenic, reduced irritation, same support and performance.'
        },
        'kt-pro': {
            fullName: 'TapeGeeks Professional Series Kinesiology Tape',
            description: 'Premium professional series with enhanced adhesion and durability. The choice of elite athletes and sports medicine professionals.'
        },
        'ns-adult-std': {
            fullName: 'TapeGeeks Breathe Plus Nasal Strips - Adult Standard',
            description: 'Drug-free nasal strips that instantly improve airflow. Reduces snoring, improves sleep quality, enhances athletic performance breathing.'
        },
        'ns-adult-lg': {
            fullName: 'TapeGeeks Breathe Plus Nasal Strips - Adult Large',
            description: 'Extra-wide nasal strips for maximum airflow improvement. Ideal for larger nose bridges or severe congestion.'
        },
        'ns-kids-sm': {
            fullName: 'TapeGeeks Breathe Plus Nasal Strips - Kids Small (Ages 2-5)',
            description: 'Gentle, kid-friendly nasal strips sized for little noses. Helps young children breathe easier and sleep better.'
        },
        'ns-kids-md': {
            fullName: 'TapeGeeks Breathe Plus Nasal Strips - Kids Medium (Ages 6-12)',
            description: 'Sized for growing kids. Improves sleep, reduces mouth breathing, helps with allergies and congestion.'
        },
        'scissors-pro': {
            fullName: 'TapeGeeks Professional Kinesiology Scissors',
            description: 'Precision-ground stainless steel scissors designed specifically for cutting kinesiology tape. Sharp, durable, ergonomic.'
        },
        'scissors-medical': {
            fullName: 'TapeGeeks Medical Scissors - Trauma Shears',
            description: 'Heavy-duty trauma shears for medical and athletic settings. Cuts through tape, clothing, bandages with ease.'
        },
        'wl-tape': {
            fullName: 'TapeGeeks Weightlifting Tape - Thumb Protection',
            description: 'Specialized thumb protection tape for Olympic weightlifting and CrossFit. Strong, supportive, prevents hook grip injuries.'
        },
        'adhesive': {
            fullName: 'TapeGeeks Athletic Adhesive Tape - 1.5" White',
            description: 'Traditional zinc oxide athletic tape for rigid support and immobilization. The foundation of sports taping.'
        },
        'cohesive': {
            fullName: 'TapeGeeks Cohesive Tape - 2" Self-Adhesive',
            description: 'Self-adhering cohesive wrap. Sticks to itself, not skin. Perfect for securing dressings, providing light compression.'
        },
        'kit': {
            fullName: 'TapeGeeks Complete Product Bundle',
            description: 'Comprehensive kit featuring our most popular products. Everything you need for complete sports medicine care.'
        }
    };

    return products[productKey] || { fullName: 'TapeGeeks Product', description: 'Professional sports medicine product.' };
}

// Helper function: Get discipline-specific context
function getDisciplineContext(discipline) {
    const contexts = {
        'healthcare': 'A professional clinical setting - modern medical office with treatment table, clean white walls, professional medical equipment visible. The atmosphere is trustworthy, competent, and caring. Natural light from windows combines with clinical overhead lighting.',
        'running': 'Outdoor running environment - tree-lined trail or urban running path with natural scenery. Morning or evening light creates dynamic shadows. The atmosphere is energetic yet peaceful, showing the joy of running.',
        'strength': 'Gritty CrossFit gym or weightlifting facility - barbells, weight plates, pull-up bars, concrete or rubber flooring. Industrial lighting creates dramatic shadows. The atmosphere is intense, powerful, determined.',
        'team-sports': 'Athletic field or court setting - whether soccer pitch, basketball court, or sports facility. Natural outdoor light or bright gym lighting. The atmosphere is competitive, energetic, team-focused.',
        'endurance': 'Endurance sports environment - open road for cycling, pool for swimming, or scenic outdoor trails. Natural lighting emphasizes the journey and persistence. Atmosphere is focused, determined, meditative.',
        'other-sports': 'Sport-specific environment appropriate to the activity - tennis court, golf course, climbing gym, ski slope. Lighting and atmosphere match the sport\'s character.',
        'sleep': 'Peaceful bedroom environment with soft, warm lighting. Cozy bed, calming colors (blues, grays, soft whites), minimal distractions. The atmosphere is tranquil, restful, safe. Evening or early morning light creates gentle ambiance.',
        'fitness': 'Modern fitness center or home workout space - clean, well-lit, motivating environment. Mix of natural and artificial lighting. Atmosphere is positive, energetic, welcoming to all fitness levels.',
        'recovery': 'Rehabilitation or recovery setting - physical therapy clinic, recovery room, or calm home environment. Soft professional lighting. Atmosphere is supportive, hopeful, focused on healing and progress.'
    };

    return contexts[discipline] || '';
}

// Helper function: Get injury-specific body positioning AND proper taping technique
function getInjuryPositioning(injury) {
    const tapingInstructions = {
        // RUNNING & TRACK - Updated from Sport-Specific Guide
        'runner-s-knee-patellofemoral-pain-': {
            position: 'Knee slightly bent (15-20 degrees flexion), standing or seated, kneecap clearly visible, weight-bearing or neutral stance',
            taping: 'VMO support: I-strip from 4-6 inches above knee on inner quad, curve around inner edge of kneecap with 25-50% stretch, end 2-3 inches below knee on inner shin. Purpose: Lift and support kneecap tracking. Optional: IT band support with parallel strips from below knee to hip (25% stretch) plus horizontal strip at pain point (50% stretch). Zero tension on all 2-inch anchors.'
        },
        'acl-mcl-support': {
            position: 'Knee at 90-degree angle, showing medial or lateral support. Standing or athletic stance.',
            taping: 'For MCL: Start tape 6 inches above knee on inner thigh, apply with 50-75% stretch down the medial (inner) joint line, anchor without stretch below knee on inner calf. For ACL: X-pattern with two strips crossing at center of knee - one from outer upper thigh to inner lower leg, second from inner upper thigh to outer lower leg, each with 50% stretch at joint line, zero stretch at anchors.'
        },
        'ankle-sprain-lateral-': {
            position: 'Standing or seated, ankle in neutral position (90 degrees to shin), foot and ankle accessible, weight-bearing or non-weight-bearing',
            taping: 'Stirrup pattern: Start on inside of foot (medial), run under heel, up outside of leg (lateral) creating stirrup with 25-35% stretch under foot, zero tension at anchors. Add Figure-8 heel lock for maximum support: Wraps in figure-8 around ankle and heel, locks heel in place, prevents inversion/eversion. Apply to BOTH ankles even if only one has injury history. Can wear under ankle braces for double protection. Sport context: Basketball (#1 injury), volleyball, soccer (cutting and tackles), jumping sports, court sports, trail running. Timing: 60-90 minutes before activity.'
        },
        'ankle-sprain-medial-': {
            position: 'Foot in neutral position, medial (inside) ankle view.',
            taping: 'Start tape on outside of lower calf, wrap under heel with 50-75% stretch, pull up inner ankle following deltoid ligament path, continue up inside of lower leg. Provides medial stability and prevents excessive eversion.'
        },
        'achilles-tendonitis': {
            position: 'Foot in dorsiflexion (toes pulled up toward shin), seated or prone position, Achilles tendon elongated and visible, calf muscle stretched',
            taping: 'Vertical strip from heel insertion point up over Achilles tendon to mid-calf with 25-35% stretch over tendon, zero tension at heel and calf anchors. Can use I-strip or Y-strip (Y tails at calf for comprehensive support). Add horizontal stabilizing strip at pain point, perpendicular to vertical strip, 3-4 inch length with 50% stretch for compression. Purpose: Decompress and support Achilles, reduce strain. Sport context: Running, jumping sports, hill training, sudden mileage increases.'
        },
        'plantar-fasciitis': {
            position: 'Foot in dorsiflexion (toes pulled toward shin), seated with leg extended, bottom of foot visible and accessible, arch stretched and elongated',
            taping: 'Longitudinal strip from heel (calcaneus) along arch to ball of foot continuing to base of toes with 25-35% stretch through arch, zero tension at heel and toe anchors. Cross-arch X pattern: Two diagonal strips - first from inside heel across arch to outside forefoot, second from outside heel across arch to inside forefoot, forming X over arch with 25% stretch. Apply in evening for overnight support. Purpose: Lift and support plantar fascia, reduce tension. Sport context: Running, marathon training, high mileage, standing professions.'
        },
        'rotator-cuff-strain-tear': {
            position: 'Shoulder in neutral or slightly abducted position (arm 20-30 degrees away from body). Clear view of shoulder joint.',
            taping: 'Start below shoulder on upper arm, apply with 50% stretch up and over the affected rotator cuff muscles (usually supraspinatus on top of shoulder), anchor on upper back/shoulder blade without stretch. Can use Y-strip or I-strip. Tape should support and decompress rotator cuff, not restrict range of motion.'
        },
        'shoulder-impingement': {
            position: 'Standing upright, arm at side or slight abduction (20-45 degrees), shoulder in neutral, allows full overhead motion',
            taping: 'Y-strip with base anchor on upper back between scapulae, split into Y-tails running over deltoids (front and middle) ending on upper arm. Light tension (15-25%) to maintain mobility. Supports overhead position without restriction, provides proprioceptive feedback. Must allow full shoulder flexion and external rotation. Alternative: Decompression technique starting at upper arm with 25-50% stretch pulling downward to depress humeral head, anchor on upper back. Sport context: CrossFit, Olympic lifting, overhead movements, gymnastics, swimming, tennis.'
        },
        'tennis-elbow-lateral-epicondylitis-': {
            position: 'Elbow slightly flexed (20-30 degrees), forearm supinated (palm up). Lateral (outside) elbow clearly visible.',
            taping: 'Start tape on outer forearm (2-3 inches below elbow), apply with 50-75% stretch across lateral epicondyle (outer elbow bone), continue up outer upper arm without stretch. Tape should cross perpendicular to extensor muscles, providing support and reducing strain on the tendon insertion.'
        },
        'golfer-s-elbow-medial-epicondylitis-': {
            position: 'Elbow flexed (20-30 degrees), forearm pronated (palm down). Medial (inside) elbow visible.',
            taping: 'Start tape on inner forearm (2-3 inches below elbow), apply with 50-75% stretch across medial epicondyle (inner elbow bone), continue up inner upper arm without stretch. Supports flexor tendons and reduces strain on medial epicondyle.'
        },
        'lower-back-pain-lumbar-': {
            position: 'Standing upright, spine in neutral, lower back visible, core engaged',
            taping: 'Bilateral support strips: Two parallel strips alongside spine from sacrum/SI joint to mid-back, 2-3 inches from spine on each side (NOT on spine itself), 25-35% stretch for support. Provides proprioceptive feedback for position. Lower anchor (sacrum) 0% tension, through lumbar region 25-35% stretch, upper anchor (mid-back) 0% tension. Optional: Horizontal strips across lower back for additional support. Critical during heavy lifts and prolonged sitting. Sport context: CrossFit, deadlifts, cleans, heavy lifting, functional fitness, cycling, office workers.'
        },
        'hamstring-strain': {
            position: 'Standing with forward bend (stretch position), hip flexed, hamstring elongated, leg straight or slight knee bend, posterior thigh clearly visible',
            taping: 'Y-strip pattern: Single base anchor at glute fold, split into Y tails at mid-thigh, tails run down medial and lateral hamstring to just above knee. 25-35% stretch throughout. Critical: Apply in stretched position (forward bend), release after application for lift effect. Zero tension on 2-inch base anchor and 2-inch end anchors on each tail. Sport context: Sprinting, track, explosive acceleration, soccer forwards, 100m-400m events. High injury risk for sprinters - career-threatening if ignored.'
        },
        'quad-strain': {
            position: 'Standing upright, hip extended, leg straight, quad in neutral length, anterior thigh visible',
            taping: 'Y-strip starting above knee, single strip to mid-thigh, split into Y at mid-thigh with tails continuing to hip/ASIS. Focus on rectus femoris (center of thigh). Light stretch (15-25%) for power support. Base anchor above knee 0% tension, mid-thigh 15-25% stretch, Y-tails to hip 15-25% stretch, hip anchors 0% tension. Supports explosive knee extension. Sport context: Sprinting, jumping, explosive starts, track events, basketball.'
        },
        'groin-pull': {
            position: 'Standing with legs apart (abducted), groin/adductor muscles stretched, inner thigh visible, apply before shorts/gear go on',
            taping: 'Adductor support strips from inner knee (just above joint) up inner thigh along adductor muscles to groin/pubic area with moderate tension (35-40%). Must apply before gear. 2-3 strips per leg covering adductor longus, brevis, magnus. Parallel strips 1-2 inches apart. Apply 90+ minutes before activity. Sport context: Hockey (most critical - lateral skating stride), soccer (kicking motion), skating, lateral movement sports. Timing for hockey/soccer: 90 minutes before game, after initial warm-up, before shin guards/equipment.'
        },
        'hip-flexor-strain': {
            position: 'Standing with leg back (hip extended), hip flexor stretched, front of hip visible',
            taping: 'Hip flexor strip from mid-thigh (anterior) up to front of hip bone (ASIS) with 25-35% stretch. Apply with hip extended (leg back), release for lifting effect. Supports explosive hip flexion, reduces strain during skating stride and shooting motion. Sport context: Hockey (skating stride, shooting), soccer (kicking), sprinting (knee drive), running (high knee lift).'
        },
        'it-band-syndrome': {
            position: 'Standing upright, leg straight or slight knee bend, hip in neutral, lateral (outside) view of leg showing IT band path',
            taping: 'Two parallel strips from below knee to hip following IT band line on lateral thigh, 25% stretch along entire length, strips 2-3 inches apart, zero tension on all 2-inch anchors. Add horizontal strip at point of maximum pain (usually just above knee) with 50% stretch, 3-4 inch length, perpendicular to main strips. Purpose: Reduce friction and tension on IT band. Sport context: Distance running, marathon, trail running, cycling.'
        },
        'turf-toe': {
            position: 'Foot showing big toe clearly. Toe in neutral or slight extension (bent upward 10-15 degrees).',
            taping: 'Anchor strip around ball of foot, apply strip along bottom of big toe from base to tip with 50% stretch, wrap over top of toe. Creates splint effect limiting hyperextension. Can add cross strips around MTP joint for additional support. Tape should stabilize joint while allowing normal walking.'
        },
        'knee-sprain-strain': {
            position: 'Knee at functional angle (15-30 degrees flexion) for general support, OR 90 degrees (bottom squat position) for heavy squats. Full view of knee joint from front or side.',
            taping: 'General support: Four I-strips in basket-weave pattern around knee - two strips vertically on each side of kneecap, two strips horizontally above and below kneecap, all with 25-50% stretch at joint line, zero stretch at anchors. Heavy squats: Dual strip stabilization starting 4-6 inches above knee, crossing at kneecap or parallel, ending 3-4 inches below knee, 25-40% stretch through knee joint. PRO TIP: For heavy squats, apply with knee bent at 90 degrees (bottom position) to ensure support throughout entire ROM, especially in the hole. Optional VMO support strip on inner quad with 25% stretch. Sport context: Basketball, skiing, soccer, CrossFit, powerlifting, high-rep squats.'
        },
        'patellar-tendonitis': {
            position: 'Knee slightly bent, showing patellar tendon clearly (between kneecap and tibial tuberosity).',
            taping: 'Short I-strip or butterfly strip placed horizontally just below kneecap across patellar tendon with 50-75% stretch. Acts as tendon strap, reducing load on patellar tendon. Optional: Add vertical I-strip over tendon with light stretch for additional support.'
        },
        'wrist-strain': {
            position: 'Wrist in neutral position (straight line from forearm to hand), forearm visible, hand relaxed, must allow full extension for catch position',
            taping: 'Horizontal strips around wrist joint with moderate tension (50%) for compression, 2-3 strips overlapping slightly, covers wrist joint completely. Must maintain mobility for full extension (front rack position) and full flexion (overhead position). Alternative: Figure-8 wrap starting on back of hand around wrist with 50% stretch for compression and stability. Sport context: CrossFit, Olympic weightlifting, clean & jerk, snatch, front rack, gymnastics, racquet sports.'
        },
        'calf-strain': {
            position: 'Standing upright, foot in slight plantarflexion (toes pointed), calf muscle visible, weight on forefoot',
            taping: 'Single I-strip or Y-strip from Achilles insertion at heel up over gastrocnemius muscle to mid-calf or just below knee with moderate stretch (25-35%). Y-strip option: Base at heel, split at mid-calf, tails separate to medial and lateral heads for comprehensive support. Supports explosive push-off phase. Sport context: Sprinting, jumping, explosive movements, track, basketball, soccer.'
        },
        'shin-splints-medial-tibial-stress-': {
            position: 'Seated, leg extended with slight knee bend, foot in neutral position (not flexed or pointed), inner shin bone (medial tibia) visible',
            taping: 'Two parallel strips along inside edge of shin from ankle (just above medial malleolus) to just below knee, 1-2 inches apart parallel to each other, 25% stretch along muscle belly following tibialis anterior line, zero tension at ankle and knee anchors. Sport context: Running, jumping, high-impact training, hard surfaces.'
        }
    };

    const instruction = tapingInstructions[injury];
    if (instruction) {
        return `${instruction.position}\n\nProper Taping Technique: ${instruction.taping}`;
    }
    return '';
}

// Helper function: Get format guidance
function getFormatGuidance(format) {
    const guidance = {
        'instagram-square': 'Composition for Instagram Square (1:1 ratio, 1080x1080px): Center the main subject with balanced space on all sides. Keep important elements away from edges. Optimize for mobile viewing - larger subjects, clear focal points.',
        'instagram-portrait': 'Composition for Instagram Portrait (4:5 ratio, 1080x1350px): Utilize vertical space effectively. Subject in upper two-thirds for optimal mobile feed display. Rule of thirds composition works well.',
        'instagram-story': 'Composition for Instagram Story (9:16 ratio, 1080x1920px): Full vertical format. Keep key elements in center "safe zone" (top/bottom areas may be cut off by UI). Text in upper third.',
        'facebook': 'Composition for Facebook (16:9 ratio, 1200x630px): Landscape orientation. Subject positioned using rule of thirds. Preview thumbnail shows center area - keep focus there.',
        'pinterest': 'Composition for Pinterest (2:3 ratio, 1000x1500px): Vertical orientation perfect for Pinterest feeds. Subject in upper portion, text overlay in top third for maximum impact.',
        'website-hero': 'Composition for Website Hero (21:9 ratio, 2560x1080px): Ultra-wide cinematic format. Subject off-center with breathing room for text overlay. Dramatic landscape composition.',
        'product-page': 'Composition for Product Page (1:1 ratio, 2000x2000px): High-resolution square for e-commerce. Clean, centered subject with minimal background. Maximum product detail and clarity.',
        'tiktok': 'Composition for TikTok/Reels (9:16 ratio, 1080x1920px): Full vertical mobile format. Dynamic composition that works with fast scrolling. Subject fills frame for impact.',
        'email': 'Composition for Email Header (3:1 ratio, 600x200px): Wide letterbox format. Subject and text must work in very horizontal space. Keep it simple and clear.',
        'linkedin': 'Composition for LinkedIn (1.91:1 ratio, 1200x627px): Professional landscape format. Balanced composition, clear subject matter. Professional tone essential.',
        'twitter': 'Composition for Twitter/X (16:9 ratio, 1200x675px): Standard landscape social media format. Engaging composition that works in fast-scrolling timeline.',
        'youtube': 'Composition for YouTube Thumbnail (16:9 ratio, 1280x720px): Landscape format that must grab attention. Bold composition, clear focal point, readable at small sizes.',
        'custom-format': 'Custom composition based on specified dimensions. Apply professional composition principles: rule of thirds, balanced visual weight, clear focal point.'
    };

    return guidance[format] || 'Professional composition optimized for the specified format.';
}

// Helper function: Get format specifications
function getFormatSpecs(format) {
    // Use e-commerce formats database if available
    if (ecommerceFormats[format]) {
        const f = ecommerceFormats[format];
        return { 
            ratio: f.ratio, 
            dimensions: f.dims,
            name: f.name,
            platform: f.platform,
            requiresWhiteBg: f.requiresWhiteBg,
            description: f.description
        };
    }
    
    // Fallback for legacy formats
    const specs = {
        'instagram-square': { ratio: '1:1', dimensions: '1080x1080px' },
        'instagram-portrait': { ratio: '4:5', dimensions: '1080x1350px' },
        'instagram-story': { ratio: '9:16', dimensions: '1080x1920px' },
        'facebook': { ratio: '16:9', dimensions: '1200x630px' },
        'pinterest': { ratio: '2:3', dimensions: '1000x1500px' },
        'website-hero': { ratio: '21:9', dimensions: '2560x1080px' },
        'product-page': { ratio: '1:1', dimensions: '2000x2000px' },
        'tiktok': { ratio: '9:16', dimensions: '1080x1920px' },
        'email': { ratio: '3:1', dimensions: '600x200px' },
        'linkedin': { ratio: '1.91:1', dimensions: '1200x627px' },
        'twitter': { ratio: '16:9', dimensions: '1200x675px' },
        'youtube': { ratio: '16:9', dimensions: '1280x720px' },
        'custom-format': { ratio: 'Custom', dimensions: 'Custom dimensions' }
    };

    return specs[format] || { ratio: '1:1', dimensions: '1080x1080px' };
}

// Show notification
function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('show');

    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// ============================================================================
// V1.2 IMAGE UPLOAD & ANALYSIS - TWO-STAGE WORKFLOW
// ============================================================================

// Initialize image dropzone
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('imageDropzone');
    const fileInput = document.getElementById('imageFileInput');

    if (!dropzone || !fileInput) return; // Safety check

    // Click to upload
    dropzone.addEventListener('click', () => fileInput.click());

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            handleImageFile(e.target.files[0]);
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            handleImageFile(e.dataTransfer.files[0]);
        }
    });

    // Paste from clipboard
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                handleImageFile(file);
                break;
            }
        }
    });
});

function handleImageFile(file) {
    if (!file.type.match('image.*')) {
        alert('Please upload an image file (JPG, PNG, WebP)');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        currentImageData = e.target.result;
        displayImagePreview(e.target.result);
        analyzeImage(e.target.result);
    };
    reader.readAsDataURL(file);
}

function displayImagePreview(imageData) {
    document.getElementById('uploadedImagePreview').src = imageData;
    document.getElementById('imageAnalysisResults').classList.remove('hidden');

    // Show analyzing state
    document.getElementById('imageAnalysisContent').innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div class="analyzing-spinner"></div>
            <p style="color: #C5D52E; margin-top: 10px;">Analyzing image...</p>
        </div>
    `;
}

function rgbToHex(r, g, b) {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
}

function extractDominantColors(imageData) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const scaleFactor = 0.1;
            canvas.width = img.width * scaleFactor;
            canvas.height = img.height * scaleFactor;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const imagePixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imagePixelData.data;

            const colorCounts = {};
            const sampleRate = 4;

            for (let i = 0; i < pixels.length; i += 4 * sampleRate) {
                const r = Math.floor(pixels[i] / 20) * 20;
                const g = Math.floor(pixels[i + 1] / 20) * 20;
                const b = Math.floor(pixels[i + 2] / 20) * 20;
                const hex = rgbToHex(r, g, b);
                colorCounts[hex] = (colorCounts[hex] || 0) + 1;
            }

            const sortedColors = Object.entries(colorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0]);

            resolve(sortedColors);
        };
        img.src = imageData;
    });
}

function analyzeBrightness(imageData) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const scaleFactor = 0.1;
            canvas.width = img.width * scaleFactor;
            canvas.height = img.height * scaleFactor;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const imagePixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imagePixelData.data;

            let totalBrightness = 0;
            const sampleCount = pixels.length / 4;

            for (let i = 0; i < pixels.length; i += 4) {
                const r = pixels[i];
                const g = pixels[i + 1];
                const b = pixels[i + 2];
                const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
                totalBrightness += brightness;
            }

            const avgBrightness = totalBrightness / sampleCount;

            let description = '';
            if (avgBrightness < 85) {
                description = 'DARK (Moody, dramatic, high contrast)';
            } else if (avgBrightness < 170) {
                description = 'NORMAL (Balanced, even lighting)';
            } else {
                description = 'BRIGHT (High-key, airy, clean)';
            }

            resolve({
                value: Math.round(avgBrightness),
                description: description,
                percentage: Math.round((avgBrightness / 255) * 100)
            });
        };
        img.src = imageData;
    });
}

function analyzeColorTemperature(imageData) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const scaleFactor = 0.1;
            canvas.width = img.width * scaleFactor;
            canvas.height = img.height * scaleFactor;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const imagePixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imagePixelData.data;

            let totalWarmth = 0;
            const sampleCount = pixels.length / 4;

            for (let i = 0; i < pixels.length; i += 4) {
                const r = pixels[i];
                const b = pixels[i + 2];
                totalWarmth += (r - b);
            }

            const avgWarmth = totalWarmth / sampleCount;

            let description = '';
            if (avgWarmth > 15) {
                description = 'WARM (Golden, orange, inviting tones)';
            } else if (avgWarmth < -15) {
                description = 'COOL (Blue, cyan, crisp tones)';
            } else {
                description = 'NEUTRAL (Balanced temperature)';
            }

            resolve({
                value: Math.round(avgWarmth),
                description: description
            });
        };
        img.src = imageData;
    });
}

async function analyzeImage(imageData) {
    try {
        const [colors, brightness, temperature] = await Promise.all([
            extractDominantColors(imageData),
            analyzeBrightness(imageData),
            analyzeColorTemperature(imageData)
        ]);

        currentAnalysis = {
            colorPalette: colors,
            brightness: brightness,
            temperature: temperature,
            style: deriveStyle(brightness, temperature),
            lighting: deriveLighting(brightness),
            mood: deriveMood(brightness, temperature)
        };

        displayAnalysis(currentAnalysis);
        generatePromptVariations(currentAnalysis);

    } catch (error) {
        console.error('Image analysis error:', error);
        document.getElementById('imageAnalysisContent').innerHTML = `
            <p style="color: #ef4444;">Error analyzing image. Please try another image.</p>
        `;
    }
}

function deriveStyle(brightness, temperature) {
    if (brightness.value < 85 && temperature.value > 10) {
        return 'Moody warm aesthetic';
    } else if (brightness.value > 170 && temperature.value < -10) {
        return 'Clean minimalist';
    } else if (brightness.value > 170 && temperature.value > 10) {
        return 'Bright and cheerful';
    } else if (brightness.value < 85) {
        return 'Dark and dramatic';
    } else {
        return 'Natural balanced';
    }
}

function deriveLighting(brightness) {
    if (brightness.value < 85) {
        return 'Low-key dramatic lighting with deep shadows';
    } else if (brightness.value > 170) {
        return 'High-key bright lighting, minimal shadows';
    } else {
        return 'Balanced natural lighting';
    }
}

function deriveMood(brightness, temperature) {
    if (brightness.value < 85 && temperature.value > 10) {
        return 'Intimate and cozy';
    } else if (brightness.value > 170 && temperature.value < -10) {
        return 'Clean and professional';
    } else if (brightness.value > 170) {
        return 'Energetic and uplifting';
    } else {
        return 'Calm and focused';
    }
}

function displayAnalysis(analysis) {
    const colorSwatches = analysis.colorPalette.map(color =>
        `<div class="color-swatch" style="background-color: ${color}" data-hex="${color}"></div>`
    ).join('');

    document.getElementById('imageAnalysisContent').innerHTML = `
        <div class="analysis-item">
            <div class="analysis-label">üé® Dominant Colors</div>
            <div class="color-palette">${colorSwatches}</div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">üí° Brightness</div>
            <div class="analysis-value">${analysis.brightness.description} (${analysis.brightness.value}/255)</div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">üå°Ô∏è Color Temperature</div>
            <div class="analysis-value">${analysis.temperature.description}</div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">‚ú® Visual Style</div>
            <div class="analysis-value">${analysis.style}</div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">üé¨ Lighting</div>
            <div class="analysis-value">${analysis.lighting}</div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">üé≠ Mood</div>
            <div class="analysis-value">${analysis.mood}</div>
        </div>
    `;
}

function generatePromptVariations(analysis) {
    const colors = analysis.colorPalette.slice(0, 3).join(', ');

    // Build comprehensive lighting description
    const lightingDesc = buildLightingDescription(analysis);

    // Build mood and atmosphere description
    const moodDesc = buildMoodDescription(analysis);

    // Build color grading description
    const colorDesc = buildColorDescription(analysis);

    generatedVariations = [
        // Variation 1: Exact Match - Recreate the uploaded image's aesthetic
        buildExactMatchPrompt(analysis, lightingDesc, moodDesc, colorDesc),

        // Variation 2: Inspired - Use reference as inspiration with flexibility
        buildInspiredPrompt(analysis, lightingDesc, moodDesc, colorDesc),

        // Variation 3: Premium Elevated - Ultra-premium version
        buildPremiumPrompt(analysis, lightingDesc, moodDesc, colorDesc),

        // Variation 4: TapeGeeks Branded - Brand-specific adaptation
        buildBrandedPrompt(analysis, lightingDesc, moodDesc, colorDesc)
    ];

    // Display variations
    generatedVariations.forEach((variation, index) => {
        document.getElementById(`variation-${index}`).textContent = variation;
    });
}

// Helper: Build detailed lighting description
function buildLightingDescription(analysis) {
    const brightness = analysis.brightness;
    let lighting = '';

    if (brightness.level === 'Dark') {
        lighting = 'dramatic low-key lighting with deep shadows, moody atmosphere, high contrast between highlights and shadows';
    } else if (brightness.level === 'Bright') {
        lighting = 'bright, airy high-key lighting with soft shadows, well-exposed highlights, clean and vibrant atmosphere';
    } else {
        lighting = 'balanced natural lighting with moderate contrast, evenly distributed illumination, professional studio quality';
    }

    // Add temperature-based lighting details
    if (analysis.temperature.warmth === 'Warm') {
        lighting += ', warm golden hour tones, sunrise/sunset quality, cozy ambient feel';
    } else if (analysis.temperature.warmth === 'Cool') {
        lighting += ', cool crisp tones, daylight balanced, fresh and clinical feel';
    } else {
        lighting += ', neutral color temperature, true-to-life color reproduction';
    }

    return lighting;
}

// Helper: Build mood description
function buildMoodDescription(analysis) {
    const mood = analysis.mood;
    const brightness = analysis.brightness.level;
    const temp = analysis.temperature.warmth;

    let description = mood;

    if (brightness === 'Bright' && temp === 'Warm') {
        description += ', uplifting and energetic, positive and motivational atmosphere';
    } else if (brightness === 'Dark' && temp === 'Cool') {
        description += ', serious and professional, focused and determined atmosphere';
    } else if (brightness === 'Dark' && temp === 'Warm') {
        description += ', intense and powerful, dramatic and inspiring atmosphere';
    } else {
        description += ', balanced and trustworthy, professional and approachable atmosphere';
    }

    return description;
}

// Helper: Build color grading description
function buildColorDescription(analysis) {
    const colors = analysis.colorPalette.slice(0, 3);
    let description = `Color palette featuring ${colors.join(', ')}. `;

    if (analysis.temperature.warmth === 'Warm') {
        description += 'Warm color grading with enhanced oranges, yellows, and golden tones. Slightly lifted shadows with warm undertones. Color grade reminiscent of golden hour photography.';
    } else if (analysis.temperature.warmth === 'Cool') {
        description += 'Cool color grading with enhanced blues, teals, and crisp tones. Clean shadows with cool undertones. Clinical and professional color science.';
    } else {
        description += 'Neutral balanced color grading with accurate color reproduction. Natural skin tones preserved. Professional color calibration.';
    }

    return description;
}

// Variation 1: Exact Match - COMPACT VERSION
function buildExactMatchPrompt(analysis, lightingDesc, moodDesc, colorDesc) {
    const colors = analysis.colorPalette.slice(0, 3);
    return `Professional kinesiology tape product photography - EXACT MATCH to reference image:

RECREATE THIS AESTHETIC EXACTLY:
Style: ${analysis.style}
Lighting: ${lightingDesc}
Mood: ${moodDesc}
Colors: ${colors.join(', ')} - match these exact tones
Temperature: ${analysis.temperature.description}

SUBJECT: Athletic individual with TapeGeeks kinesiology tape on ${analysis.brightness.level === 'Bright' ? 'shoulder or knee' : 'back or leg'}. Professional application technique visible.

SETTING: ${analysis.brightness.level === 'Bright' ? 'Bright professional athletic facility, clean background' : 'Dramatic studio, dark background, controlled lighting'}

TECHNICAL: 50-85mm lens, f/2.8-4.0, sharp focus on tape, beautiful bokeh.

GOAL: Match reference image style EXACTLY - same lighting, mood, colors. Just replace subject with kinesiology tape application.`;
}

// Variation 2: Inspired - COMPACT VERSION
function buildInspiredPrompt(analysis, lightingDesc, moodDesc, colorDesc) {
    const colors = analysis.colorPalette.slice(0, 3);
    return `Professional kinesiology tape photography - INSPIRED by reference (creative adaptation):

INSPIRATION (not exact copy):
Style feel: ${analysis.style}
Lighting direction: ${lightingDesc} - adapt creatively
Mood quality: ${moodDesc}
Color guide: ${colors.join(', ')} - use as inspiration, not requirement
Temperature: ${analysis.temperature.description}

SUBJECT: Athletic individual with TapeGeeks tape, dynamic pose showing movement or strength. Tape on major muscle group.

SETTING: ${analysis.brightness.level === 'Bright' ? 'Modern gym or training facility, bright clean environment' : 'Athletic studio, dramatic controlled lighting'}

CREATIVE FREEDOM: Maintain the FEEL and ENERGY of reference but adapt for kinesiology tape product photography. 60% inspired by reference, 40% adapted for tape showcase.

BRAND: Subtle TapeGeeks lime green (#C5D52E) accent.`;
}

// Variation 3: Premium Elevated - COMPACT VERSION
function buildPremiumPrompt(analysis, lightingDesc, moodDesc, colorDesc) {
    const colors = analysis.colorPalette.slice(0, 3);
    return `ULTRA-PREMIUM kinesiology tape photography - ELEVATE reference to magazine quality:

ELEVATE TO PREMIUM:
Foundation: ${analysis.style} + ${lightingDesc} + ${moodDesc}
Colors: ${colors.join(', ')} - elevate with premium color grading
Temperature: ${analysis.temperature.description}

PREMIUM EXECUTION:
Model: Professional athletic model, peak physique, powerful pose
Tape: Advanced application (Y-strip, I-strip, fan technique) - medical precision
Setting: ${analysis.brightness.level === 'Bright' ? 'Pristine white infinity cove, ultra-clean minimalist' : 'Dramatic black backdrop, precision lighting, deep shadows'}
Lighting: Multi-light studio setup - key + fill + rim + accent lights
Camera: High-end (Phase One/Hasselblad), premium lens, f/1.4-2.8

GOAL: Editorial quality worthy of top fitness magazines, medical journals, luxury brand campaigns. Think Nike athlete campaigns, Lululemon product photography. Aspirational premium positioning.

BRAND: TapeGeeks lime green (#C5D52E) as strategic premium accent.`;
}

// Variation 4: TapeGeeks Branded - COMPACT VERSION
function buildBrandedPrompt(analysis, lightingDesc, moodDesc, colorDesc) {
    const colors = analysis.colorPalette.slice(0, 3);
    return `TapeGeeks BRANDED kinesiology tape photography - optimized for marketing:

BRAND FOUNDATION:
Aesthetic: ${analysis.style} + ${moodDesc} ADAPTED for TapeGeeks brand
Reference colors: ${colors.join(', ')} as secondary palette
HERO COLOR: TapeGeeks lime green (#C5D52E) - PROMINENTLY FEATURED (non-negotiable!)

SUBJECT: Athletic individual with TapeGeeks BRANDED tape clearly visible. Tape roll, packaging, or branded strips in shot. Professional application on major muscle group.

SETTING: ${analysis.brightness.level === 'Bright' ? 'Modern physiotherapy clinic, clean white/grey/lime green environment' : 'High-performance training center, dark background makes lime green POP'}

BRAND INTEGRATION REQUIREMENTS:
- Lime green as PRIMARY brand color - immediately recognizable
- TapeGeeks branding clearly visible (logo/product identification)
- Professional yet approachable feel
- Canadian "Made in Canada" pride
- Medical credibility + Athletic performance

MARKETING-READY COMPOSITION:
- Strategic negative space for text overlay (Instagram/Facebook/Website ads)
- Works in multiple crops (1:1, 4:5, 16:9)
- Focal point positioned for headline placement

TARGET AUDIENCES: Serious athletes + Healthcare professionals + Fitness enthusiasts + Injury recovery seekers

GOAL: UNMISTAKABLY TapeGeeks branded - viewer immediately identifies lime green + professional medical aesthetic + athletic performance = TapeGeeks brand.`;
}

// Helper: Get demographic for branding
function getDemographicForBranding() {
    const options = [
        'Athletic male (25-40) representing target demographic',
        'Athletic female (25-40) representing target demographic',
        'Healthcare professional (physiotherapist or athletic therapist) applying tape to athlete patient',
        'Serious athlete mid-workout demonstrating product in use'
    ];
    return options[0]; // Default to male demographic, can be randomized or parameterized
}

// Helper: Get brand environment
function getBrandEnvironment(analysis) {
    if (analysis.brightness.level === 'Bright') {
        return 'Modern bright physiotherapy clinic or athletic training facility. Clean white/grey environment with professional medical aesthetic. Canadian sports medicine facility feel.';
    } else {
        return 'Professional athletic training center with controlled dramatic lighting. High-performance training environment. Dark background emphasizing the athlete and product.';
    }
}

function copyPromptVariation(index) {
    const prompt = generatedVariations[index];
    if (!prompt) {
        alert('Please upload an image first');
        return;
    }

    navigator.clipboard.writeText(prompt).then(() => {
        showNotification('Prompt variation copied to clipboard!');
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed. Please try again.');
    });
}

function sendToGenerator(index) {
    console.log('=== sendToGenerator START ===');
    console.log('Index requested:', index);
    console.log('generatedVariations array:', generatedVariations);
    console.log('generatedVariations length:', generatedVariations.length);

    const prompt = generatedVariations[index];

    if (!prompt) {
        console.error('ERROR: No prompt found at index', index);
        alert('Please upload an image first or wait for analysis to complete');
        return;
    }

    console.log('‚úì Prompt retrieved successfully');
    console.log('Prompt preview:', prompt.substring(0, 100) + '...');

    // AUTO-POPULATE Stage 2 controls based on image analysis
    console.log('Auto-populating Stage 2 controls based on image analysis...');
    autoPopulateControlsFromAnalysis(currentAnalysis, index);

    // Store the selected variation AND index for Stage 1
    window.selectedImagePrompt = prompt;
    window.selectedVariationIndex = index;

    console.log('‚úì window.selectedImagePrompt set');
    console.log('‚úì window.selectedVariationIndex set to:', index);
    console.log('‚úì Stage 2 controls auto-populated');

    // Trigger content generation
    console.log('Calling generateContent()...');
    generateContent();

    // Scroll to output area after a brief delay
    setTimeout(() => {
        const outputArea = document.getElementById('outputArea');
        if (outputArea) {
            outputArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            console.log('‚úì Scrolled to output area');
        } else {
            console.warn('Output area not found');
        }
    }, 300);

    showNotification('‚úì Using selected variation! Stage 2 options auto-populated. Generating...');
    console.log('=== sendToGenerator END ===');
}

// Auto-populate Stage 2 controls based on image analysis
function autoPopulateControlsFromAnalysis(analysis, variationIndex) {
    if (!analysis) {
        console.warn('No analysis available, using defaults');
        return;
    }

    console.log('Auto-populating controls from analysis:', analysis);

    // 1. Set AI Platform - based on variation type
    const platformMap = {
        0: 'gemini',      // Exact Match - Gemini for detailed recreation
        1: 'chatgpt',     // Inspired - ChatGPT for creative interpretation
        2: 'gemini',      // Premium - Gemini for complex instructions
        3: 'gemini'       // Branded - Gemini for brand guidelines
    };
    document.getElementById('aiPlatform').value = platformMap[variationIndex] || 'gemini';

    // 2. Set Platform Format - based on image brightness (bright = social, dark = dramatic)
    if (analysis.brightness.level === 'Bright') {
        document.getElementById('platformFormat').value = 'instagram-square';
    } else if (analysis.brightness.level === 'Dark') {
        document.getElementById('platformFormat').value = 'instagram-portrait';
    } else {
        document.getElementById('platformFormat').value = 'facebook';
    }

    // 3. Set Discipline Category - infer from image mood
    if (analysis.mood.toLowerCase().includes('energetic') || analysis.mood.toLowerCase().includes('dynamic')) {
        document.getElementById('disciplineCategory').value = 'running';
    } else if (analysis.mood.toLowerCase().includes('powerful') || analysis.mood.toLowerCase().includes('strong')) {
        document.getElementById('disciplineCategory').value = 'strength';
    } else if (analysis.mood.toLowerCase().includes('calm') || analysis.mood.toLowerCase().includes('professional')) {
        document.getElementById('disciplineCategory').value = 'healthcare';
    } else {
        document.getElementById('disciplineCategory').value = 'general';
    }

    // Trigger discipline change to update injury dropdown
    document.getElementById('disciplineCategory').dispatchEvent(new Event('change'));

    // 4. Set Product based on variation
    const productMap = {
        0: 'Professional Series',     // Exact Match
        1: 'Professional Series',     // Inspired
        2: 'Elite Performance',        // Premium
        3: 'Professional Series'       // Branded
    };
    document.getElementById('specificProduct').value = productMap[variationIndex] || 'Professional Series';

    // 5. Set Product Color based on image analysis
    const dominantColors = analysis.colorPalette || [];
    let suggestedColor = 'na';

    // Check dominant colors and suggest tape color
    for (let color of dominantColors) {
        const colorLower = color.toLowerCase();
        if (colorLower.includes('0000ff') || colorLower.includes('blue')) {
            suggestedColor = 'blue';
            break;
        } else if (colorLower.includes('000000') || colorLower.includes('black')) {
            suggestedColor = 'black';
            break;
        } else if (colorLower.includes('ff') && colorLower.includes('00') && !colorLower.includes('0000')) {
            // Lime green or similar
            suggestedColor = 'lime-green';
            break;
        }
    }

    // For branded variation, always suggest lime green
    if (variationIndex === 3) {
        suggestedColor = 'lime-green';
    }

    document.getElementById('productColor').value = suggestedColor;

    // 6. Set Visual Style checkboxes based on analysis
    // Clear all checkboxes first
    document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => cb.checked = false);

    // Set styles based on analysis
    if (analysis.style.toLowerCase().includes('professional') || analysis.style.toLowerCase().includes('studio')) {
        const professionalCb = document.querySelector('input[value="professional-studio"]');
        if (professionalCb) professionalCb.checked = true;
    }

    if (analysis.style.toLowerCase().includes('natural') || analysis.brightness.level === 'Normal') {
        const naturalCb = document.querySelector('input[value="natural-lighting"]');
        if (naturalCb) naturalCb.checked = true;
    }

    if (analysis.style.toLowerCase().includes('clinical') || analysis.temperature.warmth === 'Cool') {
        const clinicalCb = document.querySelector('input[value="clinical-medical"]');
        if (clinicalCb) clinicalCb.checked = true;
    }

    if (analysis.style.toLowerCase().includes('dynamic') || analysis.style.toLowerCase().includes('action')) {
        const actionCb = document.querySelector('input[value="action-motion"]');
        if (actionCb) actionCb.checked = true;
    }

    // 7. Set Elements based on variation type
    if (variationIndex === 0 || variationIndex === 1) {
        // Exact/Inspired - show tape application
        const applyingCb = document.querySelector('input[value="applying-tape"]');
        if (applyingCb) applyingCb.checked = true;
    } else if (variationIndex === 2) {
        // Premium - show athlete in action
        const athleteCb = document.querySelector('input[value="male-athlete"]');
        const exerciseCb = document.querySelector('input[value="mid-exercise"]');
        if (athleteCb) athleteCb.checked = true;
        if (exerciseCb) exerciseCb.checked = true;
    } else if (variationIndex === 3) {
        // Branded - show product and branding
        const tapeCb = document.querySelector('input[value="tape-close-up"]');
        const packageCb = document.querySelector('input[value="package-visible"]');
        if (tapeCb) tapeCb.checked = true;
        if (packageCb) packageCb.checked = true;
    }

    // 8. Set Caption Style
    if (variationIndex === 2) {
        document.getElementById('captionStyle').value = 'motivational'; // Premium = motivational
    } else if (variationIndex === 3) {
        document.getElementById('captionStyle').value = 'educational'; // Branded = educational
    } else {
        document.getElementById('captionStyle').value = 'educational';
    }

    // 9. Set Content Category
    const categoryMap = {
        0: 'tutorial',           // Exact Match
        1: 'lifestyle',          // Inspired
        2: 'promotional',        // Premium
        3: 'product-showcase'    // Branded
    };
    document.getElementById('contentCategory').value = categoryMap[variationIndex] || 'product-showcase';

    console.log('‚úì All Stage 2 controls auto-populated based on analysis');
    console.log('AI Platform:', document.getElementById('aiPlatform').value);
    console.log('Format:', document.getElementById('platformFormat').value);
    console.log('Discipline:', document.getElementById('disciplineCategory').value);
    console.log('Product:', document.getElementById('specificProduct').value);
    console.log('Color:', document.getElementById('productColor').value);

    // Show informational banner to user
    showAutoPopulationBanner(variationIndex);
}

// Show banner explaining auto-populated selections
function showAutoPopulationBanner(variationIndex) {
    const variationNames = ['Exact Match', 'Inspired', 'Premium Elevated', 'TapeGeeks Branded'];
    const selectedVariation = variationNames[variationIndex];

    // Get auto-selected values
    const platform = document.getElementById('aiPlatform').value.toUpperCase();
    const format = document.getElementById('platformFormat').value;
    const discipline = document.getElementById('disciplineCategory').value;
    const product = document.getElementById('specificProduct').value;
    const color = document.getElementById('productColor').value;

    // Format display values
    const formatDisplay = format.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const disciplineDisplay = discipline.charAt(0).toUpperCase() + discipline.slice(1);
    const colorDisplay = color === 'na' ? 'Not specified' : color.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

    // Create banner HTML
    const banner = document.createElement('div');
    banner.id = 'autoPopulationBanner';
    banner.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        background: linear-gradient(135deg, #C5D52E, #9FAA1E);
        color: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(197, 213, 46, 0.6);
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        animation: slideInRight 0.4s ease-out;
    `;

    // Get the full summary text for copying
    const summaryText = `AUTO-SELECTED OPTIONS - ${selectedVariation}

AI Platform: ${platform}
Format: ${formatDisplay}
Discipline: ${disciplineDisplay}
Product: ${product}
Color: ${colorDisplay}

This variation has been combined with these auto-selected options based on your image analysis.
You can modify any selections in the left panel and regenerate if needed.`;

    const charCount = summaryText.length;

    banner.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">üéØ Auto-Selected Options</h3>
            <button onclick="document.getElementById('autoPopulationBanner').remove()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; color: #1a1a1a; opacity: 0.7; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">√ó</button>
        </div>

        <div style="background: rgba(0,0,0,0.08); border-radius: 8px; padding: 4px; margin-bottom: 15px;">
            <div style="font-size: 11px; font-weight: 600; color: rgba(26,26,26,0.7); padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                VARIATION: ${selectedVariation.toUpperCase()}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: rgba(0,0,0,0.1);">
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">AI PLATFORM</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${platform}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">FORMAT</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${formatDisplay}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">DISCIPLINE</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${disciplineDisplay}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">PRODUCT</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${product}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px; grid-column: 1 / -1;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">TAPE COLOR</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${colorDisplay}</div>
                </div>
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.15); border-left: 3px solid #1a1a1a; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; line-height: 1.6;">
            <strong>üìù What's Next:</strong><br>
            ‚Ä¢ Your prompt has been generated with these selections<br>
            ‚Ä¢ Scroll down to see the full AI prompt + 10 captions<br>
            ‚Ä¢ Want to change options? Modify left panel and regenerate
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <button onclick="copyAutoSelectionInfo()"
                    style="background: #1a1a1a; color: #C5D52E; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='#1a1a1a'">
                üìã Copy
            </button>
            <button onclick="exportAutoSelectionInfo()"
                    style="background: #1a1a1a; color: #C5D52E; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='#1a1a1a'">
                üíæ Export
            </button>
            <button onclick="document.getElementById('autoPopulationBanner').remove()"
                    style="background: #1a1a1a; color: #C5D52E; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='#1a1a1a'">
                ‚úì Got it
            </button>
        </div>

        <div style="text-align: center; font-size: 11px; color: rgba(26,26,26,0.6); font-weight: 600;">
            ${charCount} characters
        </div>
    `;

    // Store the summary text for copy/export functions
    banner.dataset.summaryText = summaryText;

    // Remove any existing banner
    const existing = document.getElementById('autoPopulationBanner');
    if (existing) existing.remove();

    // Add banner to page
    document.body.appendChild(banner);

    // Store the banner data globally so we can show it again
    window.autoPopulationData = {
        variationIndex: variationIndex,
        platform: platform,
        format: format,
        formatDisplay: formatDisplay,
        discipline: discipline,
        disciplineDisplay: disciplineDisplay,
        product: product,
        color: color,
        colorDisplay: colorDisplay,
        selectedVariation: selectedVariation
    };

    // Show the persistent info button
    showAutoPopulationButton();

    // Auto-remove after 15 seconds
    setTimeout(() => {
        if (document.getElementById('autoPopulationBanner')) {
            banner.style.animation = 'slideOutRight 0.4s ease-in';
            setTimeout(() => banner.remove(), 400);
        }
    }, 15000);
}

// Create persistent button to re-show auto-population info
function showAutoPopulationButton() {
    // Check if button already exists
    if (document.getElementById('showAutoInfoBtn')) return;

    const button = document.createElement('button');
    button.id = 'showAutoInfoBtn';
    button.innerHTML = 'üéØ View Auto-Selected Options';
    button.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #C5D52E, #9FAA1E);
        color: #1a1a1a;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(197, 213, 46, 0.5);
        z-index: 9999;
        transition: all 0.3s ease;
        animation: slideInUp 0.4s ease-out;
    `;

    button.onmouseover = () => {
        button.style.transform = 'translateY(-3px)';
        button.style.boxShadow = '0 6px 20px rgba(197, 213, 46, 0.7)';
    };

    button.onmouseout = () => {
        button.style.transform = 'translateY(0)';
        button.style.boxShadow = '0 4px 15px rgba(197, 213, 46, 0.5)';
    };

    button.onclick = () => {
        // Re-show the banner with stored data
        if (window.autoPopulationData) {
            reshowAutoPopulationBanner();
        }
    };

    document.body.appendChild(button);
}

// Re-show the auto-population banner with stored data
function reshowAutoPopulationBanner() {
    const data = window.autoPopulationData;
    if (!data) return;

    // Remove existing banner if present
    const existing = document.getElementById('autoPopulationBanner');
    if (existing) existing.remove();

    // Get the full summary text for copying
    const summaryText = `AUTO-SELECTED OPTIONS - ${data.selectedVariation}

AI Platform: ${data.platform}
Format: ${data.formatDisplay}
Discipline: ${data.disciplineDisplay}
Product: ${data.product}
Color: ${data.colorDisplay}

This variation has been combined with these auto-selected options based on your image analysis.
You can modify any selections in the left panel and regenerate if needed.`;

    const charCount = summaryText.length;

    // Create banner HTML
    const banner = document.createElement('div');
    banner.id = 'autoPopulationBanner';
    banner.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        background: linear-gradient(135deg, #C5D52E, #9FAA1E);
        color: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(197, 213, 46, 0.6);
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        animation: slideInRight 0.4s ease-out;
    `;

    banner.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">üéØ Auto-Selected Options</h3>
            <button onclick="document.getElementById('autoPopulationBanner').remove()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; color: #1a1a1a; opacity: 0.7; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">√ó</button>
        </div>

        <div style="background: rgba(0,0,0,0.08); border-radius: 8px; padding: 4px; margin-bottom: 15px;">
            <div style="font-size: 11px; font-weight: 600; color: rgba(26,26,26,0.7); padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                VARIATION: ${data.selectedVariation.toUpperCase()}
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: rgba(0,0,0,0.1);">
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">AI PLATFORM</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${data.platform}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">FORMAT</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${data.formatDisplay}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">DISCIPLINE</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${data.disciplineDisplay}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">PRODUCT</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${data.product}</div>
                </div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px 12px; grid-column: 1 / -1;">
                    <div style="font-size: 10px; font-weight: 600; color: rgba(26,26,26,0.6); margin-bottom: 4px;">TAPE COLOR</div>
                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${data.colorDisplay}</div>
                </div>
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.15); border-left: 3px solid #1a1a1a; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; line-height: 1.6;">
            <strong>üìù What's Next:</strong><br>
            ‚Ä¢ Your prompt has been generated with these selections<br>
            ‚Ä¢ Scroll down to see the full AI prompt + 10 captions<br>
            ‚Ä¢ Want to change options? Modify left panel and regenerate
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <button onclick="copyAutoSelectionInfo()"
                    style="background: #1a1a1a; color: #C5D52E; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='#1a1a1a'">
                üìã Copy
            </button>
            <button onclick="exportAutoSelectionInfo()"
                    style="background: #1a1a1a; color: #C5D52E; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='#1a1a1a'">
                üíæ Export
            </button>
            <button onclick="document.getElementById('autoPopulationBanner').remove()"
                    style="background: #1a1a1a; color: #C5D52E; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s;"
                    onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='#1a1a1a'">
                ‚úì Got it
            </button>
        </div>

        <div style="text-align: center; font-size: 11px; color: rgba(26,26,26,0.6); font-weight: 600;">
            ${charCount} characters
        </div>
    `;

    // Store the summary text for copy/export functions
    banner.dataset.summaryText = summaryText;

    // Add banner to page
    document.body.appendChild(banner);
}

// Copy auto-selection info to clipboard
function copyAutoSelectionInfo() {
    const banner = document.getElementById('autoPopulationBanner');
    if (!banner || !banner.dataset.summaryText) {
        alert('No auto-selection data available');
        return;
    }

    navigator.clipboard.writeText(banner.dataset.summaryText).then(() => {
        showNotification('‚úì Auto-selected options copied to clipboard!');
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed. Please try again.');
    });
}

// Export auto-selection info as text file
function exportAutoSelectionInfo() {
    const banner = document.getElementById('autoPopulationBanner');
    if (!banner || !banner.dataset.summaryText) {
        alert('No auto-selection data available');
        return;
    }

    const text = banner.dataset.summaryText;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tapegeeks-auto-selected-options.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotification('‚úì Auto-selected options exported as text file!');
}

function clearImageAnalysis() {
    if (confirm('Clear the uploaded image? The AI will generate generic product images instead.')) {
        currentImageData = null;
        currentAnalysis = null;
        generatedVariations = [];

        document.getElementById('imageAnalysisResults').classList.add('hidden');
        document.getElementById('imageFileInput').value = '';

        showNotification('Image cleared. Generator will create generic prompts.');
    }
}

// ============================================================================
// V2.0: API SETTINGS MANAGEMENT
// ============================================================================

const API_KEYS_STORAGE_KEY = 'tapegeeks_api_keys_v2';

// API Configuration
// CORS Proxy configuration - enables API calls from local HTML files
const CORS_PROXY = {
    enabled: true,
    // List of CORS proxy services (will try in order)
    proxies: [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url='
    ],
    currentProxy: 0
};

// Helper function to make CORS-proxied requests
async function corsProxiedFetch(url, options = {}) {
    if (!CORS_PROXY.enabled) {
        return fetch(url, options);
    }
    
    const proxyUrl = CORS_PROXY.proxies[CORS_PROXY.currentProxy] + encodeURIComponent(url);
    
    try {
        const response = await fetch(proxyUrl, {
            ...options,
            headers: {
                ...options.headers,
                'x-requested-with': 'XMLHttpRequest'
            }
        });
        return response;
    } catch (error) {
        // Try next proxy if available
        if (CORS_PROXY.currentProxy < CORS_PROXY.proxies.length - 1) {
            CORS_PROXY.currentProxy++;
            console.log(`Trying alternate CORS proxy: ${CORS_PROXY.proxies[CORS_PROXY.currentProxy]}`);
            return corsProxiedFetch(url, options);
        }
        throw error;
    }
}

const API_CONFIG = {
    nanoBanana: {
        name: 'Nano Banana Pro (Gemini)',
        endpoint: 'https://api.defapi.org/api/image/gen',
        model: 'google/imagen-3.0-generate-001',
        keyField: 'nanoBananaApiKey',
        statusField: 'nanoBananaStatus'
    },
    openai: {
        name: 'OpenAI DALL-E',
        endpoint: 'https://api.openai.com/v1/images/generations',
        model: 'dall-e-3',
        keyField: 'openaiApiKey',
        statusField: 'openaiStatus'
    },
    grok: {
        name: 'Grok (xAI)',
        endpoint: 'https://api.x.ai/v1/images/generations',
        model: 'grok-2-image',
        keyField: 'grokApiKey',
        statusField: 'grokStatus'
    },
    perplexity: {
        name: 'Perplexity AI',
        endpoint: 'https://api.perplexity.ai/images/generations',
        model: 'sonar-pro',
        keyField: 'perplexityApiKey',
        statusField: 'perplexityStatus'
    },
    // Free service with CORS enabled - no API key needed!
    pollinations: {
        name: 'Pollinations AI (Free)',
        endpoint: 'https://image.pollinations.ai/prompt/',
        model: 'flux',
        keyField: null, // No API key needed
        statusField: 'pollinationsStatus',
        noKeyRequired: true
    },
    // Hugging Face Inference API - Free tier with CORS support
    huggingface: {
        name: 'Hugging Face (Free)',
        endpoint: 'https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell',
        model: 'FLUX.1-schnell',
        keyField: 'huggingfaceApiKey',
        statusField: 'huggingfaceStatus',
        noKeyRequired: false // Optional: works with free HF token for higher limits
    }
};

// Load API keys from localStorage
function loadApiKeys() {
    try {
        const stored = localStorage.getItem(API_KEYS_STORAGE_KEY);
        if (stored) {
            const keys = JSON.parse(stored);
            
            // Populate input fields
            Object.keys(API_CONFIG).forEach(provider => {
                const config = API_CONFIG[provider];
                const input = document.getElementById(config.keyField);
                if (input && keys[provider]) {
                    input.value = keys[provider];
                    updateApiStatus(provider, true);
                }
            });
        }
    } catch (e) {
        console.error('Error loading API keys:', e);
    }
}

// Save API keys to localStorage
function saveApiSettings() {
    const keys = {};
    
    Object.keys(API_CONFIG).forEach(provider => {
        const config = API_CONFIG[provider];
        const input = document.getElementById(config.keyField);
        if (input && input.value.trim()) {
            keys[provider] = input.value.trim();
            updateApiStatus(provider, true);
        } else {
            updateApiStatus(provider, false);
        }
    });
    
    localStorage.setItem(API_KEYS_STORAGE_KEY, JSON.stringify(keys));
    showNotification('API settings saved successfully!');
    closeApiSettings();
}

// Update API status indicator
function updateApiStatus(provider, connected) {
    const config = API_CONFIG[provider];
    const statusEl = document.getElementById(config.statusField);
    if (statusEl) {
        if (connected) {
            statusEl.textContent = 'Connected';
            statusEl.className = 'api-status connected';
        } else {
            statusEl.textContent = 'Not Connected';
            statusEl.className = 'api-status disconnected';
        }
    }
}

// Get API key for a provider
function getApiKey(provider) {
    try {
        const stored = localStorage.getItem(API_KEYS_STORAGE_KEY);
        if (stored) {
            const keys = JSON.parse(stored);
            return keys[provider] || null;
        }
    } catch (e) {
        console.error('Error getting API key:', e);
    }
    return null;
}

// Open API settings modal
function openApiSettings() {
    loadApiKeys();
    document.getElementById('apiSettingsModal').classList.add('active');
}

// Close API settings modal
function closeApiSettings() {
    document.getElementById('apiSettingsModal').classList.remove('active');
}

// ============================================================================
// V2.0: IMAGE SERVICE - Multi-Provider API Integration
// ============================================================================

const ImageService = {
    // Generate image using the selected provider
    async generate(prompt, provider = 'huggingface') {
        // Free providers that don't require API keys
        const freeProviders = ['pollinations', 'huggingface'];
        
        // Handle free providers first
        if (provider === 'pollinations') {
            return await this.generateWithPollinations(prompt);
        }
        
        if (provider === 'huggingface') {
            // Hugging Face works without API key (with rate limits) or with one (faster)
            const apiKey = getApiKey(provider) || null;
            return await this.generateWithHuggingFace(prompt, apiKey);
        }
        
        // For paid providers, require API key
        const apiKey = getApiKey(provider);
        
        if (!apiKey) {
            throw new Error(`No API key configured for ${API_CONFIG[provider]?.name || provider}. Please configure it in API Settings.`);
        }
        
        switch (provider) {
            case 'nanoBanana':
                return await this.generateWithNanoBanana(prompt, apiKey);
            case 'openai':
                return await this.generateWithOpenAI(prompt, apiKey);
            case 'grok':
                return await this.generateWithGrok(prompt, apiKey);
            case 'perplexity':
                return await this.generateWithPerplexity(prompt, apiKey);
            default:
                throw new Error(`Unknown provider: ${provider}`);
        }
    },
    
    // Pollinations.ai - FREE, CORS-enabled, no API key needed!
    // NOTE: This free service works best with SHORT, SIMPLE prompts
    async generateWithPollinations(prompt) {
        // Pollinations uses a GET request with prompt in URL
        // CRITICAL: Keep prompt SHORT (under 150 chars) for reliable results
        
        // Extract key terms from the full prompt for a shorter version
        let shortPrompt = prompt
            .replace(/Professional Product Photography Brief for TapeGeeks:/gi, '')
            .replace(/SUBJECT:|PRODUCT DETAILS:|SCENE & ENVIRONMENT:|VISUAL STYLE|FORMAT & COMPOSITION:|E-COMMERCE OPTIMIZATION:|BRAND REQUIREMENTS|FINAL OUTPUT:/gi, '')
            .replace(/\n+/g, ' ')
            .replace(/[^\w\s,.-]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
        
        // If still too long, create a simpler prompt based on key words
        if (shortPrompt.length > 150) {
            // Try to extract key product info
            const hasAthlete = /athlet/i.test(prompt);
            const hasKinesiology = /kinesiology|tape/i.test(prompt);
            const hasBandage = /bandage/i.test(prompt);
            const hasStudio = /studio|professional/i.test(prompt);
            const color = prompt.match(/\b(black|blue|pink|red|green|purple|orange|beige)\b/i)?.[0] || '';
            
            // Build concise prompt (under 100 chars ideal)
            shortPrompt = 'professional product photo, ';
            if (hasAthlete) shortPrompt += 'athletic person, ';
            if (hasKinesiology || hasBandage) shortPrompt += 'sports tape roll, ';
            if (color) shortPrompt += color + ' color, ';
            shortPrompt += 'clean studio, commercial photography';
            shortPrompt = shortPrompt.substring(0, 150);
        }
        
        const encodedPrompt = encodeURIComponent(shortPrompt);
        const width = 1024;
        const height = 1024;
        const seed = Math.floor(Math.random() * 1000000);
        
        const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${width}&height=${height}&seed=${seed}&nologo=true`;
        
        console.log('Pollinations Short Prompt:', shortPrompt);
        console.log('Pollinations URL:', imageUrl);
        
        // Return a proper object (not just URL string)
        return {
            url: imageUrl,
            prompt: shortPrompt,
            provider: 'Pollinations AI (Free)',
            model: 'flux',
            timestamp: new Date().toISOString()
        };
    },
    
    // Hugging Face Inference API - Free with optional API token
    // Uses FLUX.1-schnell model which is fast and free
    // NOTE: HF API doesn't support CORS, so we use a proxy
    async generateWithHuggingFace(prompt, apiKey) {
        const config = API_CONFIG.huggingface;
        
        // Clean and shorten prompt for best results
        const cleanPrompt = prompt
            .replace(/[#*\[\]{}]/g, '') // Remove markdown
            .replace(/\n+/g, ' ')       // Single line
            .trim()
            .substring(0, 500);         // Limit length
        
        // CORS proxies to try (HF API doesn't support browser CORS)
        const corsProxies = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url='
        ];
        
        const requestBody = JSON.stringify({
            inputs: cleanPrompt,
            parameters: {
                width: 1024,
                height: 1024
            }
        });
        
        for (const proxy of corsProxies) {
            try {
                const targetUrl = proxy + encodeURIComponent(config.endpoint);
                
                console.log(`Calling Hugging Face via CORS proxy: ${proxy.substring(0, 30)}...`);
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Add authorization if API key provided (increases rate limits)
                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }
                
                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: headers,
                    body: requestBody
                });
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => '');
                    
                    // Check for model loading status
                    if (response.status === 503) {
                        throw new Error('Hugging Face model is loading. Please try again in 20-30 seconds.');
                    }
                    
                    if (response.status === 429) {
                        throw new Error('Hugging Face rate limit reached. Add an API token in Settings for higher limits, or try Pollinations AI.');
                    }
                    
                    console.log(`Proxy ${proxy} failed, trying next...`);
                    continue; // Try next proxy
                }
                
                // Response is a blob (image data)
                const blob = await response.blob();
                
                // Verify it's actually an image
                if (!blob.type.startsWith('image/')) {
                    console.log(`Got non-image response type: ${blob.type}`);
                    continue;
                }
                
                const imageUrl = URL.createObjectURL(blob);
                
                console.log('Hugging Face image generated successfully via CORS proxy');
                
                return imageUrl;
                
            } catch (error) {
                console.warn(`Hugging Face via ${proxy} failed:`, error.message);
                continue;
            }
        }
        
        // All proxies failed - fall back to Pollinations
        console.log('All CORS proxies failed. Falling back to Pollinations AI...');
        return await this.generateWithPollinations(prompt);
    },
    
    // Nano Banana Pro API - with CORS proxy support for browser compatibility
    async generateWithNanoBanana(prompt, apiKey) {
        const config = API_CONFIG.nanoBanana;
        
        // CORS Proxy options to try (in order of reliability)
        const corsProxies = [
            '', // Try direct first (works when running via local server with proper headers)
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url='
        ];
        
        let lastError = null;
        
        for (const proxy of corsProxies) {
            try {
                const targetUrl = proxy ? proxy + encodeURIComponent(config.endpoint) : config.endpoint;
                
                console.log(`Trying Nano Banana API${proxy ? ' via CORS proxy' : ' directly'}...`);
                
                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        prompt: prompt,
                        n: 1,
                        size: '1024x1024'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.message || errorData.error?.message || `HTTP ${response.status}`;
                    
                    // If it's a CORS error, try next proxy
                    if (response.status === 0 || errorMessage.includes('CORS') || errorMessage.includes('blocked')) {
                        console.log(`CORS blocked${proxy ? ' even with proxy' : ''}, trying next method...`);
                        lastError = new Error(`CORS blocked: ${errorMessage}`);
                        continue;
                    }
                    
                    // Provide helpful error for model issues
                    if (errorMessage.includes('not found') || errorMessage.includes('404')) {
                        throw new Error(`Gemini model error: ${errorMessage}. Try using Pollinations AI (free) or OpenAI DALL-E instead.`);
                    }
                    
                    throw new Error(`Nano Banana API error: ${errorMessage}`);
                }
                
                const data = await response.json();
                console.log('Nano Banana API response:', data);
                
                // Handle different response formats
                let imageUrl = null;
                if (data.data && data.data[0]) {
                    imageUrl = data.data[0].url || data.data[0].b64_json;
                } else if (data.url) {
                    imageUrl = data.url;
                } else if (data.image) {
                    imageUrl = data.image;
                } else if (data.images && data.images[0]) {
                    imageUrl = data.images[0].url || data.images[0];
                } else if (data.b64_json) {
                    imageUrl = `data:image/png;base64,${data.b64_json}`;
                }
                
                if (imageUrl) {
                    return imageUrl;
                }
                
                throw new Error('Unexpected response format from Nano Banana API');
                
            } catch (error) {
                console.warn(`Nano Banana attempt failed:`, error.message);
                lastError = error;
                
                // If it's a network/CORS error and we have more proxies to try, continue
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('CORS')) {
                    continue;
                }
                
                // For other errors, throw immediately
                throw error;
            }
        }
        
        // All methods failed - provide helpful guidance
        throw new Error(`Nano Banana Pro API is unavailable due to CORS restrictions. Please try:\n1. Pollinations AI (free, no API key needed)\n2. OpenAI DALL-E (requires API key)\n\nTechnical: ${lastError?.message || 'Unknown error'}`);
    },
    
    // OpenAI DALL-E API
    async generateWithOpenAI(prompt, apiKey) {
        const config = API_CONFIG.openai;
        
        const response = await fetch(config.endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: config.model,
                prompt: prompt,
                n: 1,
                size: '1024x1024',
                quality: 'hd'
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || `OpenAI API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.data[0].url || data.data[0].b64_json;
    },
    
    // Grok (xAI) API
    async generateWithGrok(prompt, apiKey) {
        const config = API_CONFIG.grok;
        
        const response = await fetch(config.endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: config.model,
                prompt: prompt,
                n: 1
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Grok API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.data?.[0]?.url || data.url || data.image;
    },
    
    // Perplexity AI API
    async generateWithPerplexity(prompt, apiKey) {
        const config = API_CONFIG.perplexity;
        
        const response = await fetch(config.endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: config.model,
                prompt: prompt
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Perplexity API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.data?.[0]?.url || data.url || data.image;
    }
};

// ============================================================================
// V2.0: IMAGE GALLERY MANAGEMENT
// ============================================================================

const GALLERY_STORAGE_KEY = 'tapegeeks_image_gallery_v2';
let imageGallery = [];
let currentLightboxImage = null;

// Initialize gallery from localStorage
function initGallery() {
    try {
        const stored = localStorage.getItem(GALLERY_STORAGE_KEY);
        if (stored) {
            imageGallery = JSON.parse(stored);
        }
    } catch (e) {
        console.error('Error loading gallery:', e);
        imageGallery = [];
    }
}

// Save gallery to localStorage
function saveGallery() {
    try {
        // Limit gallery size to prevent localStorage overflow (keep last 20 images)
        if (imageGallery.length > 20) {
            imageGallery = imageGallery.slice(-20);
        }
        localStorage.setItem(GALLERY_STORAGE_KEY, JSON.stringify(imageGallery));
    } catch (e) {
        console.error('Error saving gallery:', e);
        // If localStorage is full, try removing old entries
        if (imageGallery.length > 5) {
            imageGallery = imageGallery.slice(-5);
            try {
                localStorage.setItem(GALLERY_STORAGE_KEY, JSON.stringify(imageGallery));
            } catch (e2) {
                console.error('Still cannot save gallery:', e2);
            }
        }
    }
}

// Add image to gallery
function addToGallery(imageData) {
    const entry = {
        id: Date.now(),
        image: imageData.url || imageData.base64,
        isUrl: !!imageData.url,
        prompt: imageData.prompt,
        provider: imageData.provider,
        model: imageData.model,
        timestamp: new Date().toISOString(),
        platform: document.getElementById('aiPlatform').value,
        format: document.getElementById('platformFormat').value
    };
    
    imageGallery.push(entry);
    saveGallery();
    renderGallery();
    
    return entry;
}

// Render gallery in the output area
function renderGallery() {
    const galleryContainer = document.getElementById('imageGallery');
    const galleryArea = document.getElementById('imageGalleryArea');
    
    if (!galleryContainer) return;
    
    if (imageGallery.length === 0) {
        // Hide gallery area when empty
        if (galleryArea) galleryArea.style.display = 'none';
        galleryContainer.innerHTML = '';
        return;
    }
    
    // Show gallery area
    if (galleryArea) galleryArea.style.display = 'block';
    
    // Reverse to show newest first
    const sortedGallery = [...imageGallery].reverse();
    
    galleryContainer.innerHTML = sortedGallery.map(item => `
        <div class="gallery-item" onclick="viewImage('${item.id}')">
            <img src="${item.image}" alt="Generated image" loading="lazy">
            <div class="gallery-item-overlay">
                <span class="gallery-item-time">${formatTimestamp(item.timestamp)}</span>
            </div>
        </div>
    `).join('');
}

// Format timestamp for display
function formatTimestamp(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// View image in lightbox
function viewImage(imageId) {
    const item = imageGallery.find(i => i.id == imageId);
    if (!item) return;
    
    currentLightboxImage = item;
    document.getElementById('lightboxImage').src = item.image;
    document.getElementById('lightboxOverlay').classList.add('active');
}

// Close lightbox
function closeLightbox(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('lightboxOverlay').classList.remove('active');
    currentLightboxImage = null;
}

// Download gallery image
function downloadGalleryImage(imageId) {
    const item = imageGallery.find(i => i.id == imageId);
    if (!item) return;
    
    downloadImage(item.image, `tapegeeks-gen-${item.id}.png`);
}

// Delete gallery image
function deleteGalleryImage(imageId) {
    if (!confirm('Delete this image from gallery?')) return;
    
    imageGallery = imageGallery.filter(i => i.id != imageId);
    saveGallery();
    renderGallery();
    showNotification('Image deleted from gallery');
}

// Clear entire gallery
function clearGallery() {
    if (!confirm('Clear all images from gallery? This cannot be undone.')) return;
    
    imageGallery = [];
    saveGallery();
    renderGallery();
    showNotification('Gallery cleared');
}

// ============================================================================
// V2.0: IMAGE GENERATION WORKFLOW
// ============================================================================

let lastGeneratedImage = null;

// Main image generation function
async function generateImage() {
    // Show the image generation area
    const imageArea = document.getElementById('generatedImageArea');
    if (imageArea) {
        imageArea.style.display = 'block';
    }
    
    // Update status
    updateImageStatus('generating', 'Preparing...');
    
    // Get the current prompt
    const promptElement = document.getElementById('promptOutput');
    let prompt = promptElement ? promptElement.innerText : '';
    
    if (!prompt || prompt.trim() === '') {
        // Generate prompt first if not available
        generatePromptOnly();
        prompt = document.getElementById('promptOutput')?.innerText || '';
        
        if (!prompt || prompt.trim() === '') {
            updateImageStatus('error', 'No Prompt');
            showNotification('Please generate a prompt first or select options');
            return;
        }
    }
    
    // Determine provider based on selected platform
    const platform = document.getElementById('aiPlatform').value;
    const providerMap = {
        'pollinations': 'pollinations',
        'huggingface': 'huggingface',
        'gemini': 'nanoBanana',
        'chatgpt': 'openai',
        'grok': 'grok',
        'perplexity': 'perplexity'
    };
    
    const provider = providerMap[platform] || 'huggingface'; // Default to Hugging Face (free & reliable)
    
    // Free services that don't require API keys
    const freeProviders = ['pollinations', 'huggingface'];
    
    // Check if API key is needed
    if (!freeProviders.includes(provider)) {
        // Check if API key is configured
        const apiKey = getApiKey(provider);
        if (!apiKey) {
            updateImageStatus('error', 'No API Key');
            showNotification(`Please configure ${API_CONFIG[provider]?.name || provider} API key in Settings`);
            openApiSettings();
            return;
        }
    }
    
    // Update status to generating
    updateImageStatus('generating', `Generating with ${API_CONFIG[provider]?.name || provider}...`);
    
    // Show loading overlay
    showLoading(`Generating image with ${API_CONFIG[provider]?.name || provider}...`);
    
    try {
        // Call the API - returns either an object {url, prompt, provider, ...} or just a URL string
        const result = await ImageService.generate(prompt, provider);
        
        // Hide loading
        hideLoading();
        
        // Update status
        updateImageStatus('success', 'Complete');
        
        // Handle both object and string returns
        const imageUrl = (typeof result === 'object') ? result.url : result;
        
        // Store the generated image
        lastGeneratedImage = {
            url: imageUrl,
            prompt: (typeof result === 'object') ? result.prompt : prompt,
            provider: (typeof result === 'object') ? result.provider : API_CONFIG[provider]?.name || provider,
            model: (typeof result === 'object') ? result.model : API_CONFIG[provider]?.model || 'unknown',
            timestamp: (typeof result === 'object') ? result.timestamp : new Date().toISOString()
        };
        
        // Add to gallery
        const galleryEntry = addToGallery(lastGeneratedImage);
        
        // Display the generated image
        displayGeneratedImage(lastGeneratedImage);
        
        showNotification('Image generated successfully!');
        
    } catch (error) {
        hideLoading();
        console.error('Image generation error:', error);
        
        // Check for CORS error
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('CORS')) {
            updateImageStatus('error', 'CORS Error');
            showCORSErrorHelp(provider);
        } else {
            updateImageStatus('error', 'Failed');
            showNotification(`Error: ${error.message}`);
        }
    }
}

// Show helpful message for CORS errors
function showCORSErrorHelp(provider) {
    const providerName = API_CONFIG[provider]?.name || provider;
    const helpMessage = `
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 20px; margin: 15px 0;">
            <h4 style="color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è Browser Security Restriction (CORS)</h4>
            <p style="color: #e5e7eb; margin-bottom: 15px;">Direct API calls from local HTML files are blocked by browser security policies.</p>
            <h5 style="color: #C5D52E; margin-bottom: 8px;">Solutions:</h5>
            <ol style="color: #9ca3af; padding-left: 20px; margin-bottom: 15px;">
                <li><strong>Use the Copy Prompt button</strong> and paste it directly into ${providerName}</li>
                <li><strong>Run a local server:</strong> <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">python -m http.server 8888</code></li>
                <li><strong>Deploy to a web server</strong> (Vercel, Netlify, GitHub Pages)</li>
                <li><strong>Use a browser extension</strong> like "CORS Unblock" (for testing only)</li>
            </ol>
            <button onclick="copyPromptToClipboard()" class="image-action-btn primary" style="margin-top: 10px;">
                üìã Copy Prompt to Use in ${providerName}
            </button>
        </div>
    `;
    
    const errorContainer = document.getElementById('imageContainer');
    if (errorContainer) {
        errorContainer.innerHTML = helpMessage;
    }
}

// Update the image status indicator
function updateImageStatus(status, text) {
    const statusEl = document.getElementById('imageStatus');
    if (statusEl) {
        statusEl.className = 'image-status ' + status;
        statusEl.textContent = text;
    }
}

// Display generated image in the static image area
function displayGeneratedImage(imageData) {
    // Show the image display area
    const imageArea = document.getElementById('generatedImageArea');
    if (imageArea) {
        imageArea.style.display = 'block';
    }
    
    // Hide placeholder, show image
    const placeholder = document.getElementById('imagePlaceholder');
    const imageDisplay = document.getElementById('generatedImageDisplay');
    const imageContainer = document.getElementById('imageContainer');
    
    if (placeholder) placeholder.style.display = 'none';
    
    if (imageDisplay) {
        // Set status to loading while image loads
        updateImageStatus('generating', 'Loading image...');
        
        // Handle successful load
        imageDisplay.onload = function() {
            updateImageStatus('success', 'Complete');
            showNotification('Image loaded successfully!');
        };
        
        // Handle load error (e.g., Pollinations server overloaded)
        imageDisplay.onerror = function() {
            updateImageStatus('error', 'Load Failed');
            const urlToShow = imageData.url.length > 80 ? imageData.url.substring(0, 80) + '...' : imageData.url;
            showNotification(`Image failed to load (server may be busy). Try clicking "Regenerate" or open URL directly: ${urlToShow}`, 'warning');
            // Keep the image element visible so user can right-click and open in new tab
            console.log('Image failed to load. Full URL:', imageData.url);
            console.log('Try opening this URL in a new tab, or try again in a moment.');
        };
        
        imageDisplay.src = imageData.url;
        imageDisplay.style.display = 'block';
    }
    
    // Show image actions
    const imageActions = document.getElementById('imageActions');
    if (imageActions) imageActions.style.display = 'flex';
    
    // Show and update metadata
    const imageMetadata = document.getElementById('imageMetadata');
    if (imageMetadata) {
        imageMetadata.style.display = 'flex';
        document.getElementById('metaProvider').textContent = API_CONFIG[imageData.provider]?.name || imageData.provider;
        document.getElementById('metaModel').textContent = imageData.model;
        document.getElementById('metaTime').textContent = formatTimestamp(imageData.timestamp);
    }
    
    // Show and update gallery
    const galleryArea = document.getElementById('imageGalleryArea');
    if (galleryArea && imageGallery.length > 0) {
        galleryArea.style.display = 'block';
        renderGallery();
    }
    
    // Scroll to show the image
    imageArea?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Reset the image display area
function resetImageDisplay() {
    const placeholder = document.getElementById('imagePlaceholder');
    const imageDisplay = document.getElementById('generatedImageDisplay');
    const imageActions = document.getElementById('imageActions');
    const imageMetadata = document.getElementById('imageMetadata');
    
    if (placeholder) placeholder.style.display = 'block';
    if (imageDisplay) {
        imageDisplay.style.display = 'none';
        imageDisplay.src = '';
    }
    if (imageActions) imageActions.style.display = 'none';
    if (imageMetadata) imageMetadata.style.display = 'none';
    
    updateImageStatus('ready', 'Ready');
}

// Demo Mode - Test image display without API key
function runDemoMode() {
    showNotification('üß™ Loading demo image to test display...', 'info');
    
    // Show the image display area
    const imageArea = document.getElementById('generatedImageArea');
    if (imageArea) {
        imageArea.style.display = 'block';
    }
    
    // Update status to generating
    updateImageStatus('generating', 'Loading Demo...');
    
    // Use a high-quality sample image (Unsplash - free to use)
    const demoImageUrl = 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=1024&q=80';
    
    // Simulate loading
    setTimeout(() => {
        // Display the demo image
        displayGeneratedImage({
            url: demoImageUrl,
            prompt: 'DEMO IMAGE: This is a sample image to test the display functionality. When you configure your API key and generate a real image, it will appear here with all the same features - download, copy URL, regenerate, etc.',
            provider: 'Demo Mode',
            model: 'Sample Image',
            timestamp: new Date().toISOString()
        });
        
        // Update status to Demo
        updateImageStatus('demo', 'üß™ Demo');
        
        showNotification('‚úÖ Demo image loaded! This shows how generated images will display. Configure an API key in Settings to generate real images.', 'success');
    }, 1500);
}

// Copy image URL to clipboard
function copyImageUrl() {
    if (lastGeneratedImage && lastGeneratedImage.url) {
        navigator.clipboard.writeText(lastGeneratedImage.url)
            .then(() => showNotification('Image URL copied to clipboard!'))
            .catch(() => showNotification('Failed to copy URL'));
    } else {
        showNotification('No image URL to copy');
    }
}

// Open image in new tab
function openImageInNewTab() {
    if (lastGeneratedImage && lastGeneratedImage.url) {
        window.open(lastGeneratedImage.url, '_blank');
    } else {
        showNotification('No image to view');
    }
}

// Clear gallery
function clearGallery() {
    imageGallery = [];
    localStorage.removeItem('tapegeeks_image_gallery');
    
    const galleryArea = document.getElementById('imageGalleryArea');
    if (galleryArea) galleryArea.style.display = 'none';
    
    const galleryContainer = document.getElementById('imageGallery');
    if (galleryContainer) galleryContainer.innerHTML = '';
    
    showNotification('Gallery cleared');
}

// Download current generated image
function downloadCurrentImage() {
    if (currentLightboxImage) {
        downloadImage(currentLightboxImage.image, `tapegeeks-gen-${currentLightboxImage.id}.png`);
    } else if (lastGeneratedImage) {
        downloadImage(lastGeneratedImage.url, `tapegeeks-gen-${Date.now()}.png`);
    } else {
        showNotification('No image to download');
    }
}

// Download image helper
function downloadImage(imageUrl, filename) {
    // For URLs, we need to fetch and convert to blob
    if (imageUrl.startsWith('http')) {
        fetch(imageUrl)
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Image downloaded!');
            })
            .catch(err => {
                // Fallback: open in new tab
                window.open(imageUrl, '_blank');
                showNotification('Image opened in new tab (download blocked by CORS)');
            });
    } else if (imageUrl.startsWith('data:')) {
        // Base64 image
        const a = document.createElement('a');
        a.href = imageUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showNotification('Image downloaded!');
    } else {
        window.open(imageUrl, '_blank');
    }
}

// Copy image to clipboard
async function copyImageToClipboard() {
    const imageUrl = currentLightboxImage?.image || lastGeneratedImage?.url;
    if (!imageUrl) {
        showNotification('No image to copy');
        return;
    }
    
    try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        await navigator.clipboard.write([
            new ClipboardItem({ [blob.type]: blob })
        ]);
        showNotification('Image copied to clipboard!');
    } catch (err) {
        console.error('Copy failed:', err);
        showNotification('Could not copy image (browser restriction)');
    }
}

// View current image in lightbox
function viewCurrentImage() {
    if (lastGeneratedImage) {
        currentLightboxImage = {
            id: Date.now(),
            image: lastGeneratedImage.url
        };
        document.getElementById('lightboxImage').src = lastGeneratedImage.url;
        document.getElementById('lightboxOverlay').classList.add('active');
    }
}

// Regenerate image with same prompt
function regenerateImage() {
    generateImage();
}

// ============================================================================
// V2.0: LOADING OVERLAY
// ============================================================================

function showLoading(message = 'Generating Image...', subtext = 'This may take 10-30 seconds') {
    document.getElementById('loadingText').textContent = message;
    document.getElementById('loadingSubtext').textContent = subtext;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// ============================================================================
// V2.0: INITIALIZATION
// ============================================================================

// Initialize v2.0 features on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load API keys
    loadApiKeys();
    
    // Initialize gallery
    initGallery();
    
    // Initialize E-commerce Platform (Amazon/Shopify/Social)
    initEcommercePlatform();
    
    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeApiSettings();
            closeLightbox();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('apiSettingsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeApiSettings();
        }
    });
    
    console.log('TapeGeeks Image Prompt Generator v2.0 initialized with E-commerce Platform support');
});
</script>

</body>
</html>

